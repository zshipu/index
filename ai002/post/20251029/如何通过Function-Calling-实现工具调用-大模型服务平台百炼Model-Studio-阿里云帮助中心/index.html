<!doctype html>
<html lang="zh-CN">
<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>如何通过Function Calling 实现工具调用-大模型服务平台百炼(Model Studio)-阿里云帮助中心 --知识铺 | 知识铺的博客</title>
    <meta property="og:title" content="如何通过Function Calling 实现工具调用-大模型服务平台百炼(Model Studio)-阿里云帮助中心 --知识铺 - 知识铺的博客">
    <meta property="og:type" content="article">
    
    <meta property="article:published_time" content='2025-10-29T01:54:37&#43;08:00'>
    
    
    <meta property="article:modified_time" content='2025-10-29T01:54:37&#43;08:00'>
    
    <meta name="Keywords" content="golang,go语言,go语言笔记,知识铺,java,android,博客,项目管理,python,软件架构,公众号,小程序">
    <meta name="description" content="如何通过Function Calling 实现工具调用-大模型服务平台百炼(Model Studio)-阿里云帮助中心 --知识铺">
    
    <meta name="author" content="知识铺">
    <meta property="og:url" content="https://index.zshipu.com/ai002/post/20251029/%E5%A6%82%E4%BD%95%E9%80%9A%E8%BF%87Function-Calling-%E5%AE%9E%E7%8E%B0%E5%B7%A5%E5%85%B7%E8%B0%83%E7%94%A8-%E5%A4%A7%E6%A8%A1%E5%9E%8B%E6%9C%8D%E5%8A%A1%E5%B9%B3%E5%8F%B0%E7%99%BE%E7%82%BCModel-Studio-%E9%98%BF%E9%87%8C%E4%BA%91%E5%B8%AE%E5%8A%A9%E4%B8%AD%E5%BF%83/">
    <link rel="shortcut icon" href='/ai002/favicon.ico' type="image/x-icon">

    <link rel="stylesheet" href='/ai002/css/normalize.css'>
    <link rel="stylesheet" href='/ai002/css/style.css'>
    <script type="text/javascript" src="//cdn.bootcdn.net/ajax/libs/jquery/3.4.1/jquery.min.js"></script>

    
    <script data-ad-client="ca-pub-2874221941555456" async
        src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    

    

    
    
    
    <script>(function (w, d, s, l, i) {
            w[l] = w[l] || []; w[l].push({
                'gtm.start':
                    new Date().getTime(), event: 'gtm.js'
            }); var f = d.getElementsByTagName(s)[0],
                j = d.createElement(s), dl = l != 'dataLayer' ? '&l=' + l : ''; j.async = true; j.src =
                    'https://www.googletagmanager.com/gtm.js?id=' + i + dl; f.parentNode.insertBefore(j, f);
        })(window, document, 'script', 'dataLayer', 'GTM-WLWJSST');</script>
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-BY5XJ2PJ93"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());

        gtag('config', 'G-BY5XJ2PJ93');
    </script>
    
</head>

<body>

<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-WLWJSST"
height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>

    <header id="header" class="clearfix">
    <div class="container">
        <div class="col-group">
            <div class="site-name ">
                
                    <a id="logo" href="https://index.zshipu.com/ai002/">
                        知识铺的博客
                    </a>
                
                <p class="description">专注于Android、Java、Go语言(golang)、移动互联网、项目管理、软件架构</p>
            </div>
            <div>
                <nav id="nav-menu" class="clearfix">
                    <a class="current" href="https://index.zshipu.com/ai002/">首页</a>
                    
                    <a  href="https://index.zshipu.com/ai001/" title="AI技术">AI技术</a>
                    
                    <a  href="https://index.zshipu.com" title="总站">总站</a>
                    
                    <a  href="https://index.zshipu.com/ai002/archives/" title="归档">归档</a>
                    
                    <a  href="https://index.zshipu.com/ai002/about/" title="关于">关于</a>
                    
                </nav>
            </div>
        </div>
    </div>
</header>

    <div id="body">
        <div class="container">
            <div class="col-group">

                <div class="col-8" id="main">
                    
<div class="res-cons">
    <style type="text/css">
    .post-toc {
        position: fixed;
        width: 200px;
        margin-left: -210px;
        padding: 5px 10px;
        font-family: Athelas, STHeiti, Microsoft Yahei, serif;
        font-size: 12px;
        border: 1px solid rgba(0, 0, 0, .07);
        border-radius: 5px;
        background-color: rgba(255, 255, 255, 0.98);
        background-clip: padding-box;
        -webkit-box-shadow: 1px 1px 2px rgba(0, 0, 0, .125);
        box-shadow: 1px 1px 2px rgba(0, 0, 0, .125);
        word-wrap: break-word;
        white-space: nowrap;
        -webkit-box-sizing: border-box;
        box-sizing: border-box;
        z-index: 999;
        cursor: pointer;
        max-height: 70%;
        overflow-y: auto;
        overflow-x: hidden;
    }

    .post-toc .post-toc-title {
        width: 100%;
        margin: 0 auto;
        font-size: 20px;
        font-weight: 400;
        text-transform: uppercase;
        text-align: center;
    }

    .post-toc .post-toc-content {
        font-size: 15px;
    }

    .post-toc .post-toc-content>nav>ul {
        margin: 10px 0;
    }

    .post-toc .post-toc-content ul {
        padding-left: 20px;
        list-style: square;
        margin: 0.5em;
        line-height: 1.8em;
    }

    .post-toc .post-toc-content ul ul {
        padding-left: 15px;
        display: none;
    }

    @media print,
    screen and (max-width:1057px) {
        .post-toc {
            display: none;
        }
    }
</style>
<div class="post-toc" style="position: absolute; top: 188px;">
    <h2 class="post-toc-title">文章目录</h2>
    <div class="post-toc-content">
        <nav id="TableOfContents">
  <ul>
    <li><a href="#工作原理"><strong>工作原理</strong></a></li>
    <li><a href="#支持的模型"><strong>支持的模型</strong></a></li>
    <li><a href="#快速开始"><strong>快速开始</strong></a></li>
    <li><a href="#如何使用"><strong>如何使用</strong></a>
      <ul>
        <li><a href="#1-定义工具"><strong>1. 定义工具</strong></a></li>
        <li><a href="#4-运行工具函数"><strong>4. 运行工具函数</strong></a></li>
        <li><a href="#5-大模型总结工具函数输出"><strong>5. 大模型总结工具函数输出</strong></a></li>
      </ul>
    </li>
    <li><a href="#进阶用法"><strong>进阶用法</strong></a>
      <ul>
        <li><a href="#指定工具调用方式"><strong>指定工具调用方式</strong></a></li>
        <li><a href="#多轮对话"><strong>多轮对话</strong></a></li>
        <li><a href="#流式输出"><strong>流式输出</strong></a></li>
        <li><a href="#深度思考模型的工具调用"><strong>深度思考模型的工具调用</strong></a></li>
        <li><a href="#示例代码"><strong>示例代码</strong></a></li>
        <li><a href="#返回结果"><strong>返回结果</strong></a></li>
      </ul>
    </li>
    <li><a href="#应用于生产环境"><strong>应用于生产环境</strong></a>
      <ul>
        <li><a href="#测试工具调用准确率"><strong>测试工具调用准确率</strong></a></li>
        <li><a href="#动态控制工具数量"><strong>动态控制工具数量</strong></a></li>
        <li><a href="#工具安全性原则"><strong>工具安全性原则</strong></a></li>
        <li><a href="#用户体验优化"><strong>用户体验优化</strong></a></li>
      </ul>
    </li>
    <li><a href="#计费说明"><strong>计费说明</strong></a></li>
    <li><a href="#通过-system-message-传入工具信息"><strong>通过 System Message 传入工具信息</strong></a></li>
    <li><a href="#错误码">错误码</a></li>
  </ul>
</nav>
    </div>
</div>
<script type="text/javascript">
    $(document).ready(function () {
        var postToc = $(".post-toc");
        if (postToc.length) {
            var leftPos = $("#main").offset().left;
            if(leftPos<220){
                postToc.css({"width":leftPos-10,"margin-left":(0-leftPos)})
            }

            var t = postToc.offset().top - 20,
                a = {
                    start: {
                        position: "absolute",
                        top: t
                    },
                    process: {
                        position: "fixed",
                        top: 20
                    },
                };
            $(window).scroll(function () {
                var e = $(window).scrollTop();
                e < t ? postToc.css(a.start) : postToc.css(a.process)
            })
        }
    })
</script>
    <article class="post">
        <header>
            <h1 class="post-title">如何通过Function Calling 实现工具调用-大模型服务平台百炼(Model Studio)-阿里云帮助中心 --知识铺</h1>
        </header>
        <date class="post-meta meta-date">
            2025年10月29日
        </date>
        
        
        <div class="post-meta">
            <span id="busuanzi_container_page_pv">|<span id="busuanzi_value_page_pv"></span><span>
                    阅读</span></span>
        </div>
        
        
        <div class="post-content">
            <h2 id="工作原理"><strong>工作原理</strong></h2>
<p>Function Calling 通过在应用程序和大模型之间的多步骤交互，使大模型可以参考外部工具信息进行回答。</p>
<ol>
<li>
<p><strong>发起第一次模型调用</strong></p>
<p>应用程序首先向大模型发起一个包含用户问题与模型可调用工具清单的请求。</p>
</li>
<li>
<p><strong>接收模型的工具调用指令（工具名称与入参）</strong></p>
<p>若模型判断需要调用外部工具，会返回一个JSON格式的指令，用于告知应用程序需要执行的函数与入参。</p>
<blockquote>
<p>若模型判断无需调用工具，会返回自然语言格式的回复。</p>
</blockquote>
</li>
<li>
<p><strong>在应用端运行工具</strong></p>
<p>应用程序接收到工具指令后，需要运行工具，获得工具输出结果。</p>
</li>
<li>
<p><strong>发起第二次模型调用</strong></p>
<p>获取到工具输出结果后，需添加至模型的上下文（messages），再次发起模型调用。</p>
</li>
<li>
<p><strong>接收来自模型的最终响应</strong></p>
<p>模型将工具输出结果和用户问题信息整合，生成自然语言格式的回复。</p>
</li>
</ol>
<p>工作流程示意图如下所示：</p>
<p>
        <img class="mx-auto" alt="image" src="https://api.995120.cn/ecgdata/other/2025-11-01/4762720251101173445eA6WyYrG.svg" />   
    </p>
<h2 id="支持的模型"><strong>支持的模型</strong></h2>
<ul>
<li>
<p><strong>文本生成模型</strong></p>
<ul>
<li>
<p><a href="https://help.aliyun.com/zh/model-studio/models#d4ccf72f23jh9">通义千问Max</a></p>
</li>
<li>
<p><a href="https://help.aliyun.com/zh/model-studio/models#bb0ffee88bwnk">通义千问Plus</a></p>
</li>
<li>
<p><a href="https://help.aliyun.com/zh/model-studio/models#d617df95f1g9h">通义千问Flash</a></p>
</li>
<li>
<p><a href="https://help.aliyun.com/zh/model-studio/models#d698550551bob">通义千问Coder</a></p>
</li>
<li>
<p><a href="https://help.aliyun.com/zh/model-studio/models#ff492e2c10lub">通义千问Turbo</a></p>
</li>
<li>
<p><a href="https://help.aliyun.com/zh/model-studio/models#9d516d17965af">Qwen3</a></p>
</li>
<li>
<p><a href="https://help.aliyun.com/zh/model-studio/models#e4831f1e9388j">Qwen2.5</a></p>
</li>
<li>
<p><a href="https://help.aliyun.com/zh/model-studio/models#5d2908c05460t">Qwen2</a></p>
</li>
<li>
<p><a href="https://help.aliyun.com/zh/model-studio/models#6440fb9f9813i">Qwen1.5</a></p>
</li>
</ul>
</li>
<li>
<p><strong>多模态模型</strong></p>
<ul>
<li>
<p><a href="https://help.aliyun.com/zh/model-studio/models#18da4b21522xf">通义千问VL</a>（仅包括 qwen3-vl-plus、 qwen3-vl-flash系列）</p>
</li>
<li>
<p><a href="https://help.aliyun.com/zh/model-studio/models#a7a9da8f6em1a">Qwen3-VL</a></p>
</li>
</ul>
</li>
</ul>
<h2 id="快速开始"><strong>快速开始</strong></h2>
<p>您需要已<a href="https://help.aliyun.com/zh/model-studio/get-api-key">获取API Key</a>并<a href="https://help.aliyun.com/zh/model-studio/configure-api-key-through-environment-variables">配置API Key到环境变量</a>。如果通过 OpenAI SDK 或 DashScope SDK 进行调用，需要<a href="https://help.aliyun.com/zh/model-studio/install-sdk#210ee28162bs7">安装SDK</a>。</p>
<p>以天气查询场景为例，介绍快速使用 Function Calling 的方法。</p>
<p>运行后得到如下输出：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>正在调用工具 <span style="color:#000;font-weight:bold">[</span>get_current_weather<span style="color:#000;font-weight:bold">]</span>，参数：<span style="color:#000;font-weight:bold">{</span><span style="color:#d14">&#39;location&#39;</span>: <span style="color:#d14">&#39;北京&#39;</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>工具返回：北京今天是多云。
</span></span><span style="display:flex;"><span>助手最终回复：北京今天是多云的天气。
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="如何使用"><strong>如何使用</strong></h2>
<p>Function Calling 支持两种传入工具信息的方式：</p>
<ul>
<li>
<p>方式一：通过 tools 参数传入（推荐）</p>
<p>请参见<a href="https://help.aliyun.com/zh/model-studio/qwen-function-calling#038e24005c1vt">如何使用</a>，按照<strong>定义工具</strong>、<strong>创建messages数组</strong>、<strong>发起 Function Calling</strong>、<strong>运行工具函数</strong>、<strong>大模型总结工具函数输出</strong>的步骤进行调用。</p>
</li>
<li>
<p>方式二：通过 System Message 传入</p>
<p>通过 tools 参数传入时，服务端会根据模型自动适配合适的 prompt 模板并组装，因此推荐您优先使用 tools 参数。 如果您在使用 Qwen 模型时不期望使用 tools 参数，请参见<a href="https://help.aliyun.com/zh/model-studio/qwen-function-calling#afa52dfc56tqq">通过 System Message 传入工具信息</a>。</p>
</li>
</ul>
<p>以下内容以 OpenAI 兼容调用方式为例，通过 tools 参数传入工具信息，向您分步骤介绍 Function Calling 的详细用法。</p>
<p>假设业务场景中会收到天气查询与时间查询两类问题。</p>
<h3 id="1-定义工具"><strong>1. 定义工具</strong></h3>
<p>工具是连接大模型与外部世界的桥梁，首先需要定义工具。</p>
<h4 id="11-创建工具函数"><strong>1.1. 创建工具函数</strong></h4>
<p>创建两个工具函数：天气查询工具与时间查询工具。</p>
<ul>
<li>
<p><strong>天气查询工具</strong></p>
<p>接收<code>arguments</code>参数，<code>arguments</code>格式为<code>{&quot;location&quot;: &quot;查询的地点&quot;}</code>。工具的输出为字符串，格式为：<code>“{位置}今天是{天气}”</code>。</p>
<blockquote>
<p>为了便于演示，此处定义的天气查询工具并不真正查询天气，会从晴天、多云、雨天随机选择。在实际业务中可使用如<a href="https://lbs.amap.com/api/webservice/guide/api/weatherinfo">高德天气查询</a>等工具进行替换。</p>
</blockquote>
</li>
<li>
<p><strong>时间查询工具</strong></p>
<p>时间查询工具不需要输入参数。工具的输出为字符串，格式为：<code>“当前时间：{查询到的时间}。”</code>。</p>
<blockquote>
<p>如果使用 Node.js，请运行<code>npm install date-fns</code>安装获取时间的工具包 date-fns：</p>
</blockquote>
</li>
</ul>
<p>运行工具后，得到输出：</p>
<pre tabindex="0"><code>测试工具输出：
上海今天是多云。
当前时间：2025-01-08 20:21:45。
</code></pre><h4 id="12-创建-tools-数组"><strong>1.2 创建 tools 数组</strong></h4>
<p>人类在选择工具之前，需要对工具有全面的了解，包括工具的功能、何时使用以及输入参数等。大模型也需要这些信息才能更准确地选择工具。请根据以下 JSON 格式提供工具信息。</p>
<p>| -   <code>type</code>字段固定为<code>&quot;function&quot;</code>；</p>
<ul>
<li>
<p><code>function</code>字段为 Object 类型；</p>
<ul>
<li>
<p><code>name</code>字段为自定义的工具函数名称，建议使用与函数相同的名称，如<code>get_current_weather</code>或<code>get_current_time</code>；</p>
</li>
<li>
<p><code>description</code>字段是对工具函数功能的描述，大模型会参考该字段来选择是否使用该工具函数。</p>
</li>
<li>
<p><code>parameters</code>字段是对工具函数入参的描述，类型是 Object ，大模型会参考该字段来进行入参的提取。如果工具函数不需要输入参数，则无需指定<code>parameters</code>参数。</p>
<ul>
<li>
<p><code>type</code>字段固定为<code>&quot;object&quot;</code>；</p>
</li>
<li>
<p><code>properties</code>字段描述了入参的名称、数据类型与描述，为 Object 类型，Key 值为入参的名称，Value 值为入参的数据类型与描述；</p>
</li>
<li>
<p><code>required</code>字段指定哪些参数为必填项，为 Array 类型。 | 对于天气查询工具来说，工具描述信息的格式如下：</p>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<pre tabindex="0"><code>{
    &#34;type&#34;: &#34;function&#34;,
    &#34;function&#34;: {
        &#34;name&#34;: &#34;get_current_weather&#34;,
        &#34;description&#34;: &#34;当你想查询指定城市的天气时非常有用。&#34;,
        &#34;parameters&#34;: {
            &#34;type&#34;: &#34;object&#34;,
            &#34;properties&#34;: {
                &#34;location&#34;: {
                    &#34;type&#34;: &#34;string&#34;,
                    &#34;description&#34;: &#34;城市或县区，比如北京市、杭州市、余杭区等。&#34;
                }
            },
            &#34;required&#34;: [&#34;location&#34;]
        }
    }
}
``` |
|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|

在发起 Function Calling 前，需在代码中定义工具信息数组（tools），包含每个工具的函数名、描述和参数定义。这个数组在后续发起Function Calling请求时作为参数传入。

### **2\. 创建messages数组**

Function Calling 通过 messages 数组向大模型传入指令与上下文信息。发起 Function Calling 前，messages 数组需要包含 System Message 与 User Message。

#### **System Message**

尽管在[创建 tools 数组](https://help.aliyun.com/zh/model-studio/qwen-function-calling#b7c8a0e72a9d0)时已经对工具的作用与何时使用工具进行了描述，但在 System Message 中强调何时调用工具通常会提高工具调用的准确率。在当前场景下，可以将 System Prompt 设置为：
</code></pre><p>你是一个很有帮助的助手。如果用户提问关于天气的问题，请调用 ‘get_current_weather’ 函数;
如果用户提问关于时间的问题，请调用‘get_current_time’函数。
请以友好的语气回答问题。</p>
<pre tabindex="0"><code>
#### **User Message**

User Message 用于传入用户提问的问题。假设用户提问“上海天气”，此时的 messages 数组为：

&gt; 由于备选工具包含天气查询与时间查询，也可提问关于当前时间的问题。

### **3\. 发起 Function Calling**

将创建好的 `tools` 与 `messages` 传入大模型，即可发起一次 Function Calling。大模型会判断是否调用工具。若调用，则返回该工具的函数名与参数。

&gt; 支持的模型参见[支持的模型](https://help.aliyun.com/zh/model-studio/qwen-function-calling#c8feada2328us)。

由于用户提问为上海天气，大模型指定需要使用的工具函数名称为：`&#34;get_current_weather&#34;`，函数的入参为：`&#34;{\&#34;location\&#34;: \&#34;上海\&#34;}&#34;`。

```swift
{
    &#34;content&#34;: &#34;&#34;,
    &#34;refusal&#34;: null,
    &#34;role&#34;: &#34;assistant&#34;,
    &#34;audio&#34;: null,
    &#34;function_call&#34;: null,
    &#34;tool_calls&#34;: [
        {
            &#34;id&#34;: &#34;call_6596dafa2a6a46f7a217da&#34;,
            &#34;function&#34;: {
                &#34;arguments&#34;: &#34;{\&#34;location\&#34;: \&#34;上海\&#34;}&#34;,
                &#34;name&#34;: &#34;get_current_weather&#34;
            },
            &#34;type&#34;: &#34;function&#34;,
            &#34;index&#34;: 0
        }
    ]
}
</code></pre><p>需要注意，如果问题被大模型判断为无需使用工具，会通过<code>content</code>参数直接回复。在输入“你好”时，<code>tool_calls</code>参数为空，返回对象格式为：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&#34;content&#34;</span>: <span style="color:#d14">&#34;你好！有什么可以帮助你的吗？如果你有关于天气或者时间的问题，我特别擅长回答。&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&#34;refusal&#34;</span>: <span style="color:#000;font-weight:bold">null</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&#34;role&#34;</span>: <span style="color:#d14">&#34;assistant&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&#34;audio&#34;</span>: <span style="color:#000;font-weight:bold">null</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&#34;function_call&#34;</span>: <span style="color:#000;font-weight:bold">null</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&#34;tool_calls&#34;</span>: <span style="color:#000;font-weight:bold">null</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>如果<code>tool_calls</code> 参数为空，可使程序直接返回 <code>content</code>，无需运行以下步骤。</p>
</blockquote>
<blockquote>
<p>若希望每次发起 Function Calling 后大模型都可以选择指定工具，请参见<a href="https://help.aliyun.com/zh/model-studio/qwen-function-calling#b0910669927j7">强制工具调用</a>。</p>
</blockquote>
<h3 id="4-运行工具函数"><strong>4. 运行工具函数</strong></h3>
<p>运行工具函数是将大模型的决策转化为实际操作的关键步骤。</p>
<blockquote>
<p>运行工具函数的过程由您的计算环境而非大模型来完成。</p>
</blockquote>
<p>由于大模型只可以输出字符串格式的内容，因此在运行工具函数前，需要对字符串格式的工具函数与入参分别解析。</p>
<ul>
<li>
<p>工具函数</p>
<p>建立一个<strong>工具函数名称</strong>到<strong>工具函数实体</strong>的映射<code>function_mapper</code>，将返回的工具函数字符串映射到工具函数实体；</p>
</li>
<li>
<p>入参</p>
<p>Function Calling 返回的入参为 JSON 字符串，使用工具将其解析为 JSON 对象，提取入参信息。</p>
</li>
</ul>
<p>完成解析后，将参数传入工具函数并执行，获取输出结果。</p>
<p>运行后得到如下输出：</p>
<p><strong>说明</strong></p>
<p>在实际业务场景中，许多工具的核心功能是执行具体操作（如邮件发送、文件上传等），而非数据查询，这类工具执行后不会输出字符串。为帮助大模型了解工具运行状态，建议在设计此类工具时添加如“邮件发送完成”、&ldquo;操作执行失败&quot;等状态描述信息。</p>
<h3 id="5-大模型总结工具函数输出"><strong>5. 大模型总结工具函数输出</strong></h3>
<p>工具函数的输出格式较为固定，如果直接返回给用户，可能会有语气生硬、不够灵活等问题。如果您希望大模型能够综合用户输入以及工具输出结果，生成自然语言风格的回复，可以将工具输出提交到模型上下文并再次向模型发出请求。</p>
<ol>
<li>
<p>添加 Assistant Message</p>
<p><a href="https://help.aliyun.com/zh/model-studio/qwen-function-calling#9f478b2e76wrk">发起 Function Calling</a>后，通过<code>completion.choices[0].message</code>得到 Assistant Message，首先将它添加到 messages 数组中；</p>
</li>
<li>
<p>添加 Tool Message</p>
<p>将工具的输出通过<code>{&quot;role&quot;: &quot;tool&quot;, &quot;content&quot;: &quot;工具的输出&quot;,&quot;tool_call_id&quot;: completion.choices[0].message.tool_calls[0].id}</code>形式添加到 messages 数组。</p>
<p><strong>说明</strong></p>
<ul>
<li>
<p>请确保工具的输出为字符串格式。</p>
</li>
<li>
<p><code>tool_call_id</code> 是系统为每一次的工具调用请求生成的<strong>唯一标识符</strong>。模型可能一次性要求调用多个工具，将多个工具结果返回给模型时，<code>tool_call_id</code>可确保工具的输出结果能够与它的调用意图对应。</p>
</li>
</ul>
</li>
</ol>
<p>此时的 messages 数组为：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span>[<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000;font-weight:bold">System</span><span style="color:#bbb"> </span>Message<span style="color:#bbb"> </span><span style="color:#998;font-style:italic">-- 指引模型调用工具的策略
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span><span style="color:#bbb">  </span><span style="color:#000;font-weight:bold">User</span><span style="color:#bbb"> </span>Message<span style="color:#bbb"> </span><span style="color:#998;font-style:italic">-- 用户的问题
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span><span style="color:#bbb">  </span>Assistant<span style="color:#bbb"> </span>Message<span style="color:#bbb"> </span><span style="color:#998;font-style:italic">-- 模型返回的工具调用信息
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span><span style="color:#bbb">  </span>Tool<span style="color:#bbb"> </span>Message<span style="color:#bbb"> </span><span style="color:#998;font-style:italic">-- 工具的输出信息（如果采用下文介绍的并行工具调用，可能有多个 Tool Message）
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>]<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>更新 messages 数组后，运行以下代码。</p>
<p>可从<code>content</code>得到回复内容：“上海今天的天气是多云。如果您有其他问题，欢迎继续提问。”</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&#34;content&#34;</span>: <span style="color:#d14">&#34;上海今天的天气是多云。如果您有其他问题，欢迎继续提问。&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&#34;refusal&#34;</span>: <span style="color:#000;font-weight:bold">null</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&#34;role&#34;</span>: <span style="color:#d14">&#34;assistant&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&#34;audio&#34;</span>: <span style="color:#000;font-weight:bold">null</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&#34;function_call&#34;</span>: <span style="color:#000;font-weight:bold">null</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#000080">&#34;tool_calls&#34;</span>: <span style="color:#000;font-weight:bold">null</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>至此，您已完成了一次完整的 Function Calling 流程。</p>
<h2 id="进阶用法"><strong>进阶用法</strong></h2>
<h3 id="指定工具调用方式"><strong>指定工具调用方式</strong></h3>
<h4 id="并行工具调用"><strong>并行工具调用</strong></h4>
<p>单一城市的天气查询经过一次工具调用即可。如果输入问题需要调用多次工具，如“北京上海的天气如何”或“杭州天气，以及现在几点了”，<a href="https://help.aliyun.com/zh/model-studio/qwen-function-calling#9f478b2e76wrk">发起 Function Calling</a> 后只会返回一个工具调用信息，以提问“北京上海的天气如何”为例：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#d14">&#34;content&#34;</span>: <span style="color:#d14">&#34;&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#d14">&#34;refusal&#34;</span>: null,
</span></span><span style="display:flex;"><span>    <span style="color:#d14">&#34;role&#34;</span>: <span style="color:#d14">&#34;assistant&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#d14">&#34;audio&#34;</span>: null,
</span></span><span style="display:flex;"><span>    <span style="color:#d14">&#34;function_call&#34;</span>: null,
</span></span><span style="display:flex;"><span>    <span style="color:#d14">&#34;tool_calls&#34;</span>: [
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#d14">&#34;id&#34;</span>: <span style="color:#d14">&#34;call_61a2bbd82a8042289f1ff2&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#d14">&#34;function&#34;</span>: {
</span></span><span style="display:flex;"><span>                <span style="color:#d14">&#34;arguments&#34;</span>: <span style="color:#d14">&#34;{</span><span style="color:#d14">\&#34;</span><span style="color:#d14">location</span><span style="color:#d14">\&#34;</span><span style="color:#d14">: </span><span style="color:#d14">\&#34;</span><span style="color:#d14">北京市</span><span style="color:#d14">\&#34;</span><span style="color:#d14">}&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#d14">&#34;name&#34;</span>: <span style="color:#d14">&#34;get_current_weather&#34;</span>
</span></span><span style="display:flex;"><span>            },
</span></span><span style="display:flex;"><span>            <span style="color:#d14">&#34;type&#34;</span>: <span style="color:#d14">&#34;function&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#d14">&#34;index&#34;</span>: <span style="color:#099">0</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    ]
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>返回结果中只有北京市的入参信息。为了解决这一问题，在<a href="https://help.aliyun.com/zh/model-studio/qwen-function-calling#9f478b2e76wrk">发起 Function Calling</a>时，可设置请求参数<code>parallel_tool_calls</code>为<code>true</code>，这样返回对象中将包含所有需要调用的工具函数与入参信息。</p>
<p><strong>说明</strong></p>
<p>并行工具调用适合任务之间无依赖的情况。若任务之间有依赖关系（工具A的输入与工具B的输出结果有关），请参见<a href="https://help.aliyun.com/zh/model-studio/qwen-function-calling#dd5a3dca390k9">快速开始</a>，通过while循环实现串行工具调用（一次调用一个工具）。</p>
<p>在返回对象的<code>tool_calls</code>数组中包含了北京上海的入参信息：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#d14">&#34;content&#34;</span>: <span style="color:#d14">&#34;&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#d14">&#34;role&#34;</span>: <span style="color:#d14">&#34;assistant&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#d14">&#34;tool_calls&#34;</span>: [
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#d14">&#34;function&#34;</span>: {
</span></span><span style="display:flex;"><span>                <span style="color:#d14">&#34;name&#34;</span>: <span style="color:#d14">&#34;get_current_weather&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#d14">&#34;arguments&#34;</span>: <span style="color:#d14">&#34;{</span><span style="color:#d14">\&#34;</span><span style="color:#d14">location</span><span style="color:#d14">\&#34;</span><span style="color:#d14">: </span><span style="color:#d14">\&#34;</span><span style="color:#d14">北京市</span><span style="color:#d14">\&#34;</span><span style="color:#d14">}&#34;</span>
</span></span><span style="display:flex;"><span>            },
</span></span><span style="display:flex;"><span>            <span style="color:#d14">&#34;index&#34;</span>: <span style="color:#099">0</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#d14">&#34;id&#34;</span>: <span style="color:#d14">&#34;call_c2d8a3a24c4d4929b26ae2&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#d14">&#34;type&#34;</span>: <span style="color:#d14">&#34;function&#34;</span>
</span></span><span style="display:flex;"><span>        },
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#d14">&#34;function&#34;</span>: {
</span></span><span style="display:flex;"><span>                <span style="color:#d14">&#34;name&#34;</span>: <span style="color:#d14">&#34;get_current_weather&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#d14">&#34;arguments&#34;</span>: <span style="color:#d14">&#34;{</span><span style="color:#d14">\&#34;</span><span style="color:#d14">location</span><span style="color:#d14">\&#34;</span><span style="color:#d14">: </span><span style="color:#d14">\&#34;</span><span style="color:#d14">上海市</span><span style="color:#d14">\&#34;</span><span style="color:#d14">}&#34;</span>
</span></span><span style="display:flex;"><span>            },
</span></span><span style="display:flex;"><span>            <span style="color:#d14">&#34;index&#34;</span>: <span style="color:#099">1</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#d14">&#34;id&#34;</span>: <span style="color:#d14">&#34;call_dc7f2f678f1944da9194cd&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#d14">&#34;type&#34;</span>: <span style="color:#d14">&#34;function&#34;</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    ]
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="强制工具调用"><strong>强制工具调用</strong></h4>
<p>大模型生成内容具有不确定性，有时会选择错误的工具进行调用。如果您希望对于某一类问题，大模型能够采取人为设定的策略（如强制使用某个工具、强制不使用工具），可修改<code>tool_choice</code>参数。<code>tool_choice</code>参数的默认值为<code>&quot;auto&quot;</code>，表示由大模型自主判断如何进行工具调用。</p>
<blockquote>
<p>大模型总结工具函数输出时，请将<code>tool_choice</code>参数去除，否则 API 仍会返回工具调用信息。</p>
</blockquote>
<ul>
<li>
<p><strong>强制使用某个工具</strong></p>
<p>如果您希望对于某一类问题，Function Calling 能强制调用某个工具，可设定<code>tool_choice</code>参数为<code>{&quot;type&quot;: &quot;function&quot;, &quot;function&quot;: {&quot;name&quot;: &quot;the_function_to_call&quot;}}</code>，大模型将不参与工具的选择，只输出入参信息。</p>
<p>假设当前场景中只包含天气查询的问题，可修改 function_calling 代码为：</p>
<p>无论输入什么问题，返回对象的工具函数都会是<code>get_current_weather</code>。</p>
<blockquote>
<p>使用该策略前请确保问题与选择的工具相关，否则可能返回不符合预期的结果。</p>
</blockquote>
</li>
<li>
<p><strong>强制不使用工具</strong></p>
<p>如果您希望无论输入什么问题，Function Calling 都不会进行工具调用（返回对象中包含回复内容<code>content</code>而<code>tool_calls</code>参数为空），可设定<code>tool_choice</code>参数为<code>&quot;none&quot;</code>，或不传入<code>tools</code>参数，Function Calling 返回的<code>tool_calls</code>参数将始终为空。</p>
<p>假设当前场景中的问题均无需调用工具，可修改 function_calling 代码为：</p>
</li>
</ul>
<h3 id="多轮对话"><strong>多轮对话</strong></h3>
<p>用户可能在第一轮提问“北京天气”，第二轮提问“上海的呢？”若模型上下文中没有第一轮的信息，模型无法判断需要调用哪个工具。建议在多轮对话场景中，每轮结束后维持 messages 数组，在此基础上添加 User Message并<a href="https://help.aliyun.com/zh/model-studio/qwen-function-calling#9f478b2e76wrk">发起 Function Calling</a>以及后续步骤。messages 结构如下所示：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span>[<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000;font-weight:bold">System</span><span style="color:#bbb"> </span>Message<span style="color:#bbb"> </span><span style="color:#998;font-style:italic">-- 指引模型调用工具的策略
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span><span style="color:#bbb">  </span><span style="color:#000;font-weight:bold">User</span><span style="color:#bbb"> </span>Message<span style="color:#bbb"> </span><span style="color:#998;font-style:italic">-- 用户的问题
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span><span style="color:#bbb">  </span>Assistant<span style="color:#bbb"> </span>Message<span style="color:#bbb"> </span><span style="color:#998;font-style:italic">-- 模型返回的工具调用信息
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span><span style="color:#bbb">  </span>Tool<span style="color:#bbb"> </span>Message<span style="color:#bbb"> </span><span style="color:#998;font-style:italic">-- 工具的输出信息
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span><span style="color:#bbb">  </span>Assistant<span style="color:#bbb"> </span>Message<span style="color:#bbb"> </span><span style="color:#998;font-style:italic">-- 模型总结的工具调用信息
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span><span style="color:#bbb">  </span><span style="color:#000;font-weight:bold">User</span><span style="color:#bbb"> </span>Message<span style="color:#bbb"> </span><span style="color:#998;font-style:italic">-- 用户第二轮的问题
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>]<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="流式输出"><strong>流式输出</strong></h3>
<p>为了提升用户体验和减少等待时间，可使用流式输出实时获取工具函数名称与入参信息。其中：</p>
<ul>
<li>
<p>工具函数名称：仅在第一个流式返回的对象（delta）中出现。</p>
</li>
<li>
<p>入参信息：以流式方式输出。</p>
</li>
</ul>
<p>运行后得到如下输出：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>ChoiceDeltaToolCall<span style="color:#000;font-weight:bold">(</span><span style="color:#008080">index</span><span style="color:#000;font-weight:bold">=</span>0, <span style="color:#008080">id</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#39;call_8f08d2b0fc0c4d8fab7123&#39;</span>, <span style="color:#000;font-weight:bold">function</span><span style="color:#000;font-weight:bold">=</span>ChoiceDeltaToolCallFunction<span style="color:#000;font-weight:bold">(</span><span style="color:#008080">arguments</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#39;{&#34;location&#34;:&#39;</span>, <span style="color:#008080">name</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#39;get_current_weather&#39;</span><span style="color:#000;font-weight:bold">)</span>, <span style="color:#008080">type</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#39;function&#39;</span><span style="color:#000;font-weight:bold">)]</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>ChoiceDeltaToolCall<span style="color:#000;font-weight:bold">(</span><span style="color:#008080">index</span><span style="color:#000;font-weight:bold">=</span>0, <span style="color:#008080">id</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#39;&#39;</span>, <span style="color:#000;font-weight:bold">function</span><span style="color:#000;font-weight:bold">=</span>ChoiceDeltaToolCallFunction<span style="color:#000;font-weight:bold">(</span><span style="color:#008080">arguments</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#39; &#34;杭州&#34;}&#39;</span>, <span style="color:#008080">name</span><span style="color:#000;font-weight:bold">=</span>None<span style="color:#000;font-weight:bold">)</span>, <span style="color:#008080">type</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#39;function&#39;</span><span style="color:#000;font-weight:bold">)]</span>
</span></span><span style="display:flex;"><span>None
</span></span></code></pre></td></tr></table>
</div>
</div><p>运行以下代码拼接入参信息（<code>arguments</code>）：</p>
<p>获得如下输出：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span>{<span style="color:#d14">&#34;index&#34;</span>:<span style="color:#099">0</span>,<span style="color:#d14">&#34;id&#34;</span>:<span style="color:#d14">&#34;call_16c72bef988a4c6c8cc662&#34;</span>,<span style="color:#d14">&#34;function&#34;</span>:{<span style="color:#d14">&#34;arguments&#34;</span>:<span style="color:#d14">&#34;{</span><span style="color:#d14">\&#34;</span><span style="color:#d14">location</span><span style="color:#d14">\&#34;</span><span style="color:#d14">: </span><span style="color:#d14">\&#34;</span><span style="color:#d14">杭州</span><span style="color:#d14">\&#34;</span><span style="color:#d14">}&#34;</span>,<span style="color:#d14">&#34;name&#34;</span>:<span style="color:#d14">&#34;get_current_weather&#34;</span>},<span style="color:#d14">&#34;type&#34;</span>:<span style="color:#d14">&#34;function&#34;</span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>在使用大模型总结工具函数输出步骤，添加的 Assistant Message 需要符合下方格式。仅需将下方的<code>tool_calls</code>中的元素替换为以上内容即可。</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#d14">&#34;content&#34;</span>: <span style="color:#d14">&#34;&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#d14">&#34;refusal&#34;</span>: <span style="color:#000;font-weight:bold">None</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#d14">&#34;role&#34;</span>: <span style="color:#d14">&#34;assistant&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#d14">&#34;audio&#34;</span>: <span style="color:#000;font-weight:bold">None</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#d14">&#34;function_call&#34;</span>: <span style="color:#000;font-weight:bold">None</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#d14">&#34;tool_calls&#34;</span>: [
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#d14">&#34;id&#34;</span>: <span style="color:#d14">&#34;call_xxx&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#d14">&#34;function&#34;</span>: {
</span></span><span style="display:flex;"><span>                <span style="color:#d14">&#34;arguments&#34;</span>: <span style="color:#d14">&#39;{&#34;location&#34;: &#34;xx&#34;}&#39;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#d14">&#34;name&#34;</span>: <span style="color:#d14">&#34;get_current_weather&#34;</span>,
</span></span><span style="display:flex;"><span>            },
</span></span><span style="display:flex;"><span>            <span style="color:#d14">&#34;type&#34;</span>: <span style="color:#d14">&#34;function&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#d14">&#34;index&#34;</span>: <span style="color:#099">0</span>,
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    ],
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="深度思考模型的工具调用"><strong>深度思考模型的工具调用</strong></h3>
<p>深度思考模型在输出工具调用信息前会进行思考，可以提升决策的可解释性与可靠性。</p>
<ol>
<li>
<p><strong>思考过程</strong></p>
<p>模型逐步分析用户意图、识别所需工具、验证参数合法性，并规划调用策略；</p>
</li>
<li>
<p><strong>工具调用</strong></p>
<p>模型以结构化格式输出一个或多个函数调用请求。</p>
<blockquote>
<p>支持并行工具调用。</p>
</blockquote>
</li>
</ol>
<p>以下展示流式调用深度思考模型的工具调用示例。</p>
<blockquote>
<p>文本生成思考模型请参见：<a href="https://help.aliyun.com/zh/model-studio/deep-thinking">深度思考</a>；多模态思考模型请参见：<a href="https://help.aliyun.com/zh/model-studio/vision">视觉理解</a>。</p>
</blockquote>
<blockquote>
<p><code>tool_choice</code>参数只支持设置为<code>&quot;auto&quot;</code>（默认值，表示由模型自主选择工具）或<code>&quot;none&quot;</code>（强制模型不选择工具）。</p>
</blockquote>
<h3 id="示例代码"><strong>示例代码</strong></h3>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 72
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 73
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 74
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 75
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 76
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 77
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 78
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 79
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 80
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 81
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 82
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 83
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 84
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 85
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 86
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 87
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 88
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 89
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 90
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 91
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 92
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 93
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 94
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 95
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 96
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 97
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 98
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 99
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">100
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">101
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">102
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">103
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">104
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">105
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">106
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">107
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">108
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">109
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">110
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">111
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">112
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">113
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">114
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">115
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">116
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">117
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">118
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">119
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">120
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">121
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">122
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">os</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">from</span> <span style="color:#555">openai</span> <span style="color:#000;font-weight:bold">import</span> OpenAI
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 初始化OpenAI客户端，配置阿里云DashScope服务</span>
</span></span><span style="display:flex;"><span>client <span style="color:#000;font-weight:bold">=</span> OpenAI(
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic"># 若没有配置环境变量，请用阿里云百炼API Key将下行替换为：api_key=&#34;sk-xxx&#34;,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic"># 新加坡和北京地域的API Key不同。获取API Key：https://help.aliyun.com/zh/model-studio/get-api-key</span>
</span></span><span style="display:flex;"><span>    api_key<span style="color:#000;font-weight:bold">=</span>os<span style="color:#000;font-weight:bold">.</span>getenv(<span style="color:#d14">&#34;DASHSCOPE_API_KEY&#34;</span>),  <span style="color:#998;font-style:italic"># 从环境变量读取API密钥</span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic"># 以下是北京地域base_url，如果使用新加坡地域的模型，需要将base_url替换为：https://dashscope-intl.aliyuncs.com/compatible-mode/v1</span>
</span></span><span style="display:flex;"><span>    base_url<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;https://dashscope.aliyuncs.com/compatible-mode/v1&#34;</span>,
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 定义可用工具列表</span>
</span></span><span style="display:flex;"><span>tools <span style="color:#000;font-weight:bold">=</span> [
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic"># 工具1 获取当前时刻的时间</span>
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#d14">&#34;type&#34;</span>: <span style="color:#d14">&#34;function&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#d14">&#34;function&#34;</span>: {
</span></span><span style="display:flex;"><span>            <span style="color:#d14">&#34;name&#34;</span>: <span style="color:#d14">&#34;get_current_time&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#d14">&#34;description&#34;</span>: <span style="color:#d14">&#34;当你想知道现在的时间时非常有用。&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#d14">&#34;parameters&#34;</span>: {}  <span style="color:#998;font-style:italic"># 无需参数</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    },  
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic"># 工具2 获取指定城市的天气</span>
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#d14">&#34;type&#34;</span>: <span style="color:#d14">&#34;function&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#d14">&#34;function&#34;</span>: {
</span></span><span style="display:flex;"><span>            <span style="color:#d14">&#34;name&#34;</span>: <span style="color:#d14">&#34;get_current_weather&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#d14">&#34;description&#34;</span>: <span style="color:#d14">&#34;当你想查询指定城市的天气时非常有用。&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#d14">&#34;parameters&#34;</span>: {  
</span></span><span style="display:flex;"><span>                <span style="color:#d14">&#34;type&#34;</span>: <span style="color:#d14">&#34;object&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#d14">&#34;properties&#34;</span>: {
</span></span><span style="display:flex;"><span>                    <span style="color:#d14">&#34;location&#34;</span>: {
</span></span><span style="display:flex;"><span>                        <span style="color:#d14">&#34;type&#34;</span>: <span style="color:#d14">&#34;string&#34;</span>,
</span></span><span style="display:flex;"><span>                        <span style="color:#d14">&#34;description&#34;</span>: <span style="color:#d14">&#34;城市或县区，比如北京市、杭州市、余杭区等。&#34;</span>
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>                },
</span></span><span style="display:flex;"><span>                <span style="color:#d14">&#34;required&#34;</span>: [<span style="color:#d14">&#34;location&#34;</span>]  <span style="color:#998;font-style:italic"># 必填参数</span>
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>messages <span style="color:#000;font-weight:bold">=</span> [{<span style="color:#d14">&#34;role&#34;</span>: <span style="color:#d14">&#34;user&#34;</span>, <span style="color:#d14">&#34;content&#34;</span>: <span style="color:#0086b3">input</span>(<span style="color:#d14">&#34;请输入问题：&#34;</span>)}]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># Qwen3-VL模型的 message示例</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># messages = [{</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#     &#34;role&#34;: &#34;user&#34;,</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#     &#34;content&#34;: [</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#              {&#34;type&#34;: &#34;image_url&#34;,&#34;image_url&#34;: {&#34;url&#34;: &#34;https://img.alicdn.com/imgextra/i4/O1CN014CJhzi20NOzo7atOC_!!6000000006837-2-tps-2048-1365.png&#34;}},</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#              {&#34;type&#34;: &#34;text&#34;, &#34;text&#34;: &#34;根据图像上的地点，请问该地点当前的天气&#34;}]</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#     }]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>completion <span style="color:#000;font-weight:bold">=</span> client<span style="color:#000;font-weight:bold">.</span>chat<span style="color:#000;font-weight:bold">.</span>completions<span style="color:#000;font-weight:bold">.</span>create(
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic"># 此处以qwen-plus为例，可更换为其它深度思考模型</span>
</span></span><span style="display:flex;"><span>    model<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;qwen-plus&#34;</span>,
</span></span><span style="display:flex;"><span>    messages<span style="color:#000;font-weight:bold">=</span>messages,
</span></span><span style="display:flex;"><span>    extra_body<span style="color:#000;font-weight:bold">=</span>{
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic"># 开启深度思考，该参数对qwen3-30b-a3b-thinking-2507、qwen3-235b-a22b-thinking-2507、QwQ 、DeepSeek-R1 模型无效</span>
</span></span><span style="display:flex;"><span>        <span style="color:#d14">&#34;enable_thinking&#34;</span>: <span style="color:#000;font-weight:bold">True</span>
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>    tools<span style="color:#000;font-weight:bold">=</span>tools,
</span></span><span style="display:flex;"><span>    parallel_tool_calls<span style="color:#000;font-weight:bold">=</span><span style="color:#000;font-weight:bold">True</span>,
</span></span><span style="display:flex;"><span>    stream<span style="color:#000;font-weight:bold">=</span><span style="color:#000;font-weight:bold">True</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic"># 解除注释后，可以获取到token消耗信息</span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic"># stream_options={</span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">#     &#34;include_usage&#34;: True</span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic"># }</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>reasoning_content <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#34;&#34;</span>  <span style="color:#998;font-style:italic"># 定义完整思考过程</span>
</span></span><span style="display:flex;"><span>answer_content <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#34;&#34;</span>     <span style="color:#998;font-style:italic"># 定义完整回复</span>
</span></span><span style="display:flex;"><span>tool_info <span style="color:#000;font-weight:bold">=</span> []          <span style="color:#998;font-style:italic"># 存储工具调用信息</span>
</span></span><span style="display:flex;"><span>is_answering <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">False</span>   <span style="color:#998;font-style:italic"># 判断是否结束思考过程并开始回复</span>
</span></span><span style="display:flex;"><span><span style="color:#0086b3">print</span>(<span style="color:#d14">&#34;=&#34;</span><span style="color:#000;font-weight:bold">*</span><span style="color:#099">20</span><span style="color:#000;font-weight:bold">+</span><span style="color:#d14">&#34;思考过程&#34;</span><span style="color:#000;font-weight:bold">+</span><span style="color:#d14">&#34;=&#34;</span><span style="color:#000;font-weight:bold">*</span><span style="color:#099">20</span>)
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">for</span> chunk <span style="color:#000;font-weight:bold">in</span> completion:
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">not</span> chunk<span style="color:#000;font-weight:bold">.</span>choices:
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic"># 处理用量统计信息</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0086b3">print</span>(<span style="color:#d14">&#34;</span><span style="color:#d14">\n</span><span style="color:#d14">&#34;</span><span style="color:#000;font-weight:bold">+</span><span style="color:#d14">&#34;=&#34;</span><span style="color:#000;font-weight:bold">*</span><span style="color:#099">20</span><span style="color:#000;font-weight:bold">+</span><span style="color:#d14">&#34;Usage&#34;</span><span style="color:#000;font-weight:bold">+</span><span style="color:#d14">&#34;=&#34;</span><span style="color:#000;font-weight:bold">*</span><span style="color:#099">20</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#0086b3">print</span>(chunk<span style="color:#000;font-weight:bold">.</span>usage)
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">else</span>:
</span></span><span style="display:flex;"><span>        delta <span style="color:#000;font-weight:bold">=</span> chunk<span style="color:#000;font-weight:bold">.</span>choices[<span style="color:#099">0</span>]<span style="color:#000;font-weight:bold">.</span>delta
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic"># 处理AI的思考过程（链式推理）</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">if</span> <span style="color:#0086b3">hasattr</span>(delta, <span style="color:#d14">&#39;reasoning_content&#39;</span>) <span style="color:#000;font-weight:bold">and</span> delta<span style="color:#000;font-weight:bold">.</span>reasoning_content <span style="color:#000;font-weight:bold">is</span> <span style="color:#000;font-weight:bold">not</span> <span style="color:#000;font-weight:bold">None</span>:
</span></span><span style="display:flex;"><span>            reasoning_content <span style="color:#000;font-weight:bold">+=</span> delta<span style="color:#000;font-weight:bold">.</span>reasoning_content
</span></span><span style="display:flex;"><span>            <span style="color:#0086b3">print</span>(delta<span style="color:#000;font-weight:bold">.</span>reasoning_content,end<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;&#34;</span>,flush<span style="color:#000;font-weight:bold">=</span><span style="color:#000;font-weight:bold">True</span>)  <span style="color:#998;font-style:italic"># 实时输出思考过程</span>
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic"># 处理最终回复内容</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">else</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">not</span> is_answering:  <span style="color:#998;font-style:italic"># 首次进入回复阶段时打印标题</span>
</span></span><span style="display:flex;"><span>                is_answering <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">True</span>
</span></span><span style="display:flex;"><span>                <span style="color:#0086b3">print</span>(<span style="color:#d14">&#34;</span><span style="color:#d14">\n</span><span style="color:#d14">&#34;</span><span style="color:#000;font-weight:bold">+</span><span style="color:#d14">&#34;=&#34;</span><span style="color:#000;font-weight:bold">*</span><span style="color:#099">20</span><span style="color:#000;font-weight:bold">+</span><span style="color:#d14">&#34;回复内容&#34;</span><span style="color:#000;font-weight:bold">+</span><span style="color:#d14">&#34;=&#34;</span><span style="color:#000;font-weight:bold">*</span><span style="color:#099">20</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">if</span> delta<span style="color:#000;font-weight:bold">.</span>content <span style="color:#000;font-weight:bold">is</span> <span style="color:#000;font-weight:bold">not</span> <span style="color:#000;font-weight:bold">None</span>:
</span></span><span style="display:flex;"><span>                answer_content <span style="color:#000;font-weight:bold">+=</span> delta<span style="color:#000;font-weight:bold">.</span>content
</span></span><span style="display:flex;"><span>                <span style="color:#0086b3">print</span>(delta<span style="color:#000;font-weight:bold">.</span>content,end<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;&#34;</span>,flush<span style="color:#000;font-weight:bold">=</span><span style="color:#000;font-weight:bold">True</span>)  <span style="color:#998;font-style:italic"># 流式输出回复内容</span>
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            <span style="color:#998;font-style:italic"># 处理工具调用信息（支持并行工具调用）</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">if</span> delta<span style="color:#000;font-weight:bold">.</span>tool_calls <span style="color:#000;font-weight:bold">is</span> <span style="color:#000;font-weight:bold">not</span> <span style="color:#000;font-weight:bold">None</span>:
</span></span><span style="display:flex;"><span>                <span style="color:#000;font-weight:bold">for</span> tool_call <span style="color:#000;font-weight:bold">in</span> delta<span style="color:#000;font-weight:bold">.</span>tool_calls:
</span></span><span style="display:flex;"><span>                    index <span style="color:#000;font-weight:bold">=</span> tool_call<span style="color:#000;font-weight:bold">.</span>index  <span style="color:#998;font-style:italic"># 工具调用索引，用于并行调用</span>
</span></span><span style="display:flex;"><span>                    
</span></span><span style="display:flex;"><span>                    <span style="color:#998;font-style:italic"># 动态扩展工具信息存储列表</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#000;font-weight:bold">while</span> <span style="color:#0086b3">len</span>(tool_info) <span style="color:#000;font-weight:bold">&lt;=</span> index:
</span></span><span style="display:flex;"><span>                        tool_info<span style="color:#000;font-weight:bold">.</span>append({})
</span></span><span style="display:flex;"><span>                    
</span></span><span style="display:flex;"><span>                    <span style="color:#998;font-style:italic"># 收集工具调用ID（用于后续函数调用）</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#000;font-weight:bold">if</span> tool_call<span style="color:#000;font-weight:bold">.</span>id:
</span></span><span style="display:flex;"><span>                        tool_info[index][<span style="color:#d14">&#39;id&#39;</span>] <span style="color:#000;font-weight:bold">=</span> tool_info[index]<span style="color:#000;font-weight:bold">.</span>get(<span style="color:#d14">&#39;id&#39;</span>, <span style="color:#d14">&#39;&#39;</span>) <span style="color:#000;font-weight:bold">+</span> tool_call<span style="color:#000;font-weight:bold">.</span>id
</span></span><span style="display:flex;"><span>                    
</span></span><span style="display:flex;"><span>                    <span style="color:#998;font-style:italic"># 收集函数名称（用于后续路由到具体函数）</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#000;font-weight:bold">if</span> tool_call<span style="color:#000;font-weight:bold">.</span>function <span style="color:#000;font-weight:bold">and</span> tool_call<span style="color:#000;font-weight:bold">.</span>function<span style="color:#000;font-weight:bold">.</span>name:
</span></span><span style="display:flex;"><span>                        tool_info[index][<span style="color:#d14">&#39;name&#39;</span>] <span style="color:#000;font-weight:bold">=</span> tool_info[index]<span style="color:#000;font-weight:bold">.</span>get(<span style="color:#d14">&#39;name&#39;</span>, <span style="color:#d14">&#39;&#39;</span>) <span style="color:#000;font-weight:bold">+</span> tool_call<span style="color:#000;font-weight:bold">.</span>function<span style="color:#000;font-weight:bold">.</span>name
</span></span><span style="display:flex;"><span>                    
</span></span><span style="display:flex;"><span>                    <span style="color:#998;font-style:italic"># 收集函数参数（JSON字符串格式，需要后续解析）</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#000;font-weight:bold">if</span> tool_call<span style="color:#000;font-weight:bold">.</span>function <span style="color:#000;font-weight:bold">and</span> tool_call<span style="color:#000;font-weight:bold">.</span>function<span style="color:#000;font-weight:bold">.</span>arguments:
</span></span><span style="display:flex;"><span>                        tool_info[index][<span style="color:#d14">&#39;arguments&#39;</span>] <span style="color:#000;font-weight:bold">=</span> tool_info[index]<span style="color:#000;font-weight:bold">.</span>get(<span style="color:#d14">&#39;arguments&#39;</span>, <span style="color:#d14">&#39;&#39;</span>) <span style="color:#000;font-weight:bold">+</span> tool_call<span style="color:#000;font-weight:bold">.</span>function<span style="color:#000;font-weight:bold">.</span>arguments
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span><span style="color:#0086b3">print</span>(<span style="color:#d14">f</span><span style="color:#d14">&#34;</span><span style="color:#d14">\n</span><span style="color:#d14">&#34;</span><span style="color:#000;font-weight:bold">+</span><span style="color:#d14">&#34;=&#34;</span><span style="color:#000;font-weight:bold">*</span><span style="color:#099">19</span><span style="color:#000;font-weight:bold">+</span><span style="color:#d14">&#34;工具调用信息&#34;</span><span style="color:#000;font-weight:bold">+</span><span style="color:#d14">&#34;=&#34;</span><span style="color:#000;font-weight:bold">*</span><span style="color:#099">19</span>)
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">not</span> tool_info:
</span></span><span style="display:flex;"><span>    <span style="color:#0086b3">print</span>(<span style="color:#d14">&#34;没有工具调用&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">else</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#0086b3">print</span>(tool_info)
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="返回结果"><strong>返回结果</strong></h3>
<p>输入“四个直辖市的天气”，得到以下返回结果：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">====================</span><span style="color:#a61717;background-color:#e3d2d2">思考过程</span><span style="color:#000;font-weight:bold">====================</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#a61717;background-color:#e3d2d2">好的，用户问的是“四个直辖市的天气”。首先，我需要明确四个直辖市是哪几个。根据中国的行政区划，直辖市包括北京、上海、天津和重庆。所以用户想知道这四个城市的天气情况。</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#a61717;background-color:#e3d2d2">接下来，我需要检查可用的工具。提供的工具中有</span>get_current_weather函数<span style="color:#a61717;background-color:#e3d2d2">，参数是</span>location<span style="color:#a61717;background-color:#e3d2d2">，类型字符串。每个城市需要单独查询，因为函数一次只能查一个地点。因此，我需要为每个直辖市调用一次这个函数。</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#a61717;background-color:#e3d2d2">然后，我需要考虑如何生成正确的工具调用。每个调用应该包含城市名称作为参数。比如，第一个调用是北京，第二个是上海，依此类推。确保参数名称是</span>location<span style="color:#a61717;background-color:#e3d2d2">，值是正确的城市名。</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#a61717;background-color:#e3d2d2">另外，用户可能希望得到每个城市的天气信息，所以需要确保每个函数调用都正确无误。可能需要连续调用四次，每次对应一个城市。不过，根据工具的使用规则，可能需要分多次处理，或者一次生成多个调用。但根据示例，可能每次只调用一个函数，所以可能需要逐步进行。</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#a61717;background-color:#e3d2d2">最后，确认是否有其他需要考虑的因素，比如参数是否正确，城市名称是否准确，以及是否需要处理可能的错误情况，比如城市不存在或</span>API不可用<span style="color:#a61717;background-color:#e3d2d2">。但目前看来，四个直辖市都是明确的，应该没问题。</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#000;font-weight:bold">====================</span><span style="color:#a61717;background-color:#e3d2d2">回复内容</span><span style="color:#000;font-weight:bold">====================</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#000;font-weight:bold">===================</span><span style="color:#a61717;background-color:#e3d2d2">工具调用信息</span><span style="color:#000;font-weight:bold">===================</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>[{<span style="color:#008080">&#39;id&#39;</span>: <span style="color:#008080">&#39;call_767af2834c12488a8fe6e3&#39;</span>,<span style="color:#bbb"> </span><span style="color:#008080">&#39;name&#39;</span>: <span style="color:#008080">&#39;get_current_weather&#39;</span>,<span style="color:#bbb"> </span><span style="color:#008080">&#39;arguments&#39;</span>: <span style="color:#008080">&#39;</span>{<span style="color:#d14">&#34;location&#34;</span>: <span style="color:#d14">&#34;北京市&#34;</span>}<span style="color:#008080">&#39;</span>},<span style="color:#bbb"> </span>{<span style="color:#008080">&#39;id&#39;</span>: <span style="color:#008080">&#39;call_2cb05a349c89437a947ada&#39;</span>,<span style="color:#bbb"> </span><span style="color:#008080">&#39;name&#39;</span>: <span style="color:#008080">&#39;get_current_weather&#39;</span>,<span style="color:#bbb"> </span><span style="color:#008080">&#39;arguments&#39;</span>: <span style="color:#008080">&#39;</span>{<span style="color:#d14">&#34;location&#34;</span>: <span style="color:#d14">&#34;上海市&#34;</span>}<span style="color:#008080">&#39;</span>},<span style="color:#bbb"> </span>{<span style="color:#008080">&#39;id&#39;</span>: <span style="color:#008080">&#39;call_988dd180b2ca4b0a864ea7&#39;</span>,<span style="color:#bbb"> </span><span style="color:#008080">&#39;name&#39;</span>: <span style="color:#008080">&#39;get_current_weather&#39;</span>,<span style="color:#bbb"> </span><span style="color:#008080">&#39;arguments&#39;</span>: <span style="color:#008080">&#39;</span>{<span style="color:#d14">&#34;location&#34;</span>: <span style="color:#d14">&#34;天津市&#34;</span>}<span style="color:#008080">&#39;</span>},<span style="color:#bbb"> </span>{<span style="color:#008080">&#39;id&#39;</span>: <span style="color:#008080">&#39;call_4e98c57ea96a40dba26d12&#39;</span>,<span style="color:#bbb"> </span><span style="color:#008080">&#39;name&#39;</span>: <span style="color:#008080">&#39;get_current_weather&#39;</span>,<span style="color:#bbb"> </span><span style="color:#008080">&#39;arguments&#39;</span>: <span style="color:#008080">&#39;</span>{<span style="color:#d14">&#34;location&#34;</span>: <span style="color:#d14">&#34;重庆市&#34;</span>}<span style="color:#008080">&#39;</span>}]<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h2 id="应用于生产环境"><strong>应用于生产环境</strong></h2>
<h3 id="测试工具调用准确率"><strong>测试工具调用准确率</strong></h3>
<ul>
<li>
<p><strong>建立评估体系</strong>：</p>
<p>构建贴近真实业务的测试数据集，并定义清晰的评估指标，如：工具选择准确率、参数提取准确率、端到端成功率等。</p>
</li>
<li>
<p><strong>优化提示词</strong></p>
<p>根据测试暴露出的具体问题（选错工具、参数错误），针对性地优化系统提示词、工具描述和参数描述，是核心的调优手段。</p>
</li>
<li>
<p><strong>升级模型</strong></p>
<p>当提示词工程调优无法提升性能时，升级到能力更强的模型版本（如 <code>qwen3-max-preview</code>）是提升指标最直接有效的方法。</p>
</li>
</ul>
<h3 id="动态控制工具数量"><strong>动态控制工具数量</strong></h3>
<p>当应用集成的工具数量超过几十甚至上百个时，将整个工具库全部提供给模型会带来以下问题：</p>
<ul>
<li>
<p><strong>性能下降</strong>：模型在庞大的工具集中选择正确工具的难度剧增；</p>
</li>
<li>
<p><strong>成本与延迟</strong>：大量的工具描述会消耗巨量的输入 Token，导致费用上升和响应变慢；</p>
</li>
</ul>
<p>解决方案是<strong>在调用模型前，增加一个工具路由/检索层</strong>，根据用户当前查询，从完整的工具库中快速、精准地筛选出一个小而相关的工具子集，再将其提供给模型。</p>
<p><strong>实现工具路由的几种主流方法：</strong></p>
<ul>
<li>
<p><strong>语义检索</strong></p>
<p>预先将所有工具的描述信息（<code>description</code>）通过 Embedding 模型转化为向量，并存入向量数据库。当用户查询时，将查询向量通过向量相似度搜索，召回最相关的 Top-K 个工具。</p>
</li>
<li>
<p><strong>混合检索</strong></p>
<p>将语义检索的“模糊匹配”能力与传统关键词或元数据标签的“精确匹配”能力相结合。为工具添加 <code>tags</code> 或 <code>keywords</code> 字段，检索时同时进行向量搜索和关键词过滤，可以大幅提升高频或特定场景下的召回精准度。</p>
</li>
<li>
<p><strong>轻量级 LLM 路由器</strong></p>
<p>对于更复杂的路由逻辑，可以使用一个更小、更快、更便宜的模型（如 Qwen-Flash）作为前置“路由模型”。它的任务是根据用户问题输出相关的工具名称列表。</p>
</li>
</ul>
<p><strong>实践建议</strong></p>
<ul>
<li>
<p><strong>保持候选集精简</strong>：无论使用何种方法，最终提供给主模型的工具数量建议<strong>不超过 20 个</strong>。这是在模型认知负荷、成本、延迟和准确率之间的最佳平衡点。</p>
</li>
<li>
<p><strong>分层过滤策略</strong>：可以构建一个漏斗式的路由策略。例如，先用成本极低的关键词/规则匹配进行第一轮筛选，过滤掉明显不相关的工具，再对剩余的工具进行语义检索，从而提高效率和质量。</p>
</li>
</ul>
<h3 id="工具安全性原则"><strong>工具安全性原则</strong></h3>
<p>将工具执行能力开放给大模型时，必须将安全置于首位。核心原则是“最小权限”和“人类确认”。</p>
<ul>
<li>
<p><strong>最小权限原则</strong>：为模型提供的工具集应严格遵守最小权限原则。默认情况下，工具应是只读的（如查询天气、搜索文档），避免直接提供任何涉及状态变更或资源操作的“写”权限。</p>
</li>
<li>
<p><strong>危险工具隔离</strong>：请勿向大模型直接提供危险工具，例如执行任意代码（<code>code interpreter</code>）、操作文件系统（<code>fs.delete</code>）、执行数据库删除或更新操作（<code>db.drop_table</code>）或涉及资金流转的工具（<code>payment.transfer</code>）。</p>
</li>
<li>
<p><strong>人类参与</strong>：对于所有高权限或不可逆的操作，必须引入人工审核和确认环节。模型可以生成操作请求，但最终的执行“按钮”必须由人类用户点击。例如，模型可以准备好一封邮件，但发送操作需要用户确认。</p>
</li>
</ul>
<h3 id="用户体验优化"><strong>用户体验优化</strong></h3>
<p>Function Calling 链路较长，任何一个环节出问题都可能导致用户体验下降。</p>
<h4 id="处理工具运行失败"><strong>处理工具运行失败</strong></h4>
<p>工具运行失败是常见情况。可采取以下策略：</p>
<ul>
<li>
<p><strong>最大重试次数</strong>：设置合理的重试上限（例如 3 次），避免因连续失败导致用户长时间等待或系统资源浪费。</p>
</li>
<li>
<p><strong>提供兜底话术</strong>：当重试耗尽或遇到无法解决的错误时，应向用户返回清晰、友好的提示信息，例如：“抱歉，我暂时无法查询到相关信息，可能是服务有些繁忙，请您稍后再试。”</p>
</li>
</ul>
<h4 id="应对处理延迟"><strong>应对处理延迟</strong></h4>
<p>较高的延迟会降低用户满意度，需要通过前端交互和后端优化来改善。</p>
<ul>
<li>
<p><strong>设置超时时间</strong>：为 Function Calling 的每一步设置独立且合理的超时时间。一旦超时，应立即中断操作并给出反馈。</p>
</li>
<li>
<p><strong>提供即时反馈</strong>：开始执行 Function Calling 时，建议在界面上给出提示，如“正在为您查询天气&hellip;”、“正在搜索相关信息&hellip;”，向用户实时反馈处理进度。</p>
</li>
</ul>
<h2 id="计费说明"><strong>计费说明</strong></h2>
<p>除了 messages 数组中的 Token 外，工具描述信息也会作为输入 Token 拼接到提示词中进行计费。</p>
<h2 id="通过-system-message-传入工具信息"><strong>通过 System Message 传入工具信息</strong></h2>
<h2 id="错误码">错误码</h2>
<p>如果模型调用失败并返回报错信息，请参见<a href="https://help.aliyun.com/zh/model-studio/error-code">错误信息</a>进行解决。</p>

        </div>

        
<div class="post-archive">
    <ul class="post-copyright">
        <li><strong>原文作者：</strong><a rel="author" href="https://index.zshipu.com/ai002/">知识铺</a></li>
        <li style="word-break:break-all"><strong>原文链接：</strong><a href="https://index.zshipu.com/ai002/post/20251029/%E5%A6%82%E4%BD%95%E9%80%9A%E8%BF%87Function-Calling-%E5%AE%9E%E7%8E%B0%E5%B7%A5%E5%85%B7%E8%B0%83%E7%94%A8-%E5%A4%A7%E6%A8%A1%E5%9E%8B%E6%9C%8D%E5%8A%A1%E5%B9%B3%E5%8F%B0%E7%99%BE%E7%82%BCModel-Studio-%E9%98%BF%E9%87%8C%E4%BA%91%E5%B8%AE%E5%8A%A9%E4%B8%AD%E5%BF%83/">https://index.zshipu.com/ai002/post/20251029/%E5%A6%82%E4%BD%95%E9%80%9A%E8%BF%87Function-Calling-%E5%AE%9E%E7%8E%B0%E5%B7%A5%E5%85%B7%E8%B0%83%E7%94%A8-%E5%A4%A7%E6%A8%A1%E5%9E%8B%E6%9C%8D%E5%8A%A1%E5%B9%B3%E5%8F%B0%E7%99%BE%E7%82%BCModel-Studio-%E9%98%BF%E9%87%8C%E4%BA%91%E5%B8%AE%E5%8A%A9%E4%B8%AD%E5%BF%83/</a></li>
        <li><strong>版权声明：</strong>本作品采用<a rel="license" href="https://creativecommons.org/licenses/by-nc-nd/4.0/">知识共享署名-非商业性使用-禁止演绎 4.0 国际许可协议</a>进行许可，非商业转载请注明出处（作者，原文链接），商业转载请联系作者获得授权。</li>
        <li><strong>免责声明：</strong>本页面内容均来源于站内编辑发布，部分信息来源互联网，并不意味着本站赞同其观点或者证实其内容的真实性，如涉及版权等问题，请立即联系客服进行更改或删除，保证您的合法权益。转载请注明来源，欢迎对文章中的引用来源进行考证，欢迎指出任何有错误或不够清晰的表达。也可以邮件至 sblig@126.com</li>
    </ul>
</div>
<br/>



        

<div class="post-archive">
    <h2>See Also</h2>
    <ul class="listing">
        
        <li><a href="/ai002/post/20251029/%E5%A4%A7%E6%A8%A1%E5%9E%8BLLM-%E5%A6%82%E4%BD%95%E9%80%89%E6%8B%A9AI-Agent%E6%A1%86%E6%9E%B6%E4%BA%94%E7%A7%8D%E4%B8%BB%E6%B5%81AI-Agent%E6%A1%86%E6%9E%B6%E5%AF%B9%E6%AF%94LangChainLangGraphCrewAISemantic-KernelAutoGen_autogen-langchain-%E5%AF%B9%E6%AF%94-CSDN%E5%8D%9A%E5%AE%A2/">大模型LLM 如何选择AI Agent框架？五种主流AI Agent框架对比（LangChain、LangGraph、CrewAI、Semantic Kernel、AutoGen）_autogen langchain 对比-CSDN博客 --知识铺</a></li>
        
        <li><a href="/ai002/post/20251029/%E5%91%8A%E5%88%AB%E7%9E%8E%E5%86%99AI-Agent-%E6%8F%90%E7%A4%BA%E8%AF%8D%E6%92%B0%E5%86%99%E6%8C%87%E5%8D%97-%E5%86%85%E9%99%84%E6%A8%A1%E4%BB%BF%E6%8A%80%E5%B7%A7&#43;%E5%AE%9E%E4%BE%8B-%E8%85%BE%E8%AE%AF%E4%BA%91%E5%BC%80%E5%8F%91%E8%80%85%E7%A4%BE%E5%8C%BA-%E8%85%BE%E8%AE%AF%E4%BA%91/">告别瞎写！AI Agent 提示词撰写指南 (内附模仿技巧&#43;实例) - 腾讯云开发者社区-腾讯云 --知识铺</a></li>
        
        <li><a href="/ai002/post/20251029/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%BA%94%E7%94%A8%E4%B8%8D%E5%90%8C%E6%8F%90%E7%A4%BA%E8%AF%8D%E8%8C%83%E5%BC%8F%E5%92%8CReAct-Agent%E6%99%BA%E8%83%BD%E4%BD%93%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90_react-agent-%E6%8F%90%E7%A4%BA%E8%AF%8D-CSDN%E5%8D%9A%E5%AE%A2/">大模型应用不同提示词范式和ReAct Agent智能体实现原理分析_react agent 提示词-CSDN博客 --知识铺</a></li>
        
        <li><a href="/ai002/post/20251029/%E5%85%B3%E4%BA%8E%E6%99%BA%E8%83%BD%E4%BD%93AI-Agent%E5%85%A5%E9%97%A8%E4%B8%80%E7%AF%87%E8%B6%85%E8%AF%A6%E7%BB%86%E7%9A%84%E6%80%BB%E7%BB%93-1/">关于智能体（AI Agent）入门，一篇超详细的总结！ --知识铺</a></li>
        
        <li><a href="/ai002/post/20251029/%E8%B6%85%E8%B6%8A-OpenAI-AltasAgent-%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F-FlowithOS-%E5%8F%91%E5%B8%83%E4%B8%80%E6%89%8B%E5%AE%9E%E6%B5%8B-1/">超越 OpenAI Altas，Agent 操作系统 FlowithOS 发布，一手实测 --知识铺</a></li>
        
    </ul>
</div>


        <div class="post-meta meta-tags">
            
            没有标签
            
        </div>
    </article>
    
    

    
    
    <div class="post bg-white">
      <script src="https://utteranc.es/client.js"
            repo= "zshipu/zshipu-index"
            issue-term="pathname"
            theme="github-light"
            crossorigin="anonymous"
            async>
      </script>
    </div>
    
</div>

                    <footer id="footer">
    <div>
        &copy; 2025 <a href="https://index.zshipu.com/ai002/">知识铺的博客 By 知识铺</a>
        
        | <a rel="nofollow" target="_blank" href="https://beian.miit.gov.cn/">浙 ICP 备19032823号-1</a>
        
    </div>
    <br />
    <div>
        <div class="github-badge">
            <a href="https://gohugo.io/" target="_black" rel="nofollow"><span class="badge-subject">Powered by</span><span class="badge-value bg-blue">Hugo</span></a>
        </div>
        <div class="github-badge">
            <a href="https://www.flysnow.org/" target="_black"><span class="badge-subject">Design by</span><span class="badge-value bg-brightgreen">飞雪无情</span></a>
        </div>
        <div class="github-badge">
            <a href="https://github.com/flysnow-org/maupassant-hugo" target="_black"><span class="badge-subject">Theme</span><span class="badge-value bg-yellowgreen">Maupassant</span></a>
        </div>
    </div>
</footer>


    
    <script type="text/javascript">
        window.MathJax = {
            tex2jax: {
                inlineMath: [['$', '$']],
                processEscapes: true
                }
            };
    </script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML' async></script>

<a id="rocket" href="#top"></a>
<script type="text/javascript" src='/ai002/js/totop.js?v=0.0.0' async=""></script>



    <script type="text/javascript" src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script>




                </div>

                <div id="secondary">
    <section class="widget">
        <form id="search" action='https://index.zshipu.com/ai002/search/' method="get" accept-charset="utf-8" target="_blank" _lpchecked="1">
      
      <input type="text" name="q" maxlength="20" placeholder="Search">
      <input type="hidden" name="sitesearch" value="https://index.zshipu.com/ai002/">
      <button type="submit" class="submit icon-search"></button>
</form>
    </section>
    
    <section class="widget">
        <h3 class="widget-title">最近文章</h3>
<ul class="widget-list">
    
    <li>
        <a href="https://index.zshipu.com/ai002/post/20251029/%E8%B0%B7%E6%AD%8C%E8%87%AA%E7%A0%94AI%E8%8A%AF%E7%89%87%E5%B0%86%E5%A6%82%E4%BD%95%E5%BD%B1%E5%93%8D%E8%8B%B1%E4%BC%9F%E8%BE%BE%E5%B8%82%E5%9C%BA%E4%BB%BD%E9%A2%9D/" title="谷歌自研AI芯片将如何影响英伟达市场份额 --知识铺">谷歌自研AI芯片将如何影响英伟达市场份额 --知识铺</a>
    </li>
    
    <li>
        <a href="https://index.zshipu.com/ai002/post/20251029/%E6%9C%80%E4%BD%B3%E7%BA%B3%E7%B1%B3%E9%A6%99%E8%95%89%E4%B8%93%E4%B8%9A%E6%8F%90%E7%A4%BA-%E5%8A%A0/" title="最佳纳米香蕉专业提示 - 加 --知识铺">最佳纳米香蕉专业提示 - 加 --知识铺</a>
    </li>
    
    <li>
        <a href="https://index.zshipu.com/ai002/post/20251029/%E5%AD%A6%E4%B9%A0%E8%AF%BE%E7%A8%8B%E5%A4%A7%E7%BA%B2%E5%A4%A7%E5%9E%8B%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B%E5%85%A8%E6%A0%88%E4%B8%93%E5%AE%B6/" title="学习课程大纲：大型语言模型全栈专家 --知识铺">学习课程大纲：大型语言模型全栈专家 --知识铺</a>
    </li>
    
    <li>
        <a href="https://index.zshipu.com/ai002/post/20251029/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E6%8A%80%E6%9C%AF%E4%B8%8E%E5%BA%94%E7%94%A8%E7%9A%84%E7%BB%BC%E5%90%88%E7%AE%80%E6%8A%A5/" title="大模型技术与应用的综合简报 --知识铺">大模型技术与应用的综合简报 --知识铺</a>
    </li>
    
    <li>
        <a href="https://index.zshipu.com/ai002/post/20251029/%E4%BD%BF%E7%94%A8-TensorFlow-%E4%B8%AD%E7%9A%84-Keras-API-%E8%AE%AD%E7%BB%83%E4%B8%80%E4%B8%AA%E6%A8%A1%E5%9E%8B/" title="使用 TensorFlow 中的 Keras API 训练一个模型 --知识铺">使用 TensorFlow 中的 Keras API 训练一个模型 --知识铺</a>
    </li>
    
    <li>
        <a href="https://index.zshipu.com/ai002/post/20251029/Nano-Banana-%E6%98%AF%E4%BB%80%E4%B9%88/" title="Nano Banana 是什么？ --知识铺">Nano Banana 是什么？ --知识铺</a>
    </li>
    
    <li>
        <a href="https://index.zshipu.com/ai002/post/20251029/Nano-Banana-Pro-%E6%9C%80%E4%BD%B3%E6%8F%90%E7%A4%BA%E8%AF%8D%E6%8C%87%E5%8D%97/" title="Nano Banana Pro 最佳提示词指南 --知识铺">Nano Banana Pro 最佳提示词指南 --知识铺</a>
    </li>
    
    <li>
        <a href="https://index.zshipu.com/ai002/post/20251029/Nano-Banana-Pro-Prompt-%E7%BB%88%E6%9E%81%E6%8C%87%E5%8D%97/" title="Nano Banana Pro Prompt 终极指南 --知识铺">Nano Banana Pro Prompt 终极指南 --知识铺</a>
    </li>
    
    <li>
        <a href="https://index.zshipu.com/ai002/post/20251023/%E5%85%8D%E8%B4%B9%E5%BF%AB%E5%86%B2MiniMax-M2%E6%A8%A1%E5%9E%8B%E9%85%8D%E7%BD%AE%E6%8C%87%E5%8D%97-Claude-Code-Codex-%E9%99%90%E6%97%B6%E7%A6%8F%E5%88%A9%E5%85%A8%E7%90%83%E5%85%8D%E8%B4%B914%E5%A4%A9/" title="免费快冲！MiniMax-M2模型配置指南 (Claude Code &amp; Codex) 限时福利：全球免费14天！ --知识铺">免费快冲！MiniMax-M2模型配置指南 (Claude Code &amp; Codex) 限时福利：全球免费14天！ --知识铺</a>
    </li>
    
    <li>
        <a href="https://index.zshipu.com/ai002/post/20251023/%E4%B8%80%E5%A4%A9%E5%90%83%E9%80%8F%E4%B8%80%E6%9D%A1%E4%BA%A7%E4%B8%9A%E9%93%BE%E4%BD%8E%E7%A9%BA%E7%BB%8F%E6%B5%8E%E4%BA%A7%E4%B8%9A%E9%93%BE%E6%B7%B1%E5%BA%A6%E8%A7%A3%E6%9E%90/" title="一天吃透一条产业链：低空经济产业链深度解析 --知识铺">一天吃透一条产业链：低空经济产业链深度解析 --知识铺</a>
    </li>
    
</ul>
    </section>

    
<section class="widget">
    <h3 class="widget-title" style="color:red">福利派送</h3>
    <ul class="widget-list">
        
        <li>
            <a href="https://pplx.ai/sblig3912" title="一起上 Comet，AI 工具免费用还送钱～" target="_blank" style="color:red">
                
                    <img src="https://cdn.jsdelivr.net/gh/zshipu/images/2025/202510250843697.png">
                
            </a>
        </li>
        
        <li>
            <a href="https://pplx.ai/sblig3912" title="邀请有礼 🎁 一起用 Comet，AI 助你更高效还送钱！" target="_blank" style="color:red">
                
                    <img src="https://cdn.jsdelivr.net/gh/zshipu/images/2025/202510250850822.png">
                
            </a>
        </li>
        
        <li>
            <a href="https://pplx.ai/sblig3912" title="AI 工具真香！我用的 Comet 免费送一个月 Pro～" target="_blank" style="color:red">
                
                    <img src="https://cdn.jsdelivr.net/gh/zshipu/images/2025/202510250851688.png">
                
            </a>
        </li>
        
    </ul>
</section>


    <section class="widget">
        <h3 class="widget-title"><a href='/ai002/categories/'>分类</a></h3>
<ul class="widget-list">
    
</ul>
    </section>

    <section class="widget">
        <h3 class="widget-title"><a href='/ai002/tags/'>标签</a></h3>
<div class="tagcloud">
    
</div>
    </section>

    
<section class="widget">
    <h3 class="widget-title">友情链接</h3>
    <ul class="widget-list">
        
        <li>
            <a target="_blank" href="https://blog.zshipu.com//" title="知识铺的博客">知识铺的博客</a>
        </li>
        
    </ul>
</section>


    <section class="widget">
        <h3 class="widget-title">其它</h3>
        <ul class="widget-list">
            <li><a href="https://index.zshipu.com/ai002/index.xml">文章 RSS</a></li>
        </ul>
    </section>
</div>
            </div>
        </div>
    </div>
</body>

</html>