<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="description" content="èƒŒå•è¯ç¥å™¨ç»ˆæç‰ˆ - æ™ºèƒ½å¤ä¹ ã€å¤šæ¨¡å¼å­¦ä¹ ã€è‡ªåŠ¨è¯¾ç¨‹ç®¡ç†">
    <meta name="theme-color" content="#667eea">
    <title>èƒŒå•è¯ç¥å™¨ Ultimate - ç»ˆæç‰ˆ</title>
    <style>
        :root {
            --color-primary: #667eea;
            --color-primary-dark: #764ba2;
            --color-secondary: #4facfe;
            --color-secondary-light: #00f2fe;
            --color-success: #4facfe;
            --color-warning: #fa709a;
            --color-danger: #f5576c;
            --color-info: #f093fb;
            --bg-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --card-bg: #ffffff;
            --card-bg-secondary: #f8f9fa;
            --text-primary: #333333;
            --text-secondary: #888888;
            --text-hint: #aaaaaa;
            --shadow-sm: 0 2px 8px rgba(0,0,0,0.1);
            --shadow-md: 0 10px 30px rgba(0,0,0,0.2);
            --shadow-lg: 0 20px 60px rgba(0,0,0,0.3);
            --radius-sm: 12px;
            --radius-md: 20px;
            --radius-lg: 30px;
            --transition-fast: 0.15s;
            --transition-normal: 0.3s;
            --transition-slow: 0.6s;
        }

        [data-theme="dark"] {
            --bg-gradient: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            --card-bg: #2d3748;
            --card-bg-secondary: #1a202c;
            --text-primary: #f7fafc;
            --text-secondary: #cbd5e0;
            --text-hint: #a0aec0;
            --shadow-md: 0 10px 30px rgba(0,0,0,0.5);
            --shadow-lg: 0 20px 60px rgba(0,0,0,0.7);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: var(--bg-gradient);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow-x: hidden;
            position: relative;
            color: var(--text-primary);
            transition: background var(--transition-normal);
        }

        .container {
            width: 100%;
            max-width: 420px;
            padding: 20px;
            position: relative;
            z-index: 1;
        }

        @media (max-width: 480px) {
            .container { padding: 12px; max-width: 100%; }
        }

        @media (min-width: 1024px) {
            .container { max-width: 900px; }
        }

        /* ç²’å­èƒŒæ™¯ */
        .particle {
            position: absolute;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            pointer-events: none;
            animation: float 15s infinite;
            will-change: transform, opacity;
        }

        @keyframes float {
            0%, 100% { transform: translate3d(0, 0, 0) rotate(0deg); opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { transform: translate3d(0, -100vh, 0) rotate(360deg); opacity: 0; }
        }

        /* å¤´éƒ¨ */
        .header {
            text-align: center;
            margin-bottom: 30px;
            animation: slideDown 0.8s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translate3d(0, -50px, 0); }
            to { opacity: 1; transform: translate3d(0, 0, 0); }
        }

        .header h1 {
            color: white;
            font-size: clamp(1.8em, 5vw, 2.5em);
            font-weight: 800;
            text-shadow: 0 4px 20px rgba(0,0,0,0.3);
            margin-bottom: 15px;
        }

        .header-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 15px;
        }

        .header-btn {
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
            padding: 10px 18px;
            border-radius: var(--radius-md);
            font-size: 0.85em;
            cursor: pointer;
            transition: all var(--transition-normal);
            font-weight: 600;
            white-space: nowrap;
            user-select: none;
        }

        .header-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .theme-toggle {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3em;
            padding: 0;
        }

        /* è¿›åº¦æ¡ */
        .progress-container {
            background: rgba(255, 255, 255, 0.2);
            border-radius: var(--radius-md);
            padding: 15px;
            backdrop-filter: blur(10px);
            margin-bottom: 25px;
            animation: fadeIn 1s ease;
        }

        .progress-bar {
            width: 100%;
            height: 12px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--color-success) 0%, var(--color-secondary-light) 100%);
            border-radius: 10px;
            transition: width 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            position: relative;
            overflow: hidden;
            will-change: width;
        }

        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { transform: translate3d(-100%, 0, 0); }
            100% { transform: translate3d(100%, 0, 0); }
        }

        .progress-text {
            color: white;
            text-align: center;
            margin-top: 10px;
            font-weight: 600;
            font-size: 0.9em;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* å¡ç‰‡åŒºåŸŸ */
        .card-stack {
            position: relative;
            width: 100%;
            height: 500px;
            perspective: 1500px;
        }

        @media (max-width: 480px) {
            .card-stack { height: 450px; }
        }

        .card {
            position: absolute;
            width: 100%;
            height: 100%;
            transition: transform var(--transition-normal) ease;
            transform-style: preserve-3d;
            will-change: transform;
        }

        .card.dragging { transition: none; }

        .card-inner {
            position: relative;
            width: 100%;
            height: 100%;
            transition: transform var(--transition-slow) cubic-bezier(0.68, -0.55, 0.265, 1.55);
            transform-style: preserve-3d;
            cursor: pointer;
        }

        .card-inner.flipped { transform: rotateY(180deg); }

        .card-face {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            border-radius: var(--radius-lg);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 40px;
            box-shadow: var(--shadow-lg);
            will-change: transform;
        }

        .card-front {
            background: var(--card-bg);
            color: var(--text-primary);
        }

        .card-back {
            background: linear-gradient(135deg, var(--color-success) 0%, var(--color-secondary-light) 100%);
            transform: rotateY(180deg);
            color: white;
        }

        .word-main {
            font-size: clamp(2.5em, 8vw, 3.5em);
            font-weight: 800;
            color: var(--color-primary);
            margin-bottom: 20px;
            animation: bounceIn 0.8s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            word-break: break-word;
            text-align: center;
        }

        [data-theme="dark"] .word-main {
            color: var(--color-secondary-light);
        }

        @keyframes bounceIn {
            0% { opacity: 0; transform: scale(0.3); }
            50% { opacity: 1; transform: scale(1.05); }
            70% { transform: scale(0.9); }
            100% { transform: scale(1); }
        }

        .phonetic {
            font-size: 1.1em;
            color: var(--text-secondary);
            margin-bottom: 15px;
            font-style: italic;
        }

        .sound-btn {
            background: var(--bg-gradient);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            font-size: 1em;
            cursor: pointer;
            transition: all var(--transition-normal);
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            font-weight: 600;
        }

        .sound-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }

        .tap-hint {
            font-size: 0.95em;
            color: var(--text-hint);
            text-align: center;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.6; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.05); }
        }

        .meaning {
            font-size: 1.6em;
            font-weight: 600;
            margin-bottom: 25px;
            text-align: center;
        }

        .example {
            font-size: 1.05em;
            line-height: 1.6;
            text-align: center;
            opacity: 0.95;
        }

        /* æ§åˆ¶æŒ‰é’® */
        .controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 30px;
            animation: fadeIn 1.2s ease;
        }

        .btn {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.8em;
            transition: all var(--transition-normal);
            box-shadow: var(--shadow-md);
            position: relative;
            overflow: hidden;
            user-select: none;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255,255,255,0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .btn:active::before {
            width: 200px;
            height: 200px;
        }

        .btn:hover {
            transform: scale(1.1) translateY(-5px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.3);
        }

        .btn-skip { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; }
        .btn-know { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; }
        .btn-unknown { background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); color: white; }

        /* å¡ç‰‡åŠ¨ç”» */
        .card.swipe-left {
            animation: swipeLeft 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards;
        }

        .card.swipe-right {
            animation: swipeRight 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards;
        }

        @keyframes swipeLeft {
            to { transform: translate3d(-150%, 0, 0) rotate(-30deg); opacity: 0; }
        }

        @keyframes swipeRight {
            to { transform: translate3d(150%, 0, 0) rotate(30deg); opacity: 0; }
        }

        /* Toast é€šçŸ¥ */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 10px;
            pointer-events: none;
        }

        .toast {
            background: var(--card-bg);
            color: var(--text-primary);
            padding: 16px 20px;
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg);
            display: flex;
            align-items: center;
            gap: 12px;
            min-width: 280px;
            animation: slideInRight 0.3s ease;
            pointer-events: auto;
            backdrop-filter: blur(10px);
        }

        .toast.success { border-left: 4px solid var(--color-success); }
        .toast.error { border-left: 4px solid var(--color-danger); }
        .toast.info { border-left: 4px solid var(--color-info); }
        .toast.warning { border-left: 4px solid var(--color-warning); }

        @keyframes slideInRight {
            from { opacity: 0; transform: translate3d(100%, 0, 0); }
            to { opacity: 1; transform: translate3d(0, 0, 0); }
        }

        .toast.removing {
            animation: slideOutRight 0.3s ease forwards;
        }

        @keyframes slideOutRight {
            to { opacity: 0; transform: translate3d(100%, 0, 0); }
        }

        /* ç»Ÿè®¡é¢æ¿ */
        .stats {
            text-align: center;
            color: white;
            margin-top: 20px;
            display: flex;
            justify-content: space-around;
            animation: fadeIn 1.4s ease;
        }

        .stat-item {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .stat-number {
            font-size: 2em;
            font-weight: 800;
            transition: all var(--transition-normal);
        }

        .stat-number.bump {
            animation: bump 0.3s ease;
        }

        @keyframes bump {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.3); }
        }

        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
        }

        /* Modal æ¨¡æ€æ¡† */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 10000;
            justify-content: center;
            align-items: center;
            padding: 20px;
            backdrop-filter: blur(5px);
        }

        .modal.active {
            display: flex;
            animation: fadeIn 0.3s ease;
        }

        .modal-content {
            background: var(--card-bg);
            border-radius: var(--radius-lg);
            padding: 30px;
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
            animation: slideUp 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translate3d(0, 50px, 0) scale(0.9); }
            to { opacity: 1; transform: translate3d(0, 0, 0) scale(1); }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--card-bg-secondary);
        }

        .modal-title {
            font-size: 1.5em;
            font-weight: 700;
            color: var(--text-primary);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition-fast);
            color: var(--text-secondary);
        }

        .modal-close:hover {
            background: var(--card-bg-secondary);
            color: var(--text-primary);
        }

        .modal-body {
            color: var(--text-primary);
        }

        /* è¯¾ç¨‹é€‰æ‹©å™¨ */
        .course-selector {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .course-card {
            background: var(--card-bg-secondary);
            border-radius: var(--radius-md);
            padding: 20px;
            cursor: pointer;
            transition: all var(--transition-normal);
            border: 2px solid transparent;
        }

        .course-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-md);
            border-color: var(--color-primary);
        }

        .course-card.active {
            border-color: var(--color-success);
            background: linear-gradient(135deg, var(--color-success) 0%, var(--color-secondary-light) 100%);
            color: white;
        }

        .course-name {
            font-size: 1.1em;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .course-info {
            font-size: 0.9em;
            opacity: 0.8;
        }

        /* å­¦ä¹ æ¨¡å¼é€‰æ‹© */
        .mode-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .mode-card {
            background: var(--card-bg-secondary);
            border-radius: var(--radius-md);
            padding: 25px;
            text-align: center;
            cursor: pointer;
            transition: all var(--transition-normal);
            border: 2px solid transparent;
        }

        .mode-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-md);
            border-color: var(--color-primary);
        }

        .mode-icon {
            font-size: 3em;
            margin-bottom: 15px;
        }

        .mode-name {
            font-size: 1.2em;
            font-weight: 600;
            color: var(--text-primary);
        }

        /* æ‹¼å†™ç»ƒä¹ æ ·å¼ */
        .spelling-container {
            background: var(--card-bg);
            border-radius: var(--radius-lg);
            padding: 40px;
            box-shadow: var(--shadow-lg);
        }

        .spelling-input {
            width: 100%;
            padding: 15px 20px;
            font-size: 1.2em;
            border: 2px solid var(--card-bg-secondary);
            border-radius: var(--radius-md);
            transition: all var(--transition-normal);
            text-align: center;
            background: var(--card-bg-secondary);
            color: var(--text-primary);
        }

        .spelling-input:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .spelling-input.correct {
            border-color: var(--color-success);
        }

        .spelling-input.incorrect {
            border-color: var(--color-danger);
            animation: shake 0.5s ease;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-10px); }
            20%, 40%, 60%, 80% { transform: translateX(10px); }
        }

        .letter-hints {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .letter-hint {
            width: 35px;
            height: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--card-bg-secondary);
            border-radius: var(--radius-sm);
            font-size: 1.3em;
            font-weight: 600;
            color: var(--text-primary);
        }

        .letter-hint.hidden {
            opacity: 0.3;
        }

        .feedback-message {
            margin-top: 20px;
            padding: 15px;
            border-radius: var(--radius-md);
            text-align: center;
            font-weight: 600;
        }

        .feedback-success {
            background: linear-gradient(135deg, #4facfe20, #00f2fe20);
            color: var(--color-success);
            border: 2px solid var(--color-success);
        }

        .feedback-error {
            background: linear-gradient(135deg, #fa709a20, #fee14020);
            color: var(--color-danger);
            border: 2px solid var(--color-danger);
        }

        /* ç©ºçŠ¶æ€ */
        .empty-state {
            text-align: center;
            color: white;
            padding: 40px 20px;
        }

        .empty-state-icon {
            font-size: 4em;
            margin-bottom: 20px;
            opacity: 0.8;
        }

        .empty-state-text {
            font-size: 1.2em;
            margin-bottom: 10px;
            font-weight: 600;
        }

        /* åº†ç¥ç‰¹æ•ˆ */
        .celebration {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 4em;
            animation: celebrate 1s ease;
            pointer-events: none;
            z-index: 10000;
        }

        @keyframes celebrate {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0); }
            50% { opacity: 1; transform: translate(-50%, -50%) scale(1.2); }
            100% { opacity: 0; transform: translate(-50%, -50%) scale(0.8) translate3d(0, -100px, 0); }
        }

        .particle-burst {
            position: fixed;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            pointer-events: none;
            z-index: 9998;
        }

        @keyframes burst {
            to {
                transform: translate3d(var(--tx), var(--ty), 0) scale(0);
                opacity: 0;
            }
        }

        .ripple {
            position: fixed;
            border: 3px solid;
            border-radius: 50%;
            pointer-events: none;
            z-index: 9997;
            animation: ripple 1s ease-out forwards;
        }

        @keyframes ripple {
            from { width: 0; height: 0; opacity: 1; }
            to { width: 300px; height: 300px; opacity: 0; }
        }

        .flash {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            z-index: 9996;
            animation: flash 0.3s ease;
        }

        @keyframes flash {
            0%, 100% { opacity: 0; }
            50% { opacity: 0.3; }
        }

        /* é”™è¯¯è¿½è¸ªæ ‡è®° */
        .error-badge {
            display: inline-block;
            background: var(--color-danger);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: 600;
            margin-left: 10px;
        }

        .difficulty-indicator {
            position: absolute;
            top: 20px;
            right: 20px;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9em;
        }

        .difficulty-easy {
            background: #4facfe20;
            color: #4facfe;
            border: 2px solid #4facfe;
        }

        .difficulty-hard {
            background: #fa709a20;
            color: #fa709a;
            border: 2px solid #fa709a;
        }

        .difficulty-master {
            background: #fee14020;
            color: #fee140;
            border: 2px solid #fee140;
        }

        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>âœ¨ èƒŒå•è¯ç¥å™¨ Ultimate</h1>
            <div class="header-controls">
                <button class="header-btn theme-toggle" id="themeToggle">
                    <span id="themeIcon">ğŸŒ™</span>
                </button>
                <button class="header-btn" id="selectCourse">ğŸ“š é€‰æ‹©è¯¾ç¨‹</button>
                <button class="header-btn" id="selectMode">ğŸ¯ å­¦ä¹ æ¨¡å¼</button>
                <button class="header-btn" id="showStatistics">ğŸ“Š ç»Ÿè®¡</button>
                <button class="header-btn" id="reviewDifficult">ğŸ”¥ å¤ä¹ æ˜“é”™è¯</button>
            </div>
        </header>

        <div class="progress-container">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="progress-text" id="progressText">0 / 0 å•è¯</div>
        </div>

        <div class="card-stack" id="cardStack"></div>

        <div class="controls">
            <button class="btn btn-skip" id="btnSkip" title="è·³è¿‡ (â†)">â­ï¸</button>
            <button class="btn btn-unknown" id="btnUnknown" title="ä¸è®¤è¯† (â†“)">â“</button>
            <button class="btn btn-know" id="btnKnow" title="è®¤è¯† (â†’)">âœ…</button>
        </div>

        <div class="stats">
            <div class="stat-item">
                <div class="stat-number" id="knownCount">0</div>
                <div class="stat-label">å·²æŒæ¡</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="unknownCount">0</div>
                <div class="stat-label">å¾…å­¦ä¹ </div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="streakCount">0</div>
                <div class="stat-label">è¿ç»­å¤©æ•°</div>
            </div>
        </div>
    </div>

    <div class="toast-container" id="toastContainer"></div>

    <!-- è¯¾ç¨‹é€‰æ‹©æ¨¡æ€æ¡† -->
    <div class="modal" id="courseModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">ğŸ“š é€‰æ‹©å­¦ä¹ è¯¾ç¨‹</h2>
                <button class="modal-close" id="closeCourseModal">âœ•</button>
            </div>
            <div class="modal-body">
                <div class="course-selector" id="courseList">
                    <p style="text-align: center; padding: 20px;">æ­£åœ¨åŠ è½½è¯¾ç¨‹...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- æ¨¡å¼é€‰æ‹©æ¨¡æ€æ¡† -->
    <div class="modal" id="modeModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">ğŸ¯ é€‰æ‹©å­¦ä¹ æ¨¡å¼</h2>
                <button class="modal-close" id="closeModeModal">âœ•</button>
            </div>
            <div class="modal-body">
                <div class="mode-grid">
                    <div class="mode-card" data-mode="card-flip">
                        <div class="mode-icon">ğŸƒ</div>
                        <div class="mode-name">å¡ç‰‡ç¿»è½¬</div>
                        <p style="margin-top: 10px; font-size: 0.9em; opacity: 0.8;">ç»å…¸å­¦ä¹ æ¨¡å¼</p>
                    </div>
                    <div class="mode-card" data-mode="spelling">
                        <div class="mode-icon">âœï¸</div>
                        <div class="mode-name">æ‹¼å†™ç»ƒä¹ </div>
                        <p style="margin-top: 10px; font-size: 0.9em; opacity: 0.8;">æµ‹è¯•æ‹¼å†™èƒ½åŠ›</p>
                    </div>
                    <div class="mode-card" data-mode="dictation">
                        <div class="mode-icon">ğŸ¤</div>
                        <div class="mode-name">å¬å†™æ¨¡å¼</div>
                        <p style="margin-top: 10px; font-size: 0.9em; opacity: 0.8;">è¯­éŸ³è¯†åˆ«å¬å†™</p>
                    </div>
                    <div class="mode-card" data-mode="quick-review">
                        <div class="mode-icon">âš¡</div>
                        <div class="mode-name">å¿«é€Ÿå¤ä¹ </div>
                        <p style="margin-top: 10px; font-size: 0.9em; opacity: 0.8;">å¿«é€Ÿè¿‡ä¸€é</p>
                    </div>
                    <div class="mode-card" data-mode="random">
                        <div class="mode-icon">ğŸ²</div>
                        <div class="mode-name">éšæœºæ¨¡å¼</div>
                        <p style="margin-top: 10px; font-size: 0.9em; opacity: 0.8;">éšæœºæ‰“ä¹±å­¦ä¹ </p>
                    </div>
                    <div class="mode-card" data-mode="smart-review">
                        <div class="mode-icon">ğŸ§ </div>
                        <div class="mode-name">æ™ºèƒ½å¤ä¹ </div>
                        <p style="margin-top: 10px; font-size: 0.9em; opacity: 0.8;">SM-2ç®—æ³•å¤ä¹ </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        'use strict';

        // ==================== å¢å¼ºå‹ SM-2 ç®—æ³•ï¼ˆå¸¦é”™è¯¯è¿½è¸ªï¼‰====================
        class EnhancedSM2Algorithm {
            static calculate(card, quality) {
                if (!card.sm2) {
                    card.sm2 = {
                        easeFactor: 2.5,
                        interval: 0,
                        repetitions: 0,
                        nextReview: Date.now(),
                        errorCount: 0,
                        consecutiveErrors: 0,
                        lastErrorDate: null,
                        totalReviews: 0
                    };
                }

                const sm2 = card.sm2;
                sm2.totalReviews++;

                // è®°å½•é”™è¯¯
                if (quality < 3) {
                    sm2.errorCount++;
                    sm2.consecutiveErrors++;
                    sm2.lastErrorDate = Date.now();
                } else {
                    sm2.consecutiveErrors = 0;
                }

                // SM-2 ç®—æ³•æ ¸å¿ƒ
                if (quality >= 3) {
                    if (sm2.repetitions === 0) {
                        sm2.interval = 1;
                    } else if (sm2.repetitions === 1) {
                        sm2.interval = 6;
                    } else {
                        sm2.interval = Math.round(sm2.interval * sm2.easeFactor);
                    }
                    sm2.repetitions += 1;
                } else {
                    sm2.repetitions = 0;
                    sm2.interval = 1;
                }

                // æ›´æ–°éš¾åº¦å› å­
                sm2.easeFactor = sm2.easeFactor + (0.1 - (5 - quality) * (0.08 + (5 - quality) * 0.02));

                // éš¾åº¦å› å­æœ€å°å€¼
                if (sm2.easeFactor < 1.3) {
                    sm2.easeFactor = 1.3;
                }

                // å¯¹æ˜“é”™è¯ç¼©çŸ­å¤ä¹ é—´éš”
                if (sm2.errorCount >= 3) {
                    sm2.interval = Math.max(1, Math.floor(sm2.interval * 0.5));
                }

                // è®¡ç®—ä¸‹æ¬¡å¤ä¹ æ—¶é—´
                sm2.nextReview = Date.now() + sm2.interval * 24 * 60 * 60 * 1000;

                return sm2;
            }

            static getDueWords(words) {
                const now = Date.now();
                return words.filter(word => {
                    if (!word.sm2) return true;
                    return word.sm2.nextReview <= now;
                });
            }

            static getDifficultWords(words, threshold = 2) {
                return words.filter(word => {
                    return word.sm2 && word.sm2.errorCount >= threshold;
                }).sort((a, b) => b.sm2.errorCount - a.sm2.errorCount);
            }

            static getWordDifficulty(word) {
                if (!word.sm2) return 'new';

                const errorRate = word.sm2.totalReviews > 0
                    ? word.sm2.errorCount / word.sm2.totalReviews
                    : 0;

                if (word.sm2.repetitions >= 5 && errorRate < 0.2) return 'mastered';
                if (errorRate > 0.5 || word.sm2.errorCount >= 3) return 'hard';
                if (errorRate < 0.3) return 'easy';
                return 'normal';
            }
        }

        // ==================== è¯¾ç¨‹ç®¡ç†å™¨ ====================
        class CourseManager {
            constructor() {
                this.courses = [];
                this.currentCourse = null;
            }

            async detectCourses() {
                // æ¨¡æ‹Ÿæ£€æµ‹ words ç›®å½•ä¸‹çš„ CSV æ–‡ä»¶
                // åœ¨å®é™…ç¯å¢ƒä¸­ï¼Œç”±äºæµè§ˆå™¨å®‰å…¨é™åˆ¶ï¼Œéœ€è¦ç”¨æˆ·æ‰‹åŠ¨é€‰æ‹©æˆ–ä½¿ç”¨æœåŠ¡å™¨API

                const defaultCourses = [
                    {
                        id: 'hz-grade9',
                        name: 'æ­å·åˆä¸‰ä¸Šè‹±è¯­äººæ•™ç‰ˆå•è¯åˆ—è¡¨',
                        path: 'words/æ­å·åˆä¸‰ä¸Šè‹±è¯­äººæ•™ç‰ˆå•è¯åˆ—è¡¨.csv',
                        wordCount: 0,
                        lastStudied: null
                    }
                ];

                this.courses = defaultCourses;
                return this.courses;
            }

            async loadCourse(courseId) {
                const course = this.courses.find(c => c.id === courseId);
                if (!course) {
                    throw new Error('è¯¾ç¨‹ä¸å­˜åœ¨');
                }

                try {
                    const response = await fetch(course.path);
                    const text = await response.text();
                    const words = this.parseCSV(text);

                    course.wordCount = words.length;
                    this.currentCourse = course;

                    return words;
                } catch (error) {
                    console.error('åŠ è½½è¯¾ç¨‹å¤±è´¥:', error);
                    throw error;
                }
            }

            parseCSV(text) {
                const lines = text.trim().split('\n');
                const result = [];

                for (let i = 1; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (!line) continue;

                    const matches = line.match(/(".*?"|[^,]+)/g);
                    if (matches && matches.length >= 4) {
                        const word = matches[0].replace(/^"|"$/g, '').trim();
                        const phonetic = matches[1].replace(/^"|"$/g, '').trim();
                        const meaning = matches[2].replace(/^"|"$/g, '').trim();
                        const example = matches[3].replace(/^"|"$/g, '').trim();

                        if (word && meaning) {
                            result.push({
                                word,
                                phonetic,
                                meaning,
                                example,
                                id: `word_${i}_${Date.now()}`
                            });
                        }
                    }
                }

                return result;
            }
        }

        // ==================== å­¦ä¹ æ¨¡å¼åŸºç±» ====================
        class LearningMode {
            constructor(container, words, app, startIndex = 0) {
                this.container = container;
                this.words = words;
                this.app = app;
                // ç»§æ‰¿åº”ç”¨çš„å½“å‰è¿›åº¦ï¼Œè€Œä¸æ˜¯æ€»ä»0å¼€å§‹
                this.currentIndex = startIndex;
                console.log(`ğŸ“– å­¦ä¹ æ¨¡å¼åˆå§‹åŒ– - ä»ç¬¬ ${startIndex + 1} ä¸ªå•è¯å¼€å§‹`);
            }

            start() {
                throw new Error('å­ç±»å¿…é¡»å®ç° start æ–¹æ³•');
            }

            stop() {
                this.container.innerHTML = '';
            }

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
        }

        // ==================== æ‹¼å†™ç»ƒä¹ æ¨¡å¼ ====================
        class SpellingMode extends LearningMode {
            constructor(container, words, app) {
                super(container, words, app);
                this.attempts = 0;
                this.correctCount = 0;
            }

            start() {
                if (this.currentIndex >= this.words.length) {
                    this.showCompletion();
                    return;
                }

                const word = this.words[this.currentIndex];
                this.attempts = 0;

                const html = `
                    <div class="spelling-container">
                        <h2 style="text-align: center; margin-bottom: 20px; color: var(--text-primary);">
                            âœï¸ æ‹¼å†™ç»ƒä¹  (${this.currentIndex + 1}/${this.words.length})
                        </h2>

                        <div style="text-align: center; margin-bottom: 30px;">
                            <div class="phonetic" style="font-size: 1.3em; margin-bottom: 15px;">${this.escapeHtml(word.phonetic)}</div>
                            <div class="meaning" style="font-size: 1.4em; color: var(--color-primary);">${this.escapeHtml(word.meaning)}</div>
                            ${word.example ? `<div class="example" style="margin-top: 15px; opacity: 0.8;">"${this.escapeHtml(word.example)}"</div>` : ''}
                        </div>

                        <div class="letter-hints" id="letterHints">
                            ${this.generateHints(word.word)}
                        </div>

                        <input type="text"
                               class="spelling-input"
                               id="spellingInput"
                               placeholder="è¾“å…¥å•è¯æ‹¼å†™..."
                               autocomplete="off"
                               autocapitalize="off"
                               spellcheck="false">

                        <div id="feedback"></div>

                        <div style="display: flex; justify-content: center; gap: 15px; margin-top: 25px;">
                            <button class="header-btn" id="checkSpelling">âœ… æ£€æŸ¥</button>
                            <button class="header-btn" id="showHint">ğŸ’¡ æç¤º</button>
                            <button class="header-btn" id="speakWord">ğŸ”Š å‘éŸ³</button>
                            <button class="header-btn" id="skipSpelling">â­ï¸ è·³è¿‡</button>
                        </div>
                    </div>
                `;

                this.container.innerHTML = html;

                const input = document.getElementById('spellingInput');
                input.focus();

                document.getElementById('checkSpelling').addEventListener('click', () => this.checkAnswer());
                document.getElementById('showHint').addEventListener('click', () => this.showHint());
                document.getElementById('speakWord').addEventListener('click', () => this.app.tts.speak(word.word));
                document.getElementById('skipSpelling').addEventListener('click', () => this.skip());

                input.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        this.checkAnswer();
                    }
                });

                input.addEventListener('input', (e) => {
                    const value = e.target.value.toLowerCase();
                    const target = word.word.toLowerCase();

                    let isCorrect = true;
                    for (let i = 0; i < value.length; i++) {
                        if (value[i] !== target[i]) {
                            isCorrect = false;
                            break;
                        }
                    }

                    if (isCorrect && value.length > 0) {
                        input.classList.add('correct');
                        input.classList.remove('incorrect');
                    } else if (value.length > 0) {
                        input.classList.add('incorrect');
                        input.classList.remove('correct');
                    }
                });

                // è‡ªåŠ¨æ’­æ”¾å‘éŸ³
                this.app.tts.speak(word.word);
            }

            generateHints(word) {
                return word.split('').map((letter, index) => {
                    const show = index === 0 || index === word.length - 1 || Math.random() < 0.2;
                    return `<div class="letter-hint ${show ? '' : 'hidden'}">${show ? letter : '_'}</div>`;
                }).join('');
            }

            checkAnswer() {
                const input = document.getElementById('spellingInput');
                const value = input.value.trim().toLowerCase();
                const word = this.words[this.currentIndex];
                const target = word.word.toLowerCase();
                const feedback = document.getElementById('feedback');

                this.attempts++;

                if (value === target) {
                    this.correctCount++;

                    feedback.innerHTML = `
                        <div class="feedback-success">
                            <span style="font-size: 2em;">ğŸ‰</span>
                            <div style="margin-top: 10px;">æ­£ç¡®ï¼ç”¨äº† ${this.attempts} æ¬¡å°è¯•</div>
                        </div>
                    `;

                    input.disabled = true;

                    // è®°å½•ä¸ºæ­£ç¡®
                    this.app.recordStudy(word, true, this.attempts);

                    setTimeout(() => {
                        this.currentIndex++;
                        this.start();
                    }, 1500);
                } else {
                    feedback.innerHTML = `
                        <div class="feedback-error">
                            <span style="font-size: 2em;">âŒ</span>
                            <div style="margin-top: 10px;">ä¸æ­£ç¡®ï¼Œå†è¯•ä¸€æ¬¡ï¼</div>
                        </div>
                    `;

                    if (this.attempts >= 3) {
                        feedback.innerHTML = `
                            <div class="feedback-error">
                                <span style="font-size: 2em;">ğŸ˜…</span>
                                <div style="margin-top: 10px;">æ­£ç¡®ç­”æ¡ˆæ˜¯: <strong>${word.word}</strong></div>
                            </div>
                        `;

                        input.disabled = true;

                        // è®°å½•ä¸ºé”™è¯¯
                        this.app.recordStudy(word, false, this.attempts);

                        setTimeout(() => {
                            this.currentIndex++;
                            this.start();
                        }, 2500);
                    } else {
                        input.value = '';
                        input.focus();
                    }
                }
            }

            showHint() {
                const input = document.getElementById('spellingInput');
                const word = this.words[this.currentIndex];
                const currentValue = input.value.toLowerCase();
                const target = word.word.toLowerCase();

                if (currentValue.length < target.length) {
                    input.value = target.substring(0, currentValue.length + 1);
                    input.focus();
                }
            }

            skip() {
                const word = this.words[this.currentIndex];
                this.app.recordStudy(word, false, this.attempts);
                this.currentIndex++;
                this.start();
            }

            showCompletion() {
                const rate = this.words.length > 0 ? (this.correctCount / this.words.length * 100).toFixed(1) : 0;

                this.container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸŠ</div>
                        <div class="empty-state-text">æ‹¼å†™ç»ƒä¹ å®Œæˆï¼</div>
                        <div style="margin-top: 20px; font-size: 1.1em;">
                            <p>æ­£ç¡®ç‡: <strong>${rate}%</strong></p>
                            <p style="margin-top: 10px;">æ­£ç¡®: ${this.correctCount} / ${this.words.length}</p>
                        </div>
                        <button class="header-btn" id="backToMain" style="margin-top: 30px;">è¿”å›ä¸»ç•Œé¢</button>
                    </div>
                `;

                document.getElementById('backToMain').addEventListener('click', () => {
                    this.app.switchMode('card-flip');
                });
            }
        }

        // ==================== å¿«é€Ÿå¤ä¹ æ¨¡å¼ ====================
        class QuickReviewMode extends LearningMode {
            constructor(container, words, app) {
                super(container, words, app);
                this.knownCount = 0;
                this.unknownCount = 0;
            }

            start() {
                if (this.currentIndex >= this.words.length) {
                    this.showCompletion();
                    return;
                }

                const word = this.words[this.currentIndex];

                const html = `
                    <div class="spelling-container">
                        <h2 style="text-align: center; margin-bottom: 20px; color: var(--text-primary);">
                            âš¡ å¿«é€Ÿå¤ä¹  (${this.currentIndex + 1}/${this.words.length})
                        </h2>

                        <div style="text-align: center;">
                            <div class="word-main" style="font-size: 3em; margin-bottom: 20px;">${this.escapeHtml(word.word)}</div>
                            <div class="phonetic" style="font-size: 1.3em; margin-bottom: 20px;">${this.escapeHtml(word.phonetic)}</div>

                            <div style="margin: 30px 0;">
                                <h3 style="color: var(--text-primary); margin-bottom: 15px;">ä½ è®¤è¯†è¿™ä¸ªå•è¯å—ï¼Ÿ</h3>
                            </div>

                            <div style="display: flex; justify-content: center; gap: 20px; margin-bottom: 30px;">
                                <button class="btn btn-know" id="quickKnow" style="width: 100px; height: 100px;">
                                    âœ…<br>è®¤è¯†
                                </button>
                                <button class="btn btn-unknown" id="quickUnknown" style="width: 100px; height: 100px;">
                                    â“<br>ä¸è®¤è¯†
                                </button>
                            </div>

                            <div id="answerReveal" style="display: none; animation: fadeIn 0.5s;">
                                <div class="meaning" style="font-size: 1.4em; color: var(--color-primary); margin-bottom: 15px;">${this.escapeHtml(word.meaning)}</div>
                                ${word.example ? `<div class="example">"${this.escapeHtml(word.example)}"</div>` : ''}
                            </div>
                        </div>
                    </div>
                `;

                this.container.innerHTML = html;

                document.getElementById('quickKnow').addEventListener('click', () => this.answer(true));
                document.getElementById('quickUnknown').addEventListener('click', () => this.answer(false));

                // è‡ªåŠ¨æ’­æ”¾
                setTimeout(() => {
                    this.app.tts.speak(word.word);
                }, 300);
            }

            answer(known) {
                const word = this.words[this.currentIndex];

                if (known) {
                    this.knownCount++;
                } else {
                    this.unknownCount++;
                }

                // æ˜¾ç¤ºç­”æ¡ˆ
                const reveal = document.getElementById('answerReveal');
                reveal.style.display = 'block';

                // ç¦ç”¨æŒ‰é’®
                document.getElementById('quickKnow').disabled = true;
                document.getElementById('quickUnknown').disabled = true;

                // è®°å½•å­¦ä¹ 
                this.app.recordStudy(word, known, 1);

                setTimeout(() => {
                    this.currentIndex++;
                    this.start();
                }, 1500);
            }

            showCompletion() {
                const rate = this.words.length > 0 ? (this.knownCount / this.words.length * 100).toFixed(1) : 0;

                this.container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">âš¡</div>
                        <div class="empty-state-text">å¿«é€Ÿå¤ä¹ å®Œæˆï¼</div>
                        <div style="margin-top: 20px; font-size: 1.1em;">
                            <p>è®¤è¯†ç‡: <strong>${rate}%</strong></p>
                            <p style="margin-top: 10px;">è®¤è¯†: ${this.knownCount} / ä¸è®¤è¯†: ${this.unknownCount}</p>
                        </div>
                        <button class="header-btn" id="backToMain" style="margin-top: 30px;">è¿”å›ä¸»ç•Œé¢</button>
                    </div>
                `;

                document.getElementById('backToMain').addEventListener('click', () => {
                    this.app.switchMode('card-flip');
                });
            }
        }

        // ==================== å¬å†™æ¨¡å¼ ====================
        class DictationMode extends LearningMode {
            constructor(container, words, app) {
                super(container, words, app);
                this.correctCount = 0;
                this.recognition = null;
                this.initSpeechRecognition();
            }

            initSpeechRecognition() {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                if (SpeechRecognition) {
                    this.recognition = new SpeechRecognition();
                    this.recognition.continuous = false;
                    this.recognition.interimResults = false;
                    this.recognition.lang = 'en-US';
                }
            }

            start() {
                if (this.currentIndex >= this.words.length) {
                    this.showCompletion();
                    return;
                }

                const word = this.words[this.currentIndex];

                const html = `
                    <div class="spelling-container">
                        <h2 style="text-align: center; margin-bottom: 20px; color: var(--text-primary);">
                            ğŸ¤ å¬å†™æ¨¡å¼ (${this.currentIndex + 1}/${this.words.length})
                        </h2>

                        <div style="text-align: center; margin-bottom: 30px;">
                            <div style="font-size: 4em; margin-bottom: 20px;">ğŸ”Š</div>
                            <p style="color: var(--text-secondary);">å¬å•è¯å‘éŸ³ï¼Œè¾“å…¥æ­£ç¡®çš„æ‹¼å†™</p>
                        </div>

                        <input type="text"
                               class="spelling-input"
                               id="dictationInput"
                               placeholder="è¾“å…¥ä½ å¬åˆ°çš„å•è¯..."
                               autocomplete="off"
                               autocapitalize="off"
                               spellcheck="false">

                        <div id="feedback"></div>

                        <div style="display: flex; justify-content: center; gap: 15px; margin-top: 25px;">
                            ${this.recognition ? '<button class="header-btn" id="startListening">ğŸ¤ å¼€å§‹å¬å†™</button>' : ''}
                            <button class="header-btn" id="playAgain">ğŸ”Š å†å¬ä¸€æ¬¡</button>
                            <button class="header-btn" id="checkDictation">âœ… æ£€æŸ¥</button>
                            <button class="header-btn" id="skipDictation">â­ï¸ è·³è¿‡</button>
                        </div>
                    </div>
                `;

                this.container.innerHTML = html;

                const input = document.getElementById('dictationInput');
                input.focus();

                if (this.recognition) {
                    document.getElementById('startListening').addEventListener('click', () => this.startListening());

                    this.recognition.onresult = (event) => {
                        const transcript = event.results[0][0].transcript.toLowerCase().trim();
                        input.value = transcript;
                        this.checkAnswer();
                    };

                    this.recognition.onerror = (event) => {
                        console.error('è¯†åˆ«é”™è¯¯:', event.error);
                        this.app.ui.showToast('è¯­éŸ³è¯†åˆ«å‡ºé”™ï¼Œè¯·é‡è¯•', 'error');
                    };
                }

                document.getElementById('playAgain').addEventListener('click', () => this.app.tts.speak(word.word));
                document.getElementById('checkDictation').addEventListener('click', () => this.checkAnswer());
                document.getElementById('skipDictation').addEventListener('click', () => this.skip());

                input.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        this.checkAnswer();
                    }
                });

                // è‡ªåŠ¨æ’­æ”¾
                setTimeout(() => {
                    this.app.tts.speak(word.word);
                }, 500);
            }

            startListening() {
                if (!this.recognition) return;

                try {
                    this.recognition.start();
                    this.app.ui.showToast('æ­£åœ¨å¬å†™...', 'info');
                } catch (error) {
                    console.error('å¯åŠ¨è¯†åˆ«å¤±è´¥:', error);
                }
            }

            checkAnswer() {
                const input = document.getElementById('dictationInput');
                const value = input.value.trim().toLowerCase();
                const word = this.words[this.currentIndex];
                const target = word.word.toLowerCase();
                const feedback = document.getElementById('feedback');

                if (value === target) {
                    this.correctCount++;

                    feedback.innerHTML = `
                        <div class="feedback-success">
                            <span style="font-size: 2em;">ğŸ‰</span>
                            <div style="margin-top: 10px;">æ­£ç¡®ï¼</div>
                            <div style="margin-top: 10px; font-size: 0.9em; opacity: 0.8;">${word.meaning}</div>
                        </div>
                    `;

                    input.disabled = true;
                    this.app.recordStudy(word, true, 1);

                    setTimeout(() => {
                        this.currentIndex++;
                        this.start();
                    }, 1500);
                } else if (value) {
                    feedback.innerHTML = `
                        <div class="feedback-error">
                            <span style="font-size: 2em;">âŒ</span>
                            <div style="margin-top: 10px;">ä¸æ­£ç¡®ï¼Œæ­£ç¡®ç­”æ¡ˆæ˜¯: <strong>${word.word}</strong></div>
                            <div style="margin-top: 10px; font-size: 0.9em; opacity: 0.8;">${word.meaning}</div>
                        </div>
                    `;

                    input.disabled = true;
                    this.app.recordStudy(word, false, 1);

                    setTimeout(() => {
                        this.currentIndex++;
                        this.start();
                    }, 2500);
                }
            }

            skip() {
                const word = this.words[this.currentIndex];
                this.app.recordStudy(word, false, 0);
                this.currentIndex++;
                this.start();
            }

            showCompletion() {
                const rate = this.words.length > 0 ? (this.correctCount / this.words.length * 100).toFixed(1) : 0;

                this.container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ¤</div>
                        <div class="empty-state-text">å¬å†™å®Œæˆï¼</div>
                        <div style="margin-top: 20px; font-size: 1.1em;">
                            <p>æ­£ç¡®ç‡: <strong>${rate}%</strong></p>
                            <p style="margin-top: 10px;">æ­£ç¡®: ${this.correctCount} / ${this.words.length}</p>
                        </div>
                        <button class="header-btn" id="backToMain" style="margin-top: 30px;">è¿”å›ä¸»ç•Œé¢</button>
                    </div>
                `;

                document.getElementById('backToMain').addEventListener('click', () => {
                    this.app.switchMode('card-flip');
                });
            }
        }

        // ==================== å­˜å‚¨ç®¡ç†å™¨ ====================
        class StorageManager {
            constructor() {
                this.prefix = 'wordapp_ultimate_';
            }

            get(key) {
                try {
                    const value = localStorage.getItem(this.prefix + key);
                    return value ? JSON.parse(value) : null;
                } catch (error) {
                    console.error('è¯»å–å­˜å‚¨å¤±è´¥:', error);
                    return null;
                }
            }

            set(key, value) {
                try {
                    localStorage.setItem(this.prefix + key, JSON.stringify(value));
                } catch (error) {
                    console.error('ä¿å­˜å­˜å‚¨å¤±è´¥:', error);
                }
            }

            remove(key) {
                try {
                    localStorage.removeItem(this.prefix + key);
                } catch (error) {
                    console.error('åˆ é™¤å­˜å‚¨å¤±è´¥:', error);
                }
            }
        }

        // ==================== UIç®¡ç†å™¨ ====================
        class UIManager {
            constructor(app) {
                this.app = app;
                this.dragState = {
                    isDragging: false,
                    startX: 0,
                    startY: 0,
                    currentX: 0,
                    currentY: 0,
                    rafId: null
                };
            }

            init() {
                this.initCards();
                this.updateProgress();
            }

            initCards() {
                const cardStack = document.getElementById('cardStack');
                cardStack.innerHTML = '';
                this.app.state.cards = [];

                const words = this.app.state.words;
                const startIndex = this.app.state.currentIndex;

                if (startIndex >= words.length) {
                    this.showEmptyState();
                    return;
                }

                const renderCount = Math.min(3, words.length - startIndex);

                for (let i = 0; i < renderCount; i++) {
                    const wordIndex = startIndex + i;
                    const card = this.createCard(words[wordIndex], i);
                    this.app.state.cards.push(card);
                    cardStack.appendChild(card);
                }

                if (this.app.state.settings.autoPlay && words[startIndex]) {
                    this.app.tts.speak(words[startIndex].word);
                }
            }

            createCard(wordData, index) {
                const card = document.createElement('div');
                card.className = 'card';
                card.style.zIndex = 100 - index;
                card.style.transform = `translate3d(0, ${index * 10}px, 0) scale(${1 - index * 0.05})`;

                const difficulty = EnhancedSM2Algorithm.getWordDifficulty(wordData);
                const difficultyBadge = difficulty === 'hard' ? '<div class="difficulty-indicator difficulty-hard">æ˜“é”™è¯</div>' : '';

                card.innerHTML = `
                    <div class="card-inner">
                        ${difficultyBadge}
                        <div class="card-face card-front">
                            <div class="word-main">${this.escapeHtml(wordData.word)}</div>
                            <div class="phonetic">${this.escapeHtml(wordData.phonetic)}</div>
                            <button class="sound-btn" data-word="${this.escapeHtml(wordData.word)}">
                                ğŸ”Š å‘éŸ³
                            </button>
                            <div class="tap-hint">ğŸ‘† ç‚¹å‡»å¡ç‰‡æŸ¥çœ‹é‡Šä¹‰</div>
                        </div>
                        <div class="card-face card-back">
                            <div class="meaning">${this.escapeHtml(wordData.meaning)}</div>
                            <div class="example">${this.escapeHtml(wordData.example)}</div>
                            ${wordData.sm2 && wordData.sm2.errorCount > 0 ? `<div class="error-badge">é”™è¯¯ ${wordData.sm2.errorCount} æ¬¡</div>` : ''}
                        </div>
                    </div>
                `;

                const cardInner = card.querySelector('.card-inner');
                const soundBtn = card.querySelector('.sound-btn');

                cardInner.addEventListener('click', (e) => {
                    if (e.target.tagName !== 'BUTTON' && !card.classList.contains('dragging')) {
                        this.flipCard(cardInner);
                    }
                });

                soundBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const word = e.target.getAttribute('data-word');
                    this.app.tts.speak(word);
                });

                if (index === 0) {
                    this.setupDragHandlers(card);
                }

                return card;
            }

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            flipCard(cardInner) {
                cardInner.classList.toggle('flipped');
                this.app.vibrate([10]);
            }

            setupDragHandlers(card) {
                const startDrag = (e) => {
                    if (e.target.tagName === 'BUTTON') return;

                    this.dragState.isDragging = true;
                    card.classList.add('dragging');

                    const touch = e.touches ? e.touches[0] : e;
                    this.dragState.startX = touch.clientX;
                    this.dragState.startY = touch.clientY;

                    document.addEventListener('mousemove', onDrag, { passive: true });
                    document.addEventListener('touchmove', onDrag, { passive: true });
                    document.addEventListener('mouseup', endDrag);
                    document.addEventListener('touchend', endDrag);
                };

                const onDrag = (e) => {
                    if (!this.dragState.isDragging) return;

                    const touch = e.touches ? e.touches[0] : e;
                    this.dragState.currentX = touch.clientX - this.dragState.startX;
                    this.dragState.currentY = touch.clientY - this.dragState.startY;

                    if (this.dragState.rafId) {
                        cancelAnimationFrame(this.dragState.rafId);
                    }

                    this.dragState.rafId = requestAnimationFrame(() => {
                        const rotation = this.dragState.currentX * 0.1;
                        const opacity = 1 - Math.abs(this.dragState.currentX) / 300;
                        card.style.transform = `translate3d(${this.dragState.currentX}px, ${this.dragState.currentY}px, 0) rotate(${rotation}deg)`;
                        card.style.opacity = opacity;
                    });
                };

                const endDrag = () => {
                    if (!this.dragState.isDragging) return;

                    this.dragState.isDragging = false;
                    card.classList.remove('dragging');

                    if (this.dragState.rafId) {
                        cancelAnimationFrame(this.dragState.rafId);
                        this.dragState.rafId = null;
                    }

                    document.removeEventListener('mousemove', onDrag);
                    document.removeEventListener('touchmove', onDrag);
                    document.removeEventListener('mouseup', endDrag);
                    document.removeEventListener('touchend', endDrag);

                    const threshold = 100;
                    if (Math.abs(this.dragState.currentX) > threshold) {
                        if (this.dragState.currentX > 0) {
                            this.app.handleKnow();
                        } else {
                            this.app.handleUnknown();
                        }
                    } else {
                        card.style.transition = 'transform 0.3s ease, opacity 0.3s ease';
                        card.style.transform = `translate3d(0, 0, 0) scale(1)`;
                        card.style.opacity = 1;

                        setTimeout(() => {
                            card.style.transition = '';
                        }, 300);
                    }

                    this.dragState.currentX = 0;
                    this.dragState.currentY = 0;
                };

                card.addEventListener('mousedown', startDrag);
                card.addEventListener('touchstart', startDrag, { passive: true });
            }

            removeCurrentCard(direction) {
                if (this.app.state.currentIndex >= this.app.state.words.length) return;

                const card = this.app.state.cards[0];
                if (!card) return;

                card.style.pointerEvents = 'none';

                if (direction === 'left') {
                    card.classList.add('swipe-left');
                } else if (direction === 'right') {
                    card.classList.add('swipe-right');
                }

                setTimeout(() => {
                    this.app.state.currentIndex++;
                    this.app.saveProgress();
                    this.updateProgress();

                    if (card.parentNode) {
                        card.parentNode.removeChild(card);
                    }
                    this.app.state.cards.shift();

                    this.app.state.cards.forEach((remainingCard, i) => {
                        remainingCard.style.zIndex = 100 - i;
                        remainingCard.style.transform = `translate3d(0, ${i * 10}px, 0) scale(${1 - i * 0.05})`;
                    });

                    const nextIndex = this.app.state.currentIndex + this.app.state.cards.length;
                    if (nextIndex < this.app.state.words.length) {
                        const newCard = this.createCard(
                            this.app.state.words[nextIndex],
                            this.app.state.cards.length
                        );
                        this.app.state.cards.push(newCard);
                        document.getElementById('cardStack').appendChild(newCard);
                    }

                    if (this.app.state.currentIndex < this.app.state.words.length) {
                        if (this.app.state.settings.autoPlay) {
                            setTimeout(() => {
                                this.app.tts.speak(this.app.state.words[this.app.state.currentIndex].word);
                            }, 300);
                        }

                        if (this.app.state.cards[0]) {
                            this.setupDragHandlers(this.app.state.cards[0]);
                        }
                    } else {
                        setTimeout(() => {
                            this.showCompletionScreen();
                        }, 500);
                    }
                }, 500);
            }

            updateProgress() {
                const total = this.app.state.words.length;
                const current = this.app.state.currentIndex;
                const progress = total > 0 ? (current / total) * 100 : 0;

                document.getElementById('progressFill').style.width = progress + '%';
                document.getElementById('progressText').textContent = `${current} / ${total} å•è¯`;
                document.getElementById('knownCount').textContent = this.app.state.knownCount;
                document.getElementById('unknownCount').textContent = this.app.state.unknownCount;
            }

            bumpNumber(elementId) {
                const element = document.getElementById(elementId);
                if (element) {
                    element.classList.add('bump');
                    setTimeout(() => element.classList.remove('bump'), 300);
                }
            }

            showEmptyState() {
                const cardStack = document.getElementById('cardStack');
                cardStack.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ“š</div>
                        <div class="empty-state-text">æš‚æ— å•è¯</div>
                        <div style="opacity: 0.8; margin-top: 10px;">è¯·é€‰æ‹©è¯¾ç¨‹å¼€å§‹å­¦ä¹ </div>
                    </div>
                `;
            }

            showCompletionScreen() {
                this.app.effects.showCelebration('ğŸ‰');

                const message = `ğŸ‰ æ­å–œå®Œæˆå­¦ä¹ !\n\nâœ… å·²æŒæ¡: ${this.app.state.knownCount}\nğŸ“– å¾…å­¦ä¹ : ${this.app.state.unknownCount}`;

                this.showToast(message, 'success');

                setTimeout(() => {
                    this.showEmptyState();
                }, 2000);
            }

            showToast(message, type = 'info') {
                const container = document.getElementById('toastContainer');
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;

                const icons = {
                    success: 'âœ…',
                    error: 'âŒ',
                    warning: 'âš ï¸',
                    info: 'â„¹ï¸'
                };

                toast.innerHTML = `
                    <span style="font-size: 1.5em;">${icons[type] || icons.info}</span>
                    <span style="flex: 1;">${this.escapeHtml(message).replace(/\n/g, '<br>')}</span>
                `;

                container.appendChild(toast);

                setTimeout(() => {
                    toast.classList.add('removing');
                    setTimeout(() => {
                        if (toast.parentNode) {
                            toast.parentNode.removeChild(toast);
                        }
                    }, 300);
                }, 3000);
            }
        }

        // ==================== ç‰¹æ•ˆç®¡ç†å™¨ ====================
        class EffectsManager {
            createParticles(count) {
                for (let i = 0; i < count; i++) {
                    const particle = document.createElement('div');
                    particle.className = 'particle';
                    const size = Math.random() * 60 + 20;
                    particle.style.width = size + 'px';
                    particle.style.height = size + 'px';
                    particle.style.left = Math.random() * 100 + '%';
                    particle.style.animationDelay = Math.random() * 15 + 's';
                    particle.style.animationDuration = (Math.random() * 10 + 10) + 's';
                    document.body.appendChild(particle);
                }
            }

            createParticleBurst(x, y, color) {
                const particleCount = 15;
                for (let i = 0; i < particleCount; i++) {
                    const particle = document.createElement('div');
                    particle.className = 'particle-burst';
                    particle.style.left = x + 'px';
                    particle.style.top = y + 'px';
                    particle.style.background = color;

                    const angle = (Math.PI * 2 * i) / particleCount;
                    const velocity = 80 + Math.random() * 80;
                    const tx = Math.cos(angle) * velocity;
                    const ty = Math.sin(angle) * velocity;

                    particle.style.setProperty('--tx', tx + 'px');
                    particle.style.setProperty('--ty', ty + 'px');
                    particle.style.animation = 'burst 0.8s ease-out forwards';

                    document.body.appendChild(particle);
                    setTimeout(() => {
                        if (particle.parentNode) {
                            particle.parentNode.removeChild(particle);
                        }
                    }, 800);
                }
            }

            createRipple(x, y, color) {
                const ripple = document.createElement('div');
                ripple.className = 'ripple';
                ripple.style.left = (x - 150) + 'px';
                ripple.style.top = (y - 150) + 'px';
                ripple.style.borderColor = color;
                document.body.appendChild(ripple);
                setTimeout(() => {
                    if (ripple.parentNode) {
                        ripple.parentNode.removeChild(ripple);
                    }
                }, 1000);
            }

            createFlash(color) {
                const flash = document.createElement('div');
                flash.className = 'flash';
                flash.style.background = color;
                document.body.appendChild(flash);
                setTimeout(() => {
                    if (flash.parentNode) {
                        flash.parentNode.removeChild(flash);
                    }
                }, 300);
            }

            showCelebration(emoji) {
                const celebration = document.createElement('div');
                celebration.className = 'celebration';
                celebration.textContent = emoji;
                document.body.appendChild(celebration);
                setTimeout(() => {
                    if (celebration.parentNode) {
                        celebration.parentNode.removeChild(celebration);
                    }
                }, 1000);
            }
        }

        // ==================== è¯­éŸ³æœåŠ¡ ====================
        class TTSService {
            constructor() {
                this.synth = window.speechSynthesis;
                this.isSpeaking = false;
            }

            speak(word) {
                if (!this.synth) return;

                this.synth.cancel();

                try {
                    const utterance = new SpeechSynthesisUtterance(word);
                    utterance.lang = 'en-US';
                    utterance.rate = 0.8;
                    utterance.pitch = 1.0;

                    utterance.onstart = () => {
                        this.isSpeaking = true;
                    };

                    utterance.onend = () => {
                        this.isSpeaking = false;
                    };

                    utterance.onerror = (e) => {
                        console.error('è¯­éŸ³æ’­æ”¾å¤±è´¥:', e);
                        this.isSpeaking = false;
                    };

                    this.synth.speak(utterance);
                } catch (error) {
                    console.error('è¯­éŸ³æ’­æ”¾å‡ºé”™:', error);
                }
            }

            cancel() {
                if (this.synth) {
                    this.synth.cancel();
                    this.isSpeaking = false;
                }
            }
        }

        // ==================== ä¸»åº”ç”¨ç±» ====================
        class WordLearningApp {
            constructor() {
                this.state = {
                    words: [],
                    currentIndex: 0,
                    knownCount: 0,
                    unknownCount: 0,
                    cards: [],
                    theme: 'light',
                    currentMode: 'card-flip',
                    currentCourse: null,
                    settings: {
                        autoPlay: true,
                        vibration: true,
                        particleCount: 10
                    }
                };

                this.storage = new StorageManager();
                this.ui = new UIManager(this);
                this.effects = new EffectsManager();
                this.tts = new TTSService();
                this.courseManager = new CourseManager();
                this.currentModeInstance = null;

                this.init();
            }

            async init() {
                try {
                    console.log('ğŸš€ åº”ç”¨åˆå§‹åŒ–å¼€å§‹...');

                    // 1. é¦–å…ˆè®¾ç½®äº‹ä»¶ç›‘å¬å™¨ï¼ˆå¿…é¡»æœ€å…ˆæ‰§è¡Œï¼‰
                    this.setupEventListeners();
                    console.log('âœ“ äº‹ä»¶ç›‘å¬å™¨å·²è®¾ç½®');

                    // 2. åŠ è½½ä¸»é¢˜
                    const savedTheme = this.storage.get('theme') || 'light';
                    this.setTheme(savedTheme);
                    console.log('âœ“ ä¸»é¢˜å·²åŠ è½½:', savedTheme);

                    // 3. åˆ›å»ºç²’å­èƒŒæ™¯
                    this.effects.createParticles(this.state.settings.particleCount);
                    console.log('âœ“ ç²’å­æ•ˆæœå·²åˆ›å»º');

                    // 4. æ›´æ–°è¿ç»­å¤©æ•°
                    this.updateStreak();
                    console.log('âœ“ è¿ç»­å¤©æ•°å·²æ›´æ–°');

                    // 5. æ£€æµ‹å¹¶åŠ è½½è¯¾ç¨‹
                    await this.courseManager.detectCourses();
                    console.log('âœ“ è¯¾ç¨‹æ£€æµ‹å®Œæˆï¼Œå…±', this.courseManager.courses.length, 'ä¸ªè¯¾ç¨‹');

                    // 6. åŠ è½½ä¸Šæ¬¡çš„è¯¾ç¨‹
                    const lastCourseId = this.storage.get('lastCourse');
                    if (lastCourseId) {
                        console.log('å°è¯•åŠ è½½ä¸Šæ¬¡è¯¾ç¨‹:', lastCourseId);
                        try {
                            await this.loadCourse(lastCourseId);
                        } catch (error) {
                            console.error('åŠ è½½ä¸Šæ¬¡è¯¾ç¨‹å¤±è´¥:', error);
                            this.showCourseSelector();
                        }
                    } else {
                        console.log('é¦–æ¬¡ä½¿ç”¨ï¼Œæ˜¾ç¤ºè¯¾ç¨‹é€‰æ‹©å™¨');
                        this.showCourseSelector();
                    }

                    console.log('âœ… åº”ç”¨åˆå§‹åŒ–å®Œæˆï¼');

                } catch (error) {
                    console.error('âŒ åˆå§‹åŒ–å¤±è´¥:', error);
                    this.ui.showToast('åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•', 'error');
                }
            }

            async loadCourse(courseId) {
                try {
                    const words = await this.courseManager.loadCourse(courseId);

                    // åŠ è½½SM-2æ•°æ®
                    const savedWords = this.storage.get(`words_${courseId}`) || [];
                    const wordMap = new Map(savedWords.map(w => [w.word, w]));

                    // åˆå¹¶æ•°æ®
                    this.state.words = words.map(word => {
                        const saved = wordMap.get(word.word);
                        if (saved && saved.sm2) {
                            word.sm2 = saved.sm2;
                        }
                        return word;
                    });

                    this.state.currentCourse = courseId;
                    this.storage.set('lastCourse', courseId);

                    // åŠ è½½è¿›åº¦
                    const progress = this.storage.get(`progress_${courseId}`);
                    if (progress) {
                        this.state.currentIndex = Math.min(progress.currentIndex || 0, this.state.words.length);
                        this.state.knownCount = progress.knownCount || 0;
                        this.state.unknownCount = progress.unknownCount || 0;
                    }

                    this.ui.init();

                    this.ui.showToast(`è¯¾ç¨‹åŠ è½½æˆåŠŸï¼å…± ${this.state.words.length} ä¸ªå•è¯`, 'success');

                    if (this.state.settings.autoPlay && this.state.words.length > 0) {
                        setTimeout(() => {
                            if (this.state.currentIndex < this.state.words.length) {
                                this.tts.speak(this.state.words[this.state.currentIndex].word);
                            }
                        }, 500);
                    }

                } catch (error) {
                    console.error('åŠ è½½è¯¾ç¨‹å¤±è´¥:', error);
                    this.ui.showToast('åŠ è½½è¯¾ç¨‹å¤±è´¥', 'error');
                }
            }

            showCourseSelector() {
                console.log('ğŸ“š æ˜¾ç¤ºè¯¾ç¨‹é€‰æ‹©å™¨...');

                const modal = document.getElementById('courseModal');
                if (!modal) {
                    console.error('âŒ è¯¾ç¨‹æ¨¡æ€æ¡†å…ƒç´ ä¸å­˜åœ¨');
                    return;
                }

                const list = document.getElementById('courseList');
                if (!list) {
                    console.error('âŒ è¯¾ç¨‹åˆ—è¡¨å…ƒç´ ä¸å­˜åœ¨');
                    return;
                }

                modal.classList.add('active');
                console.log('âœ“ æ¨¡æ€æ¡†å·²æ˜¾ç¤º');

                const courses = this.courseManager.courses;

                if (!courses || courses.length === 0) {
                    list.innerHTML = `
                        <div style="text-align: center; padding: 40px;">
                            <p style="color: var(--text-secondary); margin-bottom: 20px;">æœªæ£€æµ‹åˆ°è¯¾ç¨‹æ–‡ä»¶</p>
                            <p style="color: var(--text-hint); font-size: 0.9em;">è¯·å°†CSVæ–‡ä»¶æ”¾åœ¨ words/ ç›®å½•ä¸‹</p>
                        </div>
                    `;
                    console.warn('âš ï¸ æ²¡æœ‰å¯ç”¨çš„è¯¾ç¨‹');
                    return;
                }

                list.innerHTML = courses.map(course => `
                    <div class="course-card ${course.id === this.state.currentCourse ? 'active' : ''}" data-course-id="${course.id}">
                        <div class="course-name">${course.name}</div>
                        <div class="course-info">
                            ${course.wordCount > 0 ? `${course.wordCount} ä¸ªå•è¯` : 'ç‚¹å‡»åŠ è½½'}
                        </div>
                    </div>
                `).join('');

                console.log(`âœ“ å·²ç”Ÿæˆ ${courses.length} ä¸ªè¯¾ç¨‹å¡ç‰‡`);

                // æ·»åŠ äº‹ä»¶ç›‘å¬
                const courseCards = document.querySelectorAll('.course-card');
                if (courseCards.length > 0) {
                    courseCards.forEach((card, index) => {
                        card.addEventListener('click', async () => {
                            const courseId = card.getAttribute('data-course-id');
                            console.log(`ç‚¹å‡»äº†è¯¾ç¨‹å¡ç‰‡ #${index}:`, courseId);
                            modal.classList.remove('active');
                            await this.loadCourse(courseId);
                        });
                    });
                    console.log(`âœ“ è¯¾ç¨‹å¡ç‰‡ç›‘å¬å™¨å·²æ·»åŠ : ${courseCards.length} ä¸ª`);
                } else {
                    console.error('âŒ æœªæ‰¾åˆ°è¯¾ç¨‹å¡ç‰‡å…ƒç´ ');
                }
            }

            // å®‰å…¨åœ°æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
            addSafeListener(elementId, event, handler) {
                const element = document.getElementById(elementId);
                if (element) {
                    element.addEventListener(event, handler);
                    console.log(`âœ“ ç›‘å¬å™¨å·²æ·»åŠ : ${elementId}`);
                    return true;
                } else {
                    console.error(`âœ— å…ƒç´ ä¸å­˜åœ¨: ${elementId}`);
                    return false;
                }
            }

            setupEventListeners() {
                console.log('âš™ï¸ å¼€å§‹è®¾ç½®äº‹ä»¶ç›‘å¬å™¨...');

                // å¤´éƒ¨æ§åˆ¶æŒ‰é’®
                this.addSafeListener('themeToggle', 'click', () => this.toggleTheme());
                this.addSafeListener('selectCourse', 'click', () => this.showCourseSelector());
                this.addSafeListener('selectMode', 'click', () => this.showModeSelector());
                this.addSafeListener('reviewDifficult', 'click', () => this.reviewDifficultWords());

                // ä¸»è¦æ§åˆ¶æŒ‰é’®
                this.addSafeListener('btnKnow', 'click', () => this.handleKnow());
                this.addSafeListener('btnUnknown', 'click', () => this.handleUnknown());
                this.addSafeListener('btnSkip', 'click', () => this.handleSkip());

                // æ¨¡æ€æ¡†å…³é—­æŒ‰é’®
                this.addSafeListener('closeCourseModal', 'click', () => {
                    const modal = document.getElementById('courseModal');
                    if (modal) modal.classList.remove('active');
                });

                this.addSafeListener('closeModeModal', 'click', () => {
                    const modal = document.getElementById('modeModal');
                    if (modal) modal.classList.remove('active');
                });

                // æ¨¡å¼é€‰æ‹©å¡ç‰‡
                const modeCards = document.querySelectorAll('.mode-card');
                if (modeCards.length > 0) {
                    modeCards.forEach(card => {
                        card.addEventListener('click', () => {
                            const mode = card.getAttribute('data-mode');
                            const modal = document.getElementById('modeModal');
                            if (modal) modal.classList.remove('active');
                            this.switchMode(mode);
                        });
                    });
                    console.log(`âœ“ æ¨¡å¼å¡ç‰‡ç›‘å¬å™¨å·²æ·»åŠ : ${modeCards.length} ä¸ª`);
                } else {
                    console.warn('âš ï¸ æœªæ‰¾åˆ°æ¨¡å¼å¡ç‰‡å…ƒç´ ');
                }

                // é”®ç›˜å¿«æ·é”®
                document.addEventListener('keydown', (e) => this.handleKeyboard(e));
                console.log('âœ“ é”®ç›˜ç›‘å¬å™¨å·²æ·»åŠ ');

                // é¡µé¢å¸è½½ä¿å­˜
                window.addEventListener('beforeunload', () => {
                    this.saveProgress();
                    this.saveWords();
                });
                console.log('âœ“ é¡µé¢å¸è½½ç›‘å¬å™¨å·²æ·»åŠ ');

                console.log('âœ… äº‹ä»¶ç›‘å¬å™¨è®¾ç½®å®Œæˆï¼');
            }

            handleKeyboard(e) {
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
                    return;
                }

                if (this.state.currentMode !== 'card-flip') return;

                switch(e.key) {
                    case 'ArrowLeft':
                        e.preventDefault();
                        this.handleSkip();
                        break;
                    case 'ArrowRight':
                        e.preventDefault();
                        this.handleKnow();
                        break;
                    case 'ArrowDown':
                        e.preventDefault();
                        this.handleUnknown();
                        break;
                    case ' ':
                        e.preventDefault();
                        if (this.state.cards[0]) {
                            const cardInner = this.state.cards[0].querySelector('.card-inner');
                            if (cardInner) {
                                this.ui.flipCard(cardInner);
                            }
                        }
                        break;
                }
            }

            toggleTheme() {
                const newTheme = this.state.theme === 'light' ? 'dark' : 'light';
                this.setTheme(newTheme);
                this.storage.set('theme', newTheme);
                this.ui.showToast(`å·²åˆ‡æ¢åˆ°${newTheme === 'dark' ? 'æ·±è‰²' : 'æµ…è‰²'}æ¨¡å¼`, 'success');
            }

            setTheme(theme) {
                this.state.theme = theme;
                document.documentElement.setAttribute('data-theme', theme);
                const icon = document.getElementById('themeIcon');
                if (icon) {
                    icon.textContent = theme === 'dark' ? 'â˜€ï¸' : 'ğŸŒ™';
                }
            }

            showModeSelector() {
                console.log('ğŸ¯ æ˜¾ç¤ºæ¨¡å¼é€‰æ‹©å™¨...');

                if (!this.state.words || this.state.words.length === 0) {
                    this.ui.showToast('è¯·å…ˆé€‰æ‹©è¯¾ç¨‹', 'warning');
                    console.warn('âš ï¸ æ²¡æœ‰å•è¯æ•°æ®ï¼Œæ— æ³•åˆ‡æ¢æ¨¡å¼');
                    return;
                }

                const modal = document.getElementById('modeModal');
                if (!modal) {
                    console.error('âŒ æ¨¡å¼æ¨¡æ€æ¡†å…ƒç´ ä¸å­˜åœ¨');
                    return;
                }

                modal.classList.add('active');
                console.log('âœ“ æ¨¡å¼é€‰æ‹©å™¨å·²æ˜¾ç¤º');
            }

            switchMode(mode) {
                console.log(`ğŸ”„ åˆ‡æ¢å­¦ä¹ æ¨¡å¼: ${mode}`);

                // åœæ­¢å½“å‰æ¨¡å¼
                if (this.currentModeInstance) {
                    this.currentModeInstance.stop();
                    this.currentModeInstance = null;
                }

                this.state.currentMode = mode;
                const container = document.getElementById('cardStack');
                let words = [...this.state.words];
                let startIndex = this.state.currentIndex; // ä¿æŒå½“å‰è¿›åº¦

                // æ ¹æ®æ¨¡å¼å‡†å¤‡å•è¯
                switch(mode) {
                    case 'random':
                        // éšæœºæ‰“ä¹± - è¿™ç§æƒ…å†µéœ€è¦ä»å¤´å¼€å§‹
                        words = this.shuffleArray(words);
                        this.ui.showToast('ğŸ² éšæœºæ¨¡å¼å·²å¯åŠ¨', 'info');
                        this.state.words = words;
                        this.state.currentIndex = 0; // éšæœºæ¨¡å¼ä»å¤´å¼€å§‹
                        this.ui.init();
                        break;

                    case 'smart-review':
                        // æ™ºèƒ½å¤ä¹ ï¼šåªæ˜¾ç¤ºéœ€è¦å¤ä¹ çš„å•è¯ - ä»å¤´å¼€å§‹
                        const dueWords = EnhancedSM2Algorithm.getDueWords(words);
                        if (dueWords.length === 0) {
                            this.ui.showToast('æš‚æ— éœ€è¦å¤ä¹ çš„å•è¯', 'info');
                            return;
                        }
                        this.ui.showToast(`ğŸ§  æ™ºèƒ½å¤ä¹ ï¼š${dueWords.length} ä¸ªå•è¯éœ€è¦å¤ä¹ `, 'info');
                        this.state.words = dueWords;
                        this.state.currentIndex = 0; // æ™ºèƒ½å¤ä¹ ä»å¤´å¼€å§‹
                        this.ui.init();
                        break;

                    case 'spelling':
                        // æ‹¼å†™ç»ƒä¹  - ç»§æ‰¿å½“å‰è¿›åº¦
                        this.currentModeInstance = new SpellingMode(container, words, this, startIndex);
                        this.currentModeInstance.start();
                        this.ui.showToast(`âœï¸ æ‹¼å†™ç»ƒä¹  - ä»ç¬¬ ${startIndex + 1} ä¸ªå•è¯å¼€å§‹`, 'info');
                        break;

                    case 'dictation':
                        // å¬å†™æ¨¡å¼ - ç»§æ‰¿å½“å‰è¿›åº¦
                        this.currentModeInstance = new DictationMode(container, words, this, startIndex);
                        this.currentModeInstance.start();
                        this.ui.showToast(`ğŸ¤ å¬å†™æ¨¡å¼ - ä»ç¬¬ ${startIndex + 1} ä¸ªå•è¯å¼€å§‹`, 'info');
                        break;

                    case 'quick-review':
                        // å¿«é€Ÿå¤ä¹  - ç»§æ‰¿å½“å‰è¿›åº¦
                        this.currentModeInstance = new QuickReviewMode(container, words, this, startIndex);
                        this.currentModeInstance.start();
                        this.ui.showToast(`âš¡ å¿«é€Ÿå¤ä¹  - ä»ç¬¬ ${startIndex + 1} ä¸ªå•è¯å¼€å§‹`, 'info');
                        break;

                    case 'card-flip':
                    default:
                        // å¡ç‰‡ç¿»è½¬ - ç»§æ‰¿å½“å‰è¿›åº¦ï¼Œä¸é‡ç½®
                        this.ui.init();
                        this.ui.showToast(`ğŸƒ å¡ç‰‡ç¿»è½¬ - ä»ç¬¬ ${startIndex + 1} ä¸ªå•è¯ç»§ç»­`, 'info');
                        break;
                }

                console.log(`âœ“ æ¨¡å¼åˆ‡æ¢å®Œæˆ - å½“å‰è¿›åº¦: ${this.state.currentIndex + 1}/${this.state.words.length}`);
            }

            reviewDifficultWords() {
                const difficultWords = EnhancedSM2Algorithm.getDifficultWords(this.state.words, 2);

                if (difficultWords.length === 0) {
                    this.ui.showToast('å¤ªæ£’äº†ï¼æ²¡æœ‰æ˜“é”™è¯', 'success');
                    return;
                }

                this.ui.showToast(`ğŸ”¥ æ‰¾åˆ° ${difficultWords.length} ä¸ªæ˜“é”™è¯`, 'warning');
                this.state.words = difficultWords;
                this.state.currentIndex = 0;
                this.ui.init();
            }

            shuffleArray(array) {
                const shuffled = [...array];
                for (let i = shuffled.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
                }
                return shuffled;
            }

            handleKnow() {
                if (this.state.currentIndex >= this.state.words.length) return;

                const word = this.state.words[this.state.currentIndex];
                this.state.knownCount++;

                EnhancedSM2Algorithm.calculate(word, 5);
                this.recordStudy(word, true, 1);

                this.ui.bumpNumber('knownCount');
                this.effects.showCelebration('âœ…');
                this.effects.createFlash('rgba(79, 172, 254, 0.2)');
                this.effects.createParticleBurst(window.innerWidth / 2, window.innerHeight / 2, '#4facfe');
                this.ui.removeCurrentCard('right');
                this.vibrate([10, 50, 10]);
            }

            handleUnknown() {
                if (this.state.currentIndex >= this.state.words.length) return;

                const word = this.state.words[this.state.currentIndex];
                this.state.unknownCount++;

                EnhancedSM2Algorithm.calculate(word, 2);
                this.recordStudy(word, false, 1);

                this.ui.bumpNumber('unknownCount');
                this.effects.showCelebration('ğŸ“–');
                this.effects.createFlash('rgba(250, 112, 154, 0.2)');
                this.effects.createParticleBurst(window.innerWidth / 2, window.innerHeight / 2, '#fa709a');
                this.ui.removeCurrentCard('left');
                this.vibrate([10, 30, 10, 30, 10]);
            }

            handleSkip() {
                if (this.state.currentIndex >= this.state.words.length) return;

                this.effects.showCelebration('â­ï¸');
                this.ui.removeCurrentCard('left');
                this.vibrate([10]);
            }

            recordStudy(word, known, attempts) {
                const record = {
                    wordId: word.id,
                    word: word.word,
                    known: known,
                    attempts: attempts,
                    timestamp: Date.now()
                };

                const courseId = this.state.currentCourse;
                let history = this.storage.get(`history_${courseId}`) || [];
                history.push(record);

                if (history.length > 1000) {
                    history = history.slice(-1000);
                }

                this.storage.set(`history_${courseId}`, history);
            }

            saveProgress() {
                const courseId = this.state.currentCourse;
                if (!courseId) return;

                this.storage.set(`progress_${courseId}`, {
                    currentIndex: this.state.currentIndex,
                    knownCount: this.state.knownCount,
                    unknownCount: this.state.unknownCount,
                    lastStudyDate: new Date().toDateString()
                });
            }

            saveWords() {
                const courseId = this.state.currentCourse;
                if (!courseId) return;

                // åªä¿å­˜æœ‰SM-2æ•°æ®çš„å•è¯
                const wordsToSave = this.state.words
                    .filter(w => w.sm2)
                    .map(w => ({
                        word: w.word,
                        sm2: w.sm2
                    }));

                this.storage.set(`words_${courseId}`, wordsToSave);
            }

            updateStreak() {
                const lastDate = this.storage.get('lastStudyDate');
                const today = new Date().toDateString();
                let streak = this.storage.get('studyStreak') || 0;

                if (lastDate) {
                    const last = new Date(lastDate);
                    const current = new Date(today);
                    const diffDays = Math.floor((current - last) / (1000 * 60 * 60 * 24));

                    if (diffDays === 0) {
                        // ä»Šå¤©å·²å­¦ä¹ 
                    } else if (diffDays === 1) {
                        streak++;
                        this.storage.set('studyStreak', streak);
                    } else {
                        streak = 1;
                        this.storage.set('studyStreak', streak);
                    }
                } else {
                    streak = 1;
                    this.storage.set('studyStreak', streak);
                }

                this.storage.set('lastStudyDate', today);
                document.getElementById('streakCount').textContent = streak;
            }

            vibrate(pattern) {
                if (this.state.settings.vibration && navigator.vibrate) {
                    navigator.vibrate(pattern);
                }
            }
        }

        // ==================== åˆå§‹åŒ–åº”ç”¨ ====================
        let app;

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                app = new WordLearningApp();
                console.log('âœ¨ èƒŒå•è¯ç¥å™¨ Ultimate å·²å¯åŠ¨ï¼');
            });
        } else {
            app = new WordLearningApp();
            console.log('âœ¨ èƒŒå•è¯ç¥å™¨ Ultimate å·²å¯åŠ¨ï¼');
        }

        window.addEventListener('error', (e) => {
            console.error('å…¨å±€é”™è¯¯:', e.error);
        });

        window.addEventListener('unhandledrejection', (e) => {
            console.error('æœªå¤„ç†çš„Promiseæ‹’ç»:', e.reason);
        });
    </script>
</body>
</html>
