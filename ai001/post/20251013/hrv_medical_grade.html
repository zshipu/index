<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HRV 心率变异性医学分析报告</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#0f766e', // 医疗蓝绿色调，传达专业与信任感
                        secondary: '#10b981',
                        warning: '#f59e0b',
                        danger: '#dc2626',
                        neutral: '#4b5563',
                        'hrv-optimal': '#059669', // 最佳状态
                        'hrv-normal': '#0f766e',  // 正常状态
                        'hrv-concern': '#dc2626', // 需关注
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .card-shadow {
                box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            }
            .medical-border {
                border-left: 4px solid #0f766e;
            }
            .hrv-badge {
                @apply inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium;
            }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen font-sans text-gray-800">
    <!-- 头部导航 -->
    <header class="bg-white shadow-sm sticky top-0 z-50">
        <div class="container mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center space-x-3">
                <i class="fa fa-heartbeat text-primary text-2xl"></i>
                <h1 class="text-xl md:text-2xl font-bold">HRV 心率变异性医学分析报告</h1>
            </div>
            <div class="text-sm text-gray-600 flex items-center">
                <i class="fa fa-refresh mr-1"></i>
                <span id="last-update">数据更新时间: </span>
            </div>
        </div>
    </header>

    <!-- 主要内容区 -->
    <main class="container mx-auto px-4 py-8">
        <!-- 报告摘要 -->
        <div class="bg-white rounded-xl p-6 card-shadow mb-8 medical-border">
            <h2 class="text-lg font-semibold mb-3">报告摘要</h2>
            <p class="text-gray-700 text-sm">心率变异性(HRV)是评估自主神经系统功能的重要指标，反映心脏节律的波动性。本报告基于您的连续监测数据，通过医学标准算法分析，提供客观的自主神经功能状态评估，仅供临床参考。</p>
        </div>

        <!-- 核心指标卡片 -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <!-- 平均HRV -->
            <div class="bg-white rounded-xl p-6 card-shadow transform transition duration-300 hover:shadow-md">
                <div class="flex justify-between items-start mb-4">
                    <h2 class="text-lg font-semibold text-gray-700">平均 HRV</h2>
                    <span class="bg-teal-100 text-primary p-2 rounded-full">
                        <i class="fa fa-line-chart"></i>
                    </span>
                </div>
                <div class="flex items-baseline">
                    <span id="avg-hrv" class="text-3xl font-bold text-gray-800">-</span>
                    <span class="ml-2 text-gray-500">ms</span>
                </div>
                <p class="mt-2 text-sm text-gray-500" id="record-count-text">基于 0 条记录的平均值</p>
                <div class="mt-4 h-1 w-full bg-gray-200 rounded-full overflow-hidden">
                    <div id="avg-progress" class="h-full bg-primary rounded-full" style="width: 0%"></div>
                </div>
            </div>

            <!-- 最高HRV -->
            <div class="bg-white rounded-xl p-6 card-shadow transform transition duration-300 hover:shadow-md">
                <div class="flex justify-between items-start mb-4">
                    <h2 class="text-lg font-semibold text-gray-700">最高 HRV</h2>
                    <span class="bg-green-100 text-hrv-optimal p-2 rounded-full">
                        <i class="fa fa-arrow-up"></i>
                    </span>
                </div>
                <div class="flex items-baseline">
                    <span id="max-hrv" class="text-3xl font-bold text-gray-800">-</span>
                    <span class="ml-2 text-gray-500">ms</span>
                </div>
                <p class="mt-2 text-sm text-gray-500" id="max-time">-</p>
                <span class="hrv-badge bg-green-100 text-hrv-optimal mt-4" id="max-status">--</span>
            </div>

            <!-- 最低HRV -->
            <div class="bg-white rounded-xl p-6 card-shadow transform transition duration-300 hover:shadow-md">
                <div class="flex justify-between items-start mb-4">
                    <h2 class="text-lg font-semibold text-gray-700">最低 HRV</h2>
                    <span class="bg-red-100 text-hrv-concern p-2 rounded-full">
                        <i class="fa fa-arrow-down"></i>
                    </span>
                </div>
                <div class="flex items-baseline">
                    <span id="min-hrv" class="text-3xl font-bold text-gray-800">-</span>
                    <span class="ml-2 text-gray-500">ms</span>
                </div>
                <p class="mt-2 text-sm text-gray-500" id="min-time">-</p>
                <span class="hrv-badge bg-red-100 text-hrv-concern mt-4" id="min-status">--</span>
            </div>
        </div>

        <!-- HRV 趋势图表 -->
        <div class="bg-white rounded-xl p-6 card-shadow mb-8">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                <h2 class="text-xl font-bold text-gray-800">HRV 趋势与基准范围</h2>
                <div class="flex items-center space-x-4 w-full sm:w-auto">
                    <div class="text-sm text-gray-600">
                        <span>显示记录数:</span>
                        <select id="record-count" class="ml-2 border border-gray-300 rounded px-2 py-1 text-sm focus:outline-none focus:ring-1 focus:ring-primary">
                            <option value="7">7条</option>
                            <option value="14" selected>14条</option>
                            <option value="20">20条</option>
                            <option value="30">30条</option>
                            <option value="all">全部</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="h-[400px]">
                <canvas id="hrv-trend-chart"></canvas>
            </div>
            <div class="mt-6 grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                <div class="flex items-center">
                    <span class="w-3 h-3 bg-hrv-normal rounded-full mr-2"></span>
                    <span class="text-gray-600">HRV 数值</span>
                </div>
                <div class="flex items-center">
                    <span class="w-3 h-3 bg-hrv-optimal rounded-full mr-2"></span>
                    <span class="text-gray-600">高于基准线</span>
                </div>
                <div class="flex items-center">
                    <span class="w-3 h-3 bg-hrv-concern rounded-full mr-2"></span>
                    <span class="text-gray-600">低于基准线</span>
                </div>
                <div class="flex items-center">
                    <span class="w-3 h-3 bg-primary/20 rounded-full mr-2"></span>
                    <span class="text-gray-600">基准范围</span>
                </div>
            </div>
        </div>

        <!-- HRV 区间分布与医学解读 -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            <!-- 区间分布饼图 -->
            <div class="bg-white rounded-xl p-6 card-shadow">
                <h2 class="text-xl font-bold text-gray-800 mb-6">HRV 数值分布</h2>
                <div class="h-[300px] flex items-center justify-center">
                    <canvas id="hrv-distribution-chart"></canvas>
                </div>
                <div class="mt-6 grid grid-cols-3 gap-2 text-center text-sm">
                    <div>
                        <p class="text-hrv-optimal font-medium">最佳 (>120ms)</p>
                        <p id="good-count" class="text-gray-700">0 条 (0%)</p>
                    </div>
                    <div>
                        <p class="text-hrv-normal font-medium">正常 (100-120ms)</p>
                        <p id="normal-count" class="text-gray-700">0 条 (0%)</p>
                    </div>
                    <div>
                        <p class="text-hrv-concern font-medium">需关注 (<100ms)</p>
                        <p id="poor-count" class="text-gray-700">0 条 (0%)</p>
                    </div>
                </div>
            </div>

            <!-- 医学解读与建议 -->
            <div class="bg-white rounded-xl p-6 card-shadow">
                <h2 class="text-xl font-bold text-gray-800 mb-6">医学解读与建议</h2>
                <div class="space-y-6">
                    <div class="flex items-start">
                        <div class="flex-shrink-0 h-6 w-6 rounded-full bg-teal-100 flex items-center justify-center mt-0.5">
                            <i class="fa fa-heartbeat text-primary text-xs"></i>
                        </div>
                        <div class="ml-3">
                            <h3 class="text-sm font-medium text-gray-900">HRV (心率变异性)</h3>
                            <div class="mt-1 text-sm text-gray-600">
                                <p>心率变异性是指连续心跳间的时间间隔变化，是评估自主神经系统平衡性的重要生物标志物。较高的HRV通常表明自主神经调节功能良好，对生理和心理压力的适应能力较强。</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex items-start">
                        <div class="flex-shrink-0 h-6 w-6 rounded-full bg-blue-100 flex items-center justify-center mt-0.5">
                            <i class="fa fa-calculator text-blue-600 text-xs"></i>
                        </div>
                        <div class="ml-3">
                            <h3 class="text-sm font-medium text-gray-900">基准范围解读</h3>
                            <div class="mt-1 text-sm text-gray-600">
                                <p>图表中的蓝色区域表示基于您个人历史数据计算的基准范围（平均值±标准差）。该范围反映了您的自主神经功能正常波动区间，可作为健康状态的参考基准。</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex items-start">
                        <div class="flex-shrink-0 h-6 w-6 rounded-full bg-green-100 flex items-center justify-center mt-0.5">
                            <i class="fa fa-medkit text-green-600 text-xs"></i>
                        </div>
                        <div class="ml-3">
                            <h3 class="text-sm font-medium text-gray-900">临床建议</h3>
                            <div class="mt-1 text-sm text-gray-600">
                                <p>保持规律作息、适度有氧运动、压力管理及正念训练有助于维持健康的HRV水平。若HRV持续偏低或显著下降，建议咨询医疗专业人员进行进一步评估。</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 原始数据表格 -->
        <div class="bg-white rounded-xl p-6 card-shadow">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-gray-800">详细监测记录</h2>
                <button id="export-btn" class="px-4 py-2 bg-primary text-white rounded-md text-sm flex items-center hover:bg-primary/90 transition-colors">
                    <i class="fa fa-download mr-2"></i>导出完整数据
                </button>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead>
                        <tr>
                            <th class="px-4 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">监测时间</th>
                            <th class="px-4 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">HRV 数值 (ms)</th>
                            <th class="px-4 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">与基准线比较</th>
                            <th class="px-4 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">评估结果</th>
                        </tr>
                    </thead>
                    <tbody id="data-table-body" class="bg-white divide-y divide-gray-200">
                        <!-- 数据将通过JS动态填充 -->
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <!-- 页脚 -->
    <footer class="bg-gray-800 text-white py-8 mt-12">
        <div class="container mx-auto px-4">
            <div class="flex flex-col md:flex-row justify-between items-center">
                <div class="mb-4 md:mb-0">
                    <h3 class="text-lg font-bold flex items-center">
                        <i class="fa fa-heartbeat text-primary mr-2"></i>HRV 医学分析报告
                    </h3>
                    <p class="text-gray-400 text-sm mt-1">专业心率变异性监测与分析工具</p>
                </div>
                <div class="text-gray-400 text-sm">
                    <p>© 2025 健康监测系统 | 本报告仅供健康参考，不构成医疗诊断</p>
                    <p class="mt-1">医疗决策请咨询专业医务人员</p>
                </div>
            </div>
        </div>
    </footer>

    <script>
        // 唯一的输入数据源 - HRV 原始数据
        const hrvData = [
            { "hrv_value": 108, "take_time": "2025-10-15 09:56:18" },
            { "hrv_value": 141, "take_time": "2025-10-14 20:32:30" },
            { "hrv_value": 129, "take_time": "2025-10-14 20:31:42" },
            { "hrv_value": 112, "take_time": "2025-10-14 17:25:31" },
            { "hrv_value": 110, "take_time": "2025-10-14 14:53:31" },
            { "hrv_value": 109, "take_time": "2025-10-14 09:00:39" },
            { "hrv_value": 116, "take_time": "2025-10-14 05:19:57" },
            { "hrv_value": 117, "take_time": "2025-10-13 19:56:28" },
            { "hrv_value": 142, "take_time": "2025-10-13 18:27:42" },
            { "hrv_value": 96, "take_time": "2025-10-13 15:02:41" },
            { "hrv_value": 92, "take_time": "2025-10-13 11:18:52" },
            { "hrv_value": 110, "take_time": "2025-10-12 22:15:59" },
            { "hrv_value": 116, "take_time": "2025-10-12 15:54:02" },
            { "hrv_value": 119, "take_time": "2025-10-12 13:53:44" },
            { "hrv_value": 121, "take_time": "2025-10-12 13:51:50" },
            { "hrv_value": 117, "take_time": "2025-10-12 13:43:16" },
            { "hrv_value": 107, "take_time": "2025-10-12 12:52:20" },
            { "hrv_value": 121, "take_time": "2025-10-11 23:07:01" },
            { "hrv_value": 113, "take_time": "2025-10-10 21:51:11" },
            { "hrv_value": 95, "take_time": "2025-10-09 17:29:53" },
            { "hrv_value": 115, "take_time": "2025-10-07 23:27:33" },
            { "hrv_value": 95, "take_time": "2025-10-06 22:04:58" },
            { "hrv_value": 129, "take_time": "2025-10-06 16:15:41" }
        ];

        // 全局变量存储当前图表和参数
        let trendChart = null;
        let distributionChart = null;
        let currentRecordCount = 14;
        let allData = []; // 存储排序后的完整数据

        // 数据处理函数
        document.addEventListener('DOMContentLoaded', function() {
            // 按时间排序数据（旧到新）
            allData = [...hrvData].sort((a, b) => new Date(a.take_time) - new Date(b.take_time));
            
            // 更新最后更新时间为最新记录的时间
            if (allData.length > 0) {
                const latestRecord = allData[allData.length - 1];
                document.getElementById('last-update').textContent = `数据更新时间: ${latestRecord.take_time}`;
            }
            
            // 计算统计数据
            const values = allData.map(item => item.hrv_value);
            const avgHrv = values.length > 0 ? Math.round(values.reduce((sum, val) => sum + val, 0) / values.length) : 0;
            
            // 找到最高和最低HRV及其记录时间
            let maxItem = null, minItem = null;
            if (allData.length > 0) {
                maxItem = allData.reduce((max, item) => item.hrv_value > max.hrv_value ? item : max, allData[0]);
                minItem = allData.reduce((min, item) => item.hrv_value < min.hrv_value ? item : min, allData[0]);
            }
            
            // 分类统计
            const goodCount = values.filter(v => v > 120).length;
            const normalCount = values.filter(v => v >= 100 && v <= 120).length;
            const poorCount = values.filter(v => v < 100).length;
            
            // 更新概览数据
            document.getElementById('avg-hrv').textContent = avgHrv || '-';
            document.getElementById('record-count-text').textContent = `基于 ${values.length} 条记录的平均值`;
            
            if (maxItem) {
                document.getElementById('max-hrv').textContent = maxItem.hrv_value;
                document.getElementById('max-time').textContent = `监测时间: ${maxItem.take_time}`;
                // 设置最高值状态
                const maxStatusEl = document.getElementById('max-status');
                if (maxItem.hrv_value > 120) {
                    maxStatusEl.textContent = '最佳状态';
                    maxStatusEl.className = 'hrv-badge bg-green-100 text-hrv-optimal mt-4';
                } else if (maxItem.hrv_value >= 100) {
                    maxStatusEl.textContent = '正常状态';
                    maxStatusEl.className = 'hrv-badge bg-teal-100 text-hrv-normal mt-4';
                } else {
                    maxStatusEl.textContent = '需关注';
                    maxStatusEl.className = 'hrv-badge bg-red-100 text-hrv-concern mt-4';
                }
            }
            
            if (minItem) {
                document.getElementById('min-hrv').textContent = minItem.hrv_value;
                document.getElementById('min-time').textContent = `监测时间: ${minItem.take_time}`;
                // 设置最低值状态
                const minStatusEl = document.getElementById('min-status');
                if (minItem.hrv_value > 120) {
                    minStatusEl.textContent = '最佳状态';
                    minStatusEl.className = 'hrv-badge bg-green-100 text-hrv-optimal mt-4';
                } else if (minItem.hrv_value >= 100) {
                    minStatusEl.textContent = '正常状态';
                    minStatusEl.className = 'hrv-badge bg-teal-100 text-hrv-normal mt-4';
                } else {
                    minStatusEl.textContent = '需关注';
                    minStatusEl.className = 'hrv-badge bg-red-100 text-hrv-concern mt-4';
                }
            }
            
            // 更新分布统计
            document.getElementById('good-count').textContent = `${goodCount} 条 (${values.length > 0 ? Math.round(goodCount/values.length*100) : 0}%)`;
            document.getElementById('normal-count').textContent = `${normalCount} 条 (${values.length > 0 ? Math.round(normalCount/values.length*100) : 0}%)`;
            document.getElementById('poor-count').textContent = `${poorCount} 条 (${values.length > 0 ? Math.round(poorCount/values.length*100) : 0}%)`;
            
            // 设置进度条
            const avgProgress = values.length > 0 ? Math.min(100, Math.max(0, (avgHrv / 200) * 100)) : 0;
            document.getElementById('avg-progress').style.width = `${avgProgress}%`;
            
            // 初始化图表和表格
            updateChartsAndTable(allData);
            
            // 记录数选择事件
            document.getElementById('record-count').addEventListener('change', function() {
                currentRecordCount = this.value === 'all' ? allData.length : parseInt(this.value);
                updateChartsAndTable(allData);
            });
            
            // 导出数据按钮
            document.getElementById('export-btn').addEventListener('click', function() {
                if (allData.length === 0) {
                    alert('没有数据可导出');
                    return;
                }
                
                const csvContent = "data:text/csv;charset=utf-8," 
                    + "监测时间,HRV数值(ms)\n" 
                    + allData.map(item => `${item.take_time},${item.hrv_value}`).join("\n");
                
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", `HRV监测数据_${new Date().toLocaleDateString()}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            });
        });

        // 更新图表和表格
        function updateChartsAndTable(allData) {
            // 确定要显示的最新记录数量
            const displayCount = Math.min(currentRecordCount, allData.length);
            const startIndex = allData.length - displayCount;
            const displayData = allData.slice(startIndex);
            
            // 计算基准线范围数据
            const baseline = calculateBaselineRanges(allData, displayData, startIndex);
            
            // 初始化HRV走势图表
            initTrendChart(displayData, baseline);
            
            // 初始化区间分布图表
            const allValues = allData.map(item => item.hrv_value);
            const goodCount = allValues.filter(v => v > 120).length;
            const normalCount = allValues.filter(v => v >= 100 && v <= 120).length;
            const poorCount = allValues.filter(v => v < 100).length;
            initDistributionChart(goodCount, normalCount, poorCount);
            
            // 填充表格数据（按最新在前排序）
            const sortedForTable = [...displayData].sort((a, b) => new Date(b.take_time) - new Date(a.take_time));
            fillTableData(sortedForTable, baseline);
        }

        // 计算基准线范围数据
        function calculateBaselineRanges(allData, displayData, displayStartIndex) {
            const baseline = {
                upper: [],
                lower: []
            };
            
            if (displayData.length === 0) return baseline;
            
            // 遍历每条显示的数据
            displayData.forEach((item, index) => {
                // 当前点在完整数据集里的索引
                const currentIndexInAllData = displayStartIndex + index;
                
                // 获取当前点之前的所有历史数据（不包括当前点）
                const historyData = allData.slice(0, currentIndexInAllData);
                
                // 如果没有历史数据，使用当前点的值作为参考
                if (historyData.length === 0) {
                    baseline.upper.push(item.hrv_value * 1.1);
                    baseline.lower.push(item.hrv_value * 0.9);
                    return;
                }
                
                // 提取历史数据的HRV值
                const historyValues = historyData.map(i => i.hrv_value);
                
                // 计算历史数据的平均值和标准差（医学上常用的基准线计算方法）
                const mean = historyValues.reduce((sum, val) => sum + val, 0) / historyValues.length;
                const variance = historyValues.reduce((sum, val) => sum + Math.pow(val - mean, 2), 0) / historyValues.length;
                const stdDev = Math.sqrt(variance);
                
                // 基准线上限 = 平均值 + 标准差
                // 基准线下限 = 平均值 - 标准差
                baseline.upper.push(mean + stdDev);
                baseline.lower.push(mean - stdDev);
            });
            
            return baseline;
        }

        // 初始化HRV走势图表（基准线版本）
        function initTrendChart(displayData, baseline) {
            const ctx = document.getElementById('hrv-trend-chart').getContext('2d');
            
            // 销毁已存在的图表
            if (trendChart) {
                trendChart.destroy();
            }
            
            // 如果没有数据，不绘制图表
            if (displayData.length === 0) {
                return;
            }
            
            const labels = displayData.map(item => {
                const date = new Date(item.take_time);
                return `${date.getMonth()+1}/${date.getDate()} ${date.getHours()}:${String(date.getMinutes()).padStart(2, '0')}`;
            });
            
            const values = displayData.map(item => item.hrv_value);
            
            // 创建基准范围的渐变填充
            const yMin = Math.min(0, ...baseline.lower, Math.min(...values) - 10);
            const yMax = Math.max(...baseline.upper, Math.max(...values) + 10);
            
            // 创建渐变
            const gradient = ctx.createLinearGradient(0, yMin, 0, yMax);
            
            // 基准线下以下部分设置为完全透明
            gradient.addColorStop(0, 'rgba(15, 118, 110, 0)');
            
            // 计算基准线到基准线的相对位置并设置渐变
            const lowerBoundRelative = Math.max(0, (Math.min(...baseline.lower) - yMin) / (yMax - yMin));
            const upperBoundRelative = Math.min(1, (Math.max(...baseline.upper) - yMin) / (yMax - yMin));
            
            // 基准线下开始显示颜色
            gradient.addColorStop(lowerBoundRelative, 'rgba(15, 118, 110, 0.2)');
            
            // 基准范围内保持颜色
            gradient.addColorStop((lowerBoundRelative + upperBoundRelative) / 2, 'rgba(15, 118, 110, 0.2)');
            
            // 基准线上回到透明
            gradient.addColorStop(upperBoundRelative, 'rgba(15, 118, 110, 0)');
            
            // 基准线上以上部分保持透明
            gradient.addColorStop(1, 'rgba(15, 118, 110, 0)');
            
            // 创建点颜色数组 - 根据与基准线的关系设置不同颜色
            const pointColors = values.map((value, index) => {
                if (value > baseline.upper[index]) {
                    return '#059669'; // 最佳状态（绿色）
                } else if (value < baseline.lower[index]) {
                    return '#dc2626'; // 需关注（红色）
                } else {
                    return '#0f766e'; // 正常状态（蓝绿色）
                }
            });

            // 创建点边框颜色数组 - 悬停时使用
            const pointHoverBorderColors = values.map((value, index) => {
                if (value > baseline.upper[index]) {
                    return '#059669'; // 最佳状态（绿色）
                } else if (value < baseline.lower[index]) {
                    return '#dc2626'; // 需关注（红色）
                } else {
                    return '#0f766e'; // 正常状态（蓝绿色）
                }
            });
            
            // 创建新图表
            trendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'HRV 数值',
                            data: values,
                            borderColor: '#0f766e',
                            borderWidth: 2,
                            tension: 0.3,
                            fill: false,
                            pointBackgroundColor: pointColors,
                            pointRadius: 5,
                            pointHoverRadius: 7,
                            pointHoverBackgroundColor: '#ffffff',
                            pointHoverBorderColor: pointHoverBorderColors,
                            pointHoverBorderWidth: 2
                        },
                        {
                            label: '基准线上限',
                            data: baseline.upper,
                            borderColor: 'rgba(15, 118, 110, 0.6)',
                            borderWidth: 1.5,
                            borderDash: [4, 4],
                            fill: false,
                            pointRadius: 0,
                            tension: 0.4
                        },
                        {
                            label: '基准线下限',
                            data: baseline.lower,
                            borderColor: 'rgba(15, 118, 110, 0.6)',
                            borderWidth: 1.5,
                            borderDash: [4, 4],
                            fill: true,
                            backgroundColor: gradient,  // 应用基准范围渐变填充
                            pointRadius: 0,
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        tooltip: {
                            backgroundColor: 'rgba(255, 255, 255, 0.95)',
                            titleColor: '#1f2937',
                            bodyColor: '#4b5563',
                            borderColor: '#e5e7eb',
                            borderWidth: 1,
                            padding: 10,
                            boxPadding: 5,
                            usePointStyle: true,
                            callbacks: {
                                afterLabel: function(context) {
                                    const index = context.dataIndex;
                                    const value = values[index];
                                    const upper = Math.round(baseline.upper[index]);
                                    const lower = Math.round(baseline.lower[index]);
                                    
                                    let positionText = '';
                                    if (value > baseline.upper[index]) {
                                        positionText = '高于基准线（自主神经功能良好）';
                                    } else if (value < baseline.lower[index]) {
                                        positionText = '低于基准线（建议关注）';
                                    } else {
                                        positionText = '在基准范围内（正常）';
                                    }
                                    
                                    const historyCount = index + (allData.length - displayData.length);
                                    return [
                                        positionText,
                                        `基准范围: ${lower} - ${upper} ms`,
                                        `基于 ${historyCount} 条历史数据计算`
                                    ];
                                }
                            }
                        },
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45,
                                font: {
                                    size: 10
                                }
                            }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'HRV (毫秒)'
                            },
                            beginAtZero: false,
                            min: yMin,
                            max: yMax,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            },
                            ticks: {
                                stepSize: 20,
                                callback: function(value) {
                                    return value + ' ms';
                                }
                            }
                        }
                    },
                    animation: {
                        duration: 1000,
                        easing: 'easeOutQuart'
                    }
                }
            });
        }

        // 初始化区间分布图表
        function initDistributionChart(good, normal, poor) {
            const ctx = document.getElementById('hrv-distribution-chart').getContext('2d');
            
            // 销毁已存在的图表
            if (distributionChart) {
                distributionChart.destroy();
            }
            
            // 如果没有数据，不绘制图表
            if (good + normal + poor === 0) {
                return;
            }
            
            distributionChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['最佳 (>120ms)', '正常 (100-120ms)', '需关注 (<100ms)'],
                    datasets: [{
                        data: [good, normal, poor],
                        backgroundColor: [
                            '#059669',
                            '#0f766e',
                            '#dc2626'
                        ],
                        borderColor: '#ffffff',
                        borderWidth: 3,
                        hoverOffset: 10
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '65%',
                    plugins: {
                        tooltip: {
                            backgroundColor: 'rgba(255, 255, 255, 0.95)',
                            titleColor: '#1f2937',
                            bodyColor: '#4b5563',
                            borderColor: '#e5e7eb',
                            borderWidth: 1,
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.raw || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                                    return `${label}: ${value} 条 (${percentage}%)`;
                                }
                            }
                        },
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        // 填充表格数据
        function fillTableData(displayData, baseline) {
            const tableBody = document.getElementById('data-table-body');
            tableBody.innerHTML = '';
            
            // 如果没有数据，显示提示信息
            if (displayData.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td colspan="4" class="px-4 py-8 text-center text-gray-500">
                        没有可用的HRV监测数据
                    </td>
                `;
                tableBody.appendChild(row);
                return;
            }
            
            // 为表格数据创建索引映射（因为表格是按最新排序的）
            const originalIndices = displayData.map(item => allData.findIndex(d => d.take_time === item.take_time));
            
            displayData.forEach((item, tableIndex) => {
                const originalIndex = originalIndices[tableIndex];
                const displayStartIndex = allData.length - currentRecordCount;
                const chartIndex = originalIndex - displayStartIndex;
                
                // 获取该数据点对应的基准线值
                let positionText = '-', positionClass = '';
                if (chartIndex >= 0 && chartIndex < baseline.upper.length) {                    
                    if (item.hrv_value > baseline.upper[chartIndex]) {
                        positionText = '高于基准线';
                        positionClass = 'text-hrv-optimal font-medium';
                    } else if (item.hrv_value < baseline.lower[chartIndex]) {
                        positionText = '低于基准线';
                        positionClass = 'text-hrv-concern font-medium';
                    } else {
                        positionText = '在基准范围内';
                        positionClass = 'text-hrv-normal font-medium';
                    }
                }
                
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 transition-colors';
                
                let statusClass, statusText;
                if (item.hrv_value > 120) {
                    statusClass = 'bg-green-100 text-hrv-optimal';
                    statusText = '最佳';
                } else if (item.hrv_value >= 100) {
                    statusClass = 'bg-teal-100 text-hrv-normal';
                    statusText = '正常';
                } else {
                    statusClass = 'bg-red-100 text-hrv-concern';
                    statusText = '需关注';
                }
                
                row.innerHTML = `
                    <td class="px-4 py-3 whitespace-nowrap">${item.take_time}</td>
                    <td class="px-4 py-3 whitespace-nowrap font-medium">${item.hrv_value}</td>
                    <td class="px-4 py-3 whitespace-nowrap ${positionClass}">${positionText}</td>
                    <td class="px-4 py-3 whitespace-nowrap">
                        <span class="hrv-badge ${statusClass}">${statusText}</span>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }
    </script>
</body>
</html>
    