<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HRV 心率变异性分析报告</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3b82f6',
                        secondary: '#10b981',
                        warning: '#f59e0b',
                        danger: '#ef4444',
                        neutral: '#64748b',
                        'hrv-high': '#10b981',
                        'hrv-medium': '#f59e0b',
                        'hrv-low': '#ef4444',
                        'channel': 'rgba(59, 130, 246, 0.2)',
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .card-shadow {
                box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            }
            .gradient-bg {
                background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            }
            .hrv-badge {
                @apply inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium;
            }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen font-sans">
    <!-- 头部导航 -->
    <header class="bg-white shadow-md sticky top-0 z-50">
        <div class="container mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <i class="fa fa-heartbeat text-primary text-2xl"></i>
                <h1 class="text-xl md:text-2xl font-bold text-gray-800">HRV 分析报告</h1>
            </div>
            <div class="text-sm text-gray-600">
                <span id="last-update">数据更新时间: 2025-10-15 09:56</span>
            </div>
        </div>
    </header>

    <!-- 主要内容区 -->
    <main class="container mx-auto px-4 py-8">
        <!-- 概览卡片 -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <!-- 平均HRV -->
            <div class="bg-white rounded-xl p-6 card-shadow transform transition duration-300 hover:scale-[1.02]">
                <div class="flex justify-between items-start mb-4">
                    <h2 class="text-lg font-semibold text-gray-700">平均 HRV</h2>
                    <span class="bg-blue-100 text-primary p-2 rounded-full">
                        <i class="fa fa-line-chart"></i>
                    </span>
                </div>
                <div class="flex items-baseline">
                    <span id="avg-hrv" class="text-3xl font-bold text-gray-800">114</span>
                    <span class="ml-2 text-gray-500">ms</span>
                </div>
                <p class="mt-2 text-sm text-gray-500">基于 23 条记录的平均值</p>
                <div class="mt-4 h-1 w-full bg-gray-200 rounded-full overflow-hidden">
                    <div id="avg-progress" class="h-full bg-primary rounded-full" style="width: 65%"></div>
                </div>
            </div>

            <!-- 最高HRV -->
            <div class="bg-white rounded-xl p-6 card-shadow transform transition duration-300 hover:scale-[1.02]">
                <div class="flex justify-between items-start mb-4">
                    <h2 class="text-lg font-semibold text-gray-700">最高 HRV</h2>
                    <span class="bg-green-100 text-hrv-high p-2 rounded-full">
                        <i class="fa fa-arrow-up"></i>
                    </span>
                </div>
                <div class="flex items-baseline">
                    <span id="max-hrv" class="text-3xl font-bold text-gray-800">142</span>
                    <span class="ml-2 text-gray-500">ms</span>
                </div>
                <p class="mt-2 text-sm text-gray-500">记录时间: 2025-10-13 18:27</p>
                <span class="hrv-badge bg-green-100 text-hrv-high mt-4">良好状态</span>
            </div>

            <!-- 最低HRV -->
            <div class="bg-white rounded-xl p-6 card-shadow transform transition duration-300 hover:scale-[1.02]">
                <div class="flex justify-between items-start mb-4">
                    <h2 class="text-lg font-semibold text-gray-700">最低 HRV</h2>
                    <span class="bg-yellow-100 text-hrv-medium p-2 rounded-full">
                        <i class="fa fa-arrow-down"></i>
                    </span>
                </div>
                <div class="flex items-baseline">
                    <span id="min-hrv" class="text-3xl font-bold text-gray-800">92</span>
                    <span class="ml-2 text-gray-500">ms</span>
                </div>
                <p class="mt-2 text-sm text-gray-500">记录时间: 2025-10-13 11:18</p>
                <span class="hrv-badge bg-yellow-100 text-hrv-medium mt-4">一般状态</span>
            </div>
        </div>

        <!-- HRV 走势图表（最近14条记录 + 滑动窗口区间甬道） -->
        <div class="bg-white rounded-xl p-6 card-shadow mb-8">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                <h2 class="text-xl font-bold text-gray-800">HRV 走势与滑动窗口区间</h2>
                <div class="flex items-center space-x-4 w-full sm:w-auto">
                    <div class="text-sm text-gray-600">
                        <span>窗口大小:</span>
                        <select id="window-size" class="ml-2 border border-gray-300 rounded px-2 py-1 text-sm">
                            <option value="3">3条记录</option>
                            <option value="5" selected>5条记录</option>
                            <option value="7">7条记录</option>
                            <option value="10">10条记录</option>
                        </select>
                    </div>
                    <div class="text-sm text-gray-600">
                        <span>显示记录数:</span>
                        <select id="record-count" class="ml-2 border border-gray-300 rounded px-2 py-1 text-sm">
                            <option value="7">7条</option>
                            <option value="14" selected>14条</option>
                            <option value="20">20条</option>
                            <option value="all">全部</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="h-[400px]">
                <canvas id="hrv-trend-chart"></canvas>
            </div>
            <div class="mt-6 grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                <div class="flex items-center">
                    <span class="w-3 h-3 bg-primary rounded-full mr-2"></span>
                    <span class="text-gray-600">HRV 数值</span>
                </div>
                <div class="flex items-center">
                    <span class="w-3 h-3 bg-channel rounded-full mr-2"></span>
                    <span class="text-gray-600">滑动区间甬道</span>
                </div>
                <div class="flex items-center">
                    <span class="w-3 h-3 bg-hrv-high rounded-full mr-2"></span>
                    <span class="text-gray-600">良好区间 (>120ms)</span>
                </div>
                <div class="flex items-center">
                    <span class="w-3 h-3 bg-hrv-low rounded-full mr-2"></span>
                    <span class="text-gray-600">需关注区间 (<100ms)</span>
                </div>
            </div>
        </div>

        <!-- HRV 区间分布 -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            <!-- 区间分布饼图 -->
            <div class="bg-white rounded-xl p-6 card-shadow">
                <h2 class="text-xl font-bold text-gray-800 mb-6">HRV 区间分布</h2>
                <div class="h-[300px] flex items-center justify-center">
                    <canvas id="hrv-distribution-chart"></canvas>
                </div>
                <div class="mt-6 grid grid-cols-3 gap-2 text-center text-sm">
                    <div>
                        <p class="text-hrv-high font-medium">良好</p>
                        <p id="good-count" class="text-gray-700">8 条 (35%)</p>
                    </div>
                    <div>
                        <p class="text-hrv-medium font-medium">一般</p>
                        <p id="normal-count" class="text-gray-700">10 条 (43%)</p>
                    </div>
                    <div>
                        <p class="text-hrv-low font-medium">需关注</p>
                        <p id="poor-count" class="text-gray-700">5 条 (22%)</p>
                    </div>
                </div>
            </div>

            <!-- 滑动窗口参数说明 -->
            <div class="bg-white rounded-xl p-6 card-shadow">
                <h2 class="text-xl font-bold text-gray-800 mb-6">滑动窗口区间说明</h2>
                <div class="space-y-4">
                    <div class="flex items-start">
                        <div class="flex-shrink-0 h-6 w-6 rounded-full bg-blue-100 flex items-center justify-center mt-0.5">
                            <i class="fa fa-info text-primary text-xs"></i>
                        </div>
                        <div class="ml-3">
                            <h3 class="text-sm font-medium text-gray-900">滑动窗口计算方式</h3>
                            <div class="mt-1 text-sm text-gray-600">
                                <p>每个数据点的区间甬道基于当前点及之前的N条记录（窗口大小）计算得出，上边界为窗口内平均值+标准差，下边界为窗口内平均值-标准差。</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex items-start">
                        <div class="flex-shrink-0 h-6 w-6 rounded-full bg-blue-100 flex items-center justify-center mt-0.5">
                            <i class="fa fa-check text-primary text-xs"></i>
                        </div>
                        <div class="ml-3">
                            <h3 class="text-sm font-medium text-gray-900">区间意义</h3>
                            <div class="mt-1 text-sm text-gray-600">
                                <p>甬道宽度反映近期数据波动性，窗口滑动时，甬道会根据最新数据动态调整，展示当前数据相对于近期趋势的位置。</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex items-start">
                        <div class="flex-shrink-0 h-6 w-6 rounded-full bg-blue-100 flex items-center justify-center mt-0.5">
                            <i class="fa fa-lightbulb-o text-primary text-xs"></i>
                        </div>
                        <div class="ml-3">
                            <h3 class="text-sm font-medium text-gray-900">走势解读</h3>
                            <div class="mt-1 text-sm text-gray-600">
                                <p>当HRV值持续高于上边界，可能表示身体状态改善；持续低于下边界，则可能需要关注身体恢复情况。</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 原始数据表格 -->
        <div class="bg-white rounded-xl p-6 card-shadow">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-gray-800">数据记录</h2>
                <button id="export-btn" class="px-4 py-2 bg-primary text-white rounded-md text-sm flex items-center">
                    <i class="fa fa-download mr-2"></i>导出全部数据
                </button>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead>
                        <tr>
                            <th class="px-4 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">记录时间</th>
                            <th class="px-4 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">HRV 数值 (ms)</th>
                            <th class="px-4 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">状态</th>
                            <th class="px-4 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">窗口区间 (ms)</th>
                        </tr>
                    </thead>
                    <tbody id="data-table-body" class="bg-white divide-y divide-gray-200">
                        <!-- 数据将通过JS动态填充 -->
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <!-- 页脚 -->
    <footer class="bg-gray-800 text-white py-8 mt-12">
        <div class="container mx-auto px-4">
            <div class="flex flex-col md:flex-row justify-between items-center">
                <div class="mb-4 md:mb-0">
                    <h3 class="text-lg font-bold flex items-center">
                        <i class="fa fa-heartbeat text-primary mr-2"></i>HRV 分析报告
                    </h3>
                    <p class="text-gray-400 text-sm mt-1">健康数据可视化工具</p>
                </div>
                <div class="text-gray-400 text-sm">
                    <p>© 2025 HRV 分析工具 | 数据仅供参考，不构成医疗建议</p>
                    <p class="mt-1">如有健康问题，请咨询专业医疗人员</p>
                </div>
            </div>
        </div>
    </footer>

    <script>
        // HRV 原始数据
        const hrvData = [
            { "hrv_value": 108, "take_time": "2025-10-15 09:56:18" },
            { "hrv_value": 141, "take_time": "2025-10-14 20:32:30" },
            { "hrv_value": 129, "take_time": "2025-10-14 20:31:42" },
            { "hrv_value": 112, "take_time": "2025-10-14 17:25:31" },
            { "hrv_value": 110, "take_time": "2025-10-14 14:53:31" },
            { "hrv_value": 109, "take_time": "2025-10-14 09:00:39" },
            { "hrv_value": 116, "take_time": "2025-10-14 05:19:57" },
            { "hrv_value": 117, "take_time": "2025-10-13 19:56:28" },
            { "hrv_value": 142, "take_time": "2025-10-13 18:27:42" },
            { "hrv_value": 96, "take_time": "2025-10-13 15:02:41" },
            { "hrv_value": 92, "take_time": "2025-10-13 11:18:52" },
            { "hrv_value": 110, "take_time": "2025-10-12 22:15:59" },
            { "hrv_value": 116, "take_time": "2025-10-12 15:54:02" },
            { "hrv_value": 119, "take_time": "2025-10-12 13:53:44" },
            { "hrv_value": 121, "take_time": "2025-10-12 13:51:50" },
            { "hrv_value": 117, "take_time": "2025-10-12 13:43:16" },
            { "hrv_value": 107, "take_time": "2025-10-12 12:52:20" },
            { "hrv_value": 121, "take_time": "2025-10-11 23:07:01" },
            { "hrv_value": 113, "take_time": "2025-10-10 21:51:11" },
            { "hrv_value": 95, "take_time": "2025-10-09 17:29:53" },
            { "hrv_value": 115, "take_time": "2025-10-07 23:27:33" },
            { "hrv_value": 95, "take_time": "2025-10-06 22:04:58" },
            { "hrv_value": 129, "take_time": "2025-10-06 16:15:41" }
        ];

        // 全局变量存储当前图表和参数
        let trendChart = null;
        let distributionChart = null;
        let currentWindowSize = 5;
        let currentRecordCount = 14;

        // 数据处理函数
        document.addEventListener('DOMContentLoaded', function() {
            // 排序数据（最新的在前）
            const sortedData = [...hrvData].sort((a, b) => new Date(b.take_time) - new Date(a.take_time));
            
            // 计算统计数据
            const values = sortedData.map(item => item.hrv_value);
            const avgHrv = Math.round(values.reduce((sum, val) => sum + val, 0) / values.length);
            const maxHrv = Math.max(...values);
            const minHrv = Math.min(...values);
            
            // 分类统计
            const goodCount = values.filter(v => v > 120).length;
            const normalCount = values.filter(v => v >= 100 && v <= 120).length;
            const poorCount = values.filter(v => v < 100).length;
            
            // 更新概览数据
            document.getElementById('avg-hrv').textContent = avgHrv;
            document.getElementById('max-hrv').textContent = maxHrv;
            document.getElementById('min-hrv').textContent = minHrv;
            document.getElementById('good-count').textContent = `${goodCount} 条 (${Math.round(goodCount/values.length*100)}%)`;
            document.getElementById('normal-count').textContent = `${normalCount} 条 (${Math.round(normalCount/values.length*100)}%)`;
            document.getElementById('poor-count').textContent = `${poorCount} 条 (${Math.round(poorCount/values.length*100)}%)`;
            
            // 设置平均HRV进度条（基于0-200的范围）
            const avgProgress = Math.min(100, Math.max(0, (avgHrv / 200) * 100));
            document.getElementById('avg-progress').style.width = `${avgProgress}%`;
            
            // 初始化图表和表格
            updateChartsAndTable(sortedData);
            
            // 窗口大小选择事件
            document.getElementById('window-size').addEventListener('change', function() {
                currentWindowSize = parseInt(this.value);
                updateChartsAndTable(sortedData);
            });
            
            // 记录数选择事件
            document.getElementById('record-count').addEventListener('change', function() {
                currentRecordCount = this.value === 'all' ? sortedData.length : parseInt(this.value);
                updateChartsAndTable(sortedData);
            });
            
            // 导出数据按钮
            document.getElementById('export-btn').addEventListener('click', function() {
                const csvContent = "data:text/csv;charset=utf-8," 
                    + "记录时间,HRV数值(ms)\n" 
                    + sortedData.map(item => `${item.take_time},${item.hrv_value}`).join("\n");
                
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", `HRV数据_${new Date().toLocaleDateString()}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            });
        });

        // 更新图表和表格
        function updateChartsAndTable(allData) {
            // 获取要显示的记录
            const displayData = allData.slice(0, currentRecordCount);
            
            // 计算滑动窗口区间甬道
            const channels = calculateSlidingWindowChannels(displayData, currentWindowSize);
            
            // 初始化HRV走势图表
            initTrendChart(displayData, channels);
            
            // 初始化区间分布图表（使用所有数据）
            const allValues = allData.map(item => item.hrv_value);
            const goodCount = allValues.filter(v => v > 120).length;
            const normalCount = allValues.filter(v => v >= 100 && v <= 120).length;
            const poorCount = allValues.filter(v => v < 100).length;
            initDistributionChart(goodCount, normalCount, poorCount);
            
            // 填充表格数据
            fillTableData(displayData, channels);
        }

        // 计算滑动窗口区间甬道数据
        function calculateSlidingWindowChannels(data, windowSize) {
            // 按时间顺序排列（ oldest first）
            const timeOrderedData = [...data].sort((a, b) => new Date(a.take_time) - new Date(b.take_time));
            
            const channels = {
                upper: [],
                lower: []
            };
            
            // 遍历每条数据
            timeOrderedData.forEach((item, index) => {
                // 确定窗口起点（不小于0）
                const startIndex = Math.max(0, index - windowSize + 1);
                // 获取窗口内的数据（从起点到当前点）
                const windowItems = timeOrderedData.slice(startIndex, index + 1);
                const windowValues = windowItems.map(i => i.hrv_value);
                
                // 计算窗口数据的平均值和标准差
                const mean = windowValues.reduce((sum, val) => sum + val, 0) / windowValues.length;
                
                // 计算标准差
                const variance = windowValues.reduce((sum, val) => sum + Math.pow(val - mean, 2), 0) / windowValues.length;
                const stdDev = Math.sqrt(variance);
                
                // 上边界 = 平均值 + 标准差
                // 下边界 = 平均值 - 标准差
                channels.upper.push(mean + stdDev);
                channels.lower.push(mean - stdDev);
            });
            
            return channels;
        }

        // 初始化HRV走势图表（带滑动窗口区间甬道）
        function initTrendChart(displayData, channels) {
            const ctx = document.getElementById('hrv-trend-chart').getContext('2d');
            
            // 按时间顺序排列（ oldest first）
            const timeOrderedData = [...displayData].sort((a, b) => new Date(a.take_time) - new Date(b.take_time));
            
            const labels = timeOrderedData.map(item => {
                const date = new Date(item.take_time);
                return `${date.getMonth()+1}/${date.getDate()} ${date.getHours()}:${String(date.getMinutes()).padStart(2, '0')}`;
            });
            
            const values = timeOrderedData.map(item => item.hrv_value);
            
            // 销毁已存在的图表
            if (trendChart) {
                trendChart.destroy();
            }
            
            // 创建新图表
            trendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'HRV 数值',
                            data: values,
                            borderColor: '#3b82f6',
                            backgroundColor: '#3b82f6',
                            borderWidth: 2,
                            tension: 0.3,
                            fill: false,
                            pointBackgroundColor: '#3b82f6',
                            pointRadius: 5,
                            pointHoverRadius: 7,
                            pointHoverBackgroundColor: '#ffffff',
                            pointHoverBorderColor: '#3b82f6',
                            pointHoverBorderWidth: 2
                        },
                        {
                            label: '上边界',
                            data: channels.upper,
                            borderColor: 'rgba(59, 130, 246, 0.3)',
                            borderWidth: 1,
                            borderDash: [3, 3],
                            fill: false,
                            pointRadius: 0,
                            tension: 0.4
                        },
                        {
                            label: '下边界',
                            data: channels.lower,
                            borderColor: 'rgba(59, 130, 246, 0.3)',
                            borderWidth: 1,
                            borderDash: [3, 3],
                            fill: true,
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            pointRadius: 0,
                            tension: 0.4
                        },
                        {
                            label: '良好区间',
                            data: values.map(() => 120),
                            borderColor: '#10b981',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            fill: false,
                            pointRadius: 0,
                            tension: 0
                        },
                        {
                            label: '需关注区间',
                            data: values.map(() => 100),
                            borderColor: '#ef4444',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            fill: false,
                            pointRadius: 0,
                            tension: 0
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        tooltip: {
                            backgroundColor: 'rgba(255, 255, 255, 0.9)',
                            titleColor: '#333',
                            bodyColor: '#666',
                            borderColor: '#ddd',
                            borderWidth: 1,
                            padding: 10,
                            boxPadding: 5,
                            usePointStyle: true,
                            callbacks: {
                                label: function(context) {
                                    if (context.datasetIndex === 0) {
                                        return `HRV: ${context.raw} ms`;
                                    } else if (context.datasetIndex === 1) {
                                        return `区间上限: ${context.raw.toFixed(1)} ms`;
                                    } else if (context.datasetIndex === 2) {
                                        return `区间下限: ${context.raw.toFixed(1)} ms`;
                                    } else if (context.datasetIndex === 3) {
                                        return '良好区间阈值: 120 ms';
                                    } else {
                                        return '需关注区间阈值: 100 ms';
                                    }
                                }
                            }
                        },
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45,
                                font: {
                                    size: 10
                                }
                            }
                        },
                        y: {
                            beginAtZero: false,
                            min: Math.min(...channels.lower, 80) - 10,
                            max: Math.max(...channels.upper, 150) + 10,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            },
                            ticks: {
                                stepSize: 20,
                                callback: function(value) {
                                    return value + ' ms';
                                }
                            }
                        }
                    },
                    animation: {
                        duration: 1000,
                        easing: 'easeOutQuart'
                    }
                }
            });
        }

        // 初始化区间分布图表
        function initDistributionChart(good, normal, poor) {
            const ctx = document.getElementById('hrv-distribution-chart').getContext('2d');
            
            // 销毁已存在的图表
            if (distributionChart) {
                distributionChart.destroy();
            }
            
            // 创建新图表
            distributionChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['良好 (>120ms)', '一般 (100-120ms)', '需关注 (<100ms)'],
                    datasets: [{
                        data: [good, normal, poor],
                        backgroundColor: [
                            '#10b981',
                            '#f59e0b',
                            '#ef4444'
                        ],
                        borderColor: '#ffffff',
                        borderWidth: 3,
                        hoverOffset: 10
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '65%',
                    plugins: {
                        tooltip: {
                            backgroundColor: 'rgba(255, 255, 255, 0.9)',
                            titleColor: '#333',
                            bodyColor: '#666',
                            borderColor: '#ddd',
                            borderWidth: 1,
                            padding: 10,
                            boxPadding: 5,
                            callbacks: {
                                label: function(context) {
                                    const value = context.raw;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = Math.round((value / total) * 100);
                                    return `${context.label}: ${value} 条 (${percentage}%)`;
                                }
                            }
                        },
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                usePointStyle: true,
                                pointStyle: 'circle'
                            }
                        }
                    },
                    animation: {
                        animateRotate: true,
                        animateScale: true,
                        duration: 1000,
                        easing: 'easeOutQuart'
                    }
                }
            });
        }

        // 填充表格数据
        function fillTableData(displayData, channels) {
            const tableBody = document.getElementById('data-table-body');
            tableBody.innerHTML = ''; // 清空表格
            
            // 按时间顺序排列（最新的在前）
            const sortedData = [...displayData].sort((a, b) => new Date(b.take_time) - new Date(a.take_time));
            // 按时间顺序排列（ oldest first）用于匹配channels索引
            const timeOrderedData = [...displayData].sort((a, b) => new Date(a.take_time) - new Date(b.take_time));
            
            sortedData.forEach(item => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 transition-colors';
                
                // 确定状态
                let statusClass, statusText;
                if (item.hrv_value > 120) {
                    statusClass = 'bg-green-100 text-hrv-high';
                    statusText = '良好';
                } else if (item.hrv_value >= 100) {
                    statusClass = 'bg-yellow-100 text-hrv-medium';
                    statusText = '一般';
                } else {
                    statusClass = 'bg-red-100 text-hrv-low';
                    statusText = '需关注';
                }
                
                // 找到在时间排序数据中的索引以匹配channels
                const indexInTimeOrder = timeOrderedData.findIndex(
                    t => t.take_time === item.take_time && t.hrv_value === item.hrv_value
                );
                
                // 获取窗口区间值
                const lower = indexInTimeOrder >= 0 ? channels.lower[indexInTimeOrder].toFixed(1) : '-';
                const upper = indexInTimeOrder >= 0 ? channels.upper[indexInTimeOrder].toFixed(1) : '-';
                
                row.innerHTML = `
                    <td class="px-4 py-3 whitespace-nowrap">${item.take_time}</td>
                    <td class="px-4 py-3 whitespace-nowrap font-medium">${item.hrv_value}</td>
                    <td class="px-4 py-3 whitespace-nowrap">
                        <span class="hrv-badge ${statusClass}">${statusText}</span>
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap text-gray-600">
                        ${lower} - ${upper}
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }
    </script>
</body>
</html>
    